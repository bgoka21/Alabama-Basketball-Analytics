{% extends 'admin/base.html' %}
{% from 'macros/dual_tables.html' import render_dual_section %}

{% block page_controls %}
  <form method="get" class="mb-4 flex flex-wrap items-end gap-4">
    <div>
      <label class="font-semibold mr-2">Season:</label>
      <select name="season_id" class="border p-2 rounded">
        {% for s in all_seasons %}
          <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>
            {{ s.season_name }}
          </option>
        {% endfor %}
      </select>
    </div>
    {% for lbl in selected_labels %}
      <input type="hidden" name="label" value="{{ lbl }}">
    {% endfor %}
    {% if scope %}
      <input type="hidden" name="scope" value="{{ scope }}">
    {% endif %}
    {% if selected_session and selected_session != 'All' %}
      <input type="hidden" name="session" value="{{ selected_session }}">
    {% endif %}
    <button type="submit" class="bg-[#9E1B32] hover:bg-[#7f1524] text-white px-5 py-2 rounded">Apply</button>
  </form>
{% endblock %}

{% block content %}
  {% include "_practice_scope_tabs.html" %}
  {% set scope_label_map = {'last': 'Last Practice', 'session': 'Session Totals', 'season': 'Season Totals'} %}
  {% set scope_label_text = scope_label_map.get(scope, 'Season Totals') %}
  {% set season_by = season_rows_by_subtype or {} %}
  {% set last_by = last_rows_by_subtype or {} %}
  <div class="space-y-6">
    <div class="bg-white p-6 rounded shadow space-y-6">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">{{ page_title }}</h1>
        <p class="text-sm text-gray-600">
          {% if scope == 'last' and scope_start %}
            Showing {{ scope_label_text }} ({{ scope_start.strftime('%b %d, %Y') }})
          {% elif scope == 'session' and scope_start and scope_end %}
            Showing {{ scope_label_text }} ({{ scope_start.strftime('%b %d, %Y') }} â€“ {{ scope_end.strftime('%b %d, %Y') }})
          {% else %}
            Showing {{ scope_label_text }}
          {% endif %}
        </p>
        {% if not scope_has_data %}
          <p class="text-sm text-gray-500">No practice data for this scope.</p>
        {% endif %}
        {% if last_practice_date %}
          <span class="hidden">Last practice: {{ last_practice_date.strftime('%b %d, %Y') }}</span>
        {% endif %}
      </div>

      {% set practice_note = last_practice_date.strftime('%b %d, %Y') if last_practice_date else None %}

      {% set close_columns = ["Close Window +", "Close Window Att", "Close Window %"] %}
      {% set close_map = {
        "Close Window +": ("plus", "close_window_plus", "cw_plus"),
        "Close Window Att": ("opps", "close_window_opp", "cw_opp"),
        "Close Window %": ("pct", "close_window_pct", "cw_pct"),
      } %}
      {% set close_pct_columns = ["Close Window %"] %}
      {% set season_close_rows = (season_by.get('close_window') or [])|format_dual_rows(close_columns, close_map, close_pct_columns) %}
      {% set last_close_rows = (last_by.get('close_window') or [])|format_dual_rows(close_columns, close_map, close_pct_columns) %}
      {% set season_close_totals = (season_team_totals.get('close_window') if season_team_totals else None)|format_dual_totals(close_columns, close_map, close_pct_columns) %}
      {% set last_close_totals = (last_team_totals.get('close_window') if last_team_totals else None)|format_dual_totals(close_columns, close_map, close_pct_columns) %}

      {{ render_dual_section(
        "Close Window",
        season_rows=season_close_rows,
        season_totals=season_close_totals,
        last_rows=last_close_rows,
        last_totals=last_close_totals,
        columns=close_columns,
        note_date=practice_note
      ) }}

      {% set shut_columns = ["Shut Door +", "Shut Door Att", "Shut Door %"] %}
      {% set shut_map = {
        "Shut Door +": ("plus", "shut_door_plus", "sd_plus"),
        "Shut Door Att": ("opps", "shut_door_opp", "sd_opp"),
        "Shut Door %": ("pct", "shut_door_pct", "sd_pct"),
      } %}
      {% set shut_pct_columns = ["Shut Door %"] %}
      {% set season_shut_rows = (season_by.get('shut_door') or [])|format_dual_rows(shut_columns, shut_map, shut_pct_columns) %}
      {% set last_shut_rows = (last_by.get('shut_door') or [])|format_dual_rows(shut_columns, shut_map, shut_pct_columns) %}
      {% set season_shut_totals = (season_team_totals.get('shut_door') if season_team_totals else None)|format_dual_totals(shut_columns, shut_map, shut_pct_columns) %}
      {% set last_shut_totals = (last_team_totals.get('shut_door') if last_team_totals else None)|format_dual_totals(shut_columns, shut_map, shut_pct_columns) %}

      {{ render_dual_section(
        "Shut Door",
        season_rows=season_shut_rows,
        season_totals=season_shut_totals,
        last_rows=last_shut_rows,
        last_totals=last_shut_totals,
        columns=shut_columns,
        note_date=practice_note
      ) }}
    </div>
  </div>
{% endblock %}
