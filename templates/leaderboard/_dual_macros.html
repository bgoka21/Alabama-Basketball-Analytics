{% macro pct_display(value) -%}
  {%- if value is none -%}
    NA
  {%- elif value is string -%}
    {%- if value.endswith('%') -%}
      {{ value }}
    {%- else -%}
      {{ '%.1f%%'|format(value|float) }}
    {%- endif -%}
  {%- else -%}
    {{ '%.1f%%'|format(value|float) }}
  {%- endif -%}
{%- endmacro %}

{% macro _render_ratio_table(rows, totals, plus_label, opps_label, pct_label, extra_columns=[]) -%}
  {%- set rows = rows or [] -%}
  {%- set totals = totals or None -%}
  {%- if not rows and not totals -%}
    <p class="text-sm text-gray-500">No data available.</p>
  {%- else -%}
    <div class="bg-white shadow rounded-lg border border-gray-200">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-100 border-b-4 border-[#9E1B32]">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">#</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">Player</th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">{{ plus_label }}</th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">{{ opps_label }}</th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">{{ pct_label }}</th>
              {%- for col in extra_columns -%}
                <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">{{ col.label }}</th>
              {%- endfor -%}
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {%- for row in rows -%}
              <tr class="even:bg-gray-50" data-plus="{{ row.plus }}" data-opps="{{ row.opps }}" data-pct="{{ row.pct if row.pct is not none else '' }}">
                <td class="px-4 py-3 text-sm text-gray-600">{{ loop.index }}</td>
                <td class="px-4 py-3 text-sm text-gray-900">{{ row.player_name }}</td>
                <td class="px-4 py-3 text-sm text-right">{{ row.plus }}</td>
                <td class="px-4 py-3 text-sm text-right">{{ row.opps }}</td>
                <td class="px-4 py-3 text-sm text-right">{{ pct_display(row.pct) }}</td>
              {%- for col in extra_columns -%}
                {%- set value = row[col.key] if col.key in row else None -%}
                <td class="px-4 py-3 text-sm text-right">
                  {%- if value is none -%}
                    —
                  {%- else -%}
                    {{ value }}
                  {%- endif -%}
                </td>
              {%- endfor -%}
            </tr>
          {%- endfor -%}
          {%- if totals -%}
            <tr class="bg-gray-100 font-semibold" data-plus="{{ totals.plus }}" data-opps="{{ totals.opps }}" data-pct="{{ totals.pct if totals.pct is not none else '' }}">
              <td class="px-4 py-3"></td>
              <td class="px-4 py-3 text-gray-900">Team Totals</td>
              <td class="px-4 py-3 text-right">{{ totals.plus }}</td>
              <td class="px-4 py-3 text-right">{{ totals.opps }}</td>
              <td class="px-4 py-3 text-right">{{ pct_display(totals.pct) }}</td>
              {%- for col in extra_columns -%}
                {%- set total_val = totals[col.key] if col.key in totals else None -%}
                <td class="px-4 py-3 text-right">
                  {%- if total_val is none -%}
                    —
                  {%- else -%}
                    {{ total_val }}
                  {%- endif -%}
                </td>
              {%- endfor -%}
            </tr>
          {%- endif -%}
          </tbody>
        </table>
      </div>
    </div>
  {%- endif -%}
{%- endmacro %}

{% macro render_dual_section(title, season_rows, season_totals, last_rows, last_totals, plus_label='+', opps_label='Opps', pct_label='%', extra_columns=None, scope=None) -%}
  {%- set extra_columns = extra_columns or [] -%}
  {% set season_active = scope in ['season', 'session'] %}
  {% set last_active = scope == 'last' %}
  {% if scope == 'session' %}
    {% set left_label = 'Session Totals' %}
  {% elif scope == 'season' %}
    {% set left_label = 'Season Totals' %}
  {% else %}
    {% set left_label = 'Season to Date' %}
  {% endif %}
  <section class="space-y-3">
    <h2 class="text-xl font-semibold text-gray-900">{{ title }}</h2>
    <div class="grid gap-6 lg:grid-cols-2">
      <div class="space-y-2 {% if season_active %}ring-2 ring-[#9E1B32] rounded{% endif %}">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">{{ left_label }}</h3>
        {{ _render_ratio_table(season_rows, season_totals, plus_label, opps_label, pct_label, extra_columns) }}
      </div>
      <div class="space-y-2 {% if last_active %}ring-2 ring-[#9E1B32] rounded{% endif %}">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">Last Practice</h3>
        {{ _render_ratio_table(last_rows, last_totals, plus_label, opps_label, pct_label, extra_columns) }}
      </div>
    </div>
  </section>
{%- endmacro %}
