{% extends 'admin/base.html' %}
{% from 'macros/dual_tables.html' import render_dual_section %}

{% block page_controls %}
  <form method="get" class="mb-4 flex flex-wrap items-end gap-4">
    <div>
      <label class="font-semibold mr-2">Season:</label>
      <select name="season_id" class="border p-2 rounded">
        {% for s in all_seasons %}
          <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>
            {{ s.season_name }}
          </option>
        {% endfor %}
      </select>
    </div>
    {% for lbl in selected_labels %}
      <input type="hidden" name="label" value="{{ lbl }}">
    {% endfor %}
    {% if scope %}
      <input type="hidden" name="scope" value="{{ scope }}">
    {% endif %}
    {% if selected_session and selected_session != 'All' %}
      <input type="hidden" name="session" value="{{ selected_session }}">
    {% endif %}
    <button type="submit" class="bg-[#9E1B32] hover:bg-[#7f1524] text-white px-5 py-2 rounded">Apply</button>
  </form>
{% endblock %}

{% block content %}
  {% include "_practice_scope_tabs.html" %}
  {% set scope_label_map = {'last': 'Last Practice', 'session': 'Session Totals', 'season': 'Season Totals'} %}
  {% set scope_label_text = scope_label_map.get(scope, 'Season Totals') %}
  <div class="space-y-6">
    <div class="bg-white p-6 rounded shadow space-y-6">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">{{ page_title }}</h1>
        <p class="text-sm text-gray-600">
          {% if scope == 'last' and scope_start %}
            Showing {{ scope_label_text }} ({{ scope_start.strftime('%b %d, %Y') }})
          {% elif scope == 'session' and scope_start and scope_end %}
            Showing {{ scope_label_text }} ({{ scope_start.strftime('%b %d, %Y') }} â€“ {{ scope_end.strftime('%b %d, %Y') }})
          {% else %}
            Showing {{ scope_label_text }}
          {% endif %}
        </p>
        {% if not scope_has_data %}
          <p class="text-sm text-gray-500">No practice data for this scope.</p>
        {% endif %}
        {% if last_practice_date %}
          <span class="hidden">Last practice: {{ last_practice_date.strftime('%b %d, %Y') }}</span>
        {% endif %}
      </div>

      {% set practice_note = last_practice_date.strftime('%b %d, %Y') if last_practice_date else None %}
      {% set columns = [
        "Crash +", "Crash Att", "Crash %",
        "Back Man +", "Back Man Att", "Back Man %",
        "Box Out +", "Box Out Att", "Box Out %"
      ] %}
      {% set season_by = season_rows_by_subtype or {} %}
      {% set last_by = last_rows_by_subtype or {} %}

      {% set season_ns = namespace(rows={}) %}
      {% for row in season_by.get('crash') or [] %}
        {% set player = row.get('player') or row.get('player_name') or row.get('name') %}
        {% if player %}
          {% set jersey = row.get('jersey') or row.get('jersey_number') or loop.index %}
          {% set entry = season_ns.rows.setdefault(player, {'player': player, 'jersey': jersey}) %}
          {% set _ = entry.update({'Crash +': row.get('plus'), 'Crash Att': row.get('opps'), 'Crash %': row.get('pct')}) %}
        {% endif %}
      {% endfor %}
      {% for row in season_by.get('back_man') or [] %}
        {% set player = row.get('player') or row.get('player_name') or row.get('name') %}
        {% if player %}
          {% set jersey = row.get('jersey') or row.get('jersey_number') or loop.index %}
          {% set entry = season_ns.rows.setdefault(player, {'player': player, 'jersey': jersey}) %}
          {% set _ = entry.update({'Back Man +': row.get('plus'), 'Back Man Att': row.get('opps'), 'Back Man %': row.get('pct')}) %}
        {% endif %}
      {% endfor %}
      {% for row in season_by.get('box_out') or [] %}
        {% set player = row.get('player') or row.get('player_name') or row.get('name') %}
        {% if player %}
          {% set jersey = row.get('jersey') or row.get('jersey_number') or loop.index %}
          {% set entry = season_ns.rows.setdefault(player, {'player': player, 'jersey': jersey}) %}
          {% set _ = entry.update({'Box Out +': row.get('plus'), 'Box Out Att': row.get('opps'), 'Box Out %': row.get('pct')}) %}
        {% endif %}
      {% endfor %}

      {% set last_ns = namespace(rows={}) %}
      {% for row in last_by.get('crash') or [] %}
        {% set player = row.get('player') or row.get('player_name') or row.get('name') %}
        {% if player %}
          {% set jersey = row.get('jersey') or row.get('jersey_number') or loop.index %}
          {% set entry = last_ns.rows.setdefault(player, {'player': player, 'jersey': jersey}) %}
          {% set _ = entry.update({'Crash +': row.get('plus'), 'Crash Att': row.get('opps'), 'Crash %': row.get('pct')}) %}
        {% endif %}
      {% endfor %}
      {% for row in last_by.get('back_man') or [] %}
        {% set player = row.get('player') or row.get('player_name') or row.get('name') %}
        {% if player %}
          {% set jersey = row.get('jersey') or row.get('jersey_number') or loop.index %}
          {% set entry = last_ns.rows.setdefault(player, {'player': player, 'jersey': jersey}) %}
          {% set _ = entry.update({'Back Man +': row.get('plus'), 'Back Man Att': row.get('opps'), 'Back Man %': row.get('pct')}) %}
        {% endif %}
      {% endfor %}
      {% for row in last_by.get('box_out') or [] %}
        {% set player = row.get('player') or row.get('player_name') or row.get('name') %}
        {% if player %}
          {% set jersey = row.get('jersey') or row.get('jersey_number') or loop.index %}
          {% set entry = last_ns.rows.setdefault(player, {'player': player, 'jersey': jersey}) %}
          {% set _ = entry.update({'Box Out +': row.get('plus'), 'Box Out Att': row.get('opps'), 'Box Out %': row.get('pct')}) %}
        {% endif %}
      {% endfor %}

      {% set season_table_rows = season_ns.rows.values() | list | sort(attribute='jersey') %}
      {% set last_table_rows = last_ns.rows.values() | list | sort(attribute='jersey') %}

      {% set totals_ns = namespace(data={}) %}
      {% set season_totals_map = season_team_totals or {} %}
      {% if season_totals_map.get('crash') %}
        {% set crash_totals = season_totals_map.get('crash') %}
        {% set _ = totals_ns.data.update({'Crash +': crash_totals.get('plus'), 'Crash Att': crash_totals.get('opps'), 'Crash %': crash_totals.get('pct')}) %}
      {% endif %}
      {% if season_totals_map.get('back_man') %}
        {% set back_totals = season_totals_map.get('back_man') %}
        {% set _ = totals_ns.data.update({'Back Man +': back_totals.get('plus'), 'Back Man Att': back_totals.get('opps'), 'Back Man %': back_totals.get('pct')}) %}
      {% endif %}
      {% if season_totals_map.get('box_out') %}
        {% set box_totals = season_totals_map.get('box_out') %}
        {% set _ = totals_ns.data.update({'Box Out +': box_totals.get('plus'), 'Box Out Att': box_totals.get('opps'), 'Box Out %': box_totals.get('pct')}) %}
      {% endif %}
      {% set season_totals_combined = totals_ns.data if totals_ns.data else None %}

      {% set last_totals_ns = namespace(data={}) %}
      {% set last_totals_map = last_team_totals or {} %}
      {% if last_totals_map.get('crash') %}
        {% set crash_last_totals = last_totals_map.get('crash') %}
        {% set _ = last_totals_ns.data.update({'Crash +': crash_last_totals.get('plus'), 'Crash Att': crash_last_totals.get('opps'), 'Crash %': crash_last_totals.get('pct')}) %}
      {% endif %}
      {% if last_totals_map.get('back_man') %}
        {% set back_last_totals = last_totals_map.get('back_man') %}
        {% set _ = last_totals_ns.data.update({'Back Man +': back_last_totals.get('plus'), 'Back Man Att': back_last_totals.get('opps'), 'Back Man %': back_last_totals.get('pct')}) %}
      {% endif %}
      {% if last_totals_map.get('box_out') %}
        {% set box_last_totals = last_totals_map.get('box_out') %}
        {% set _ = last_totals_ns.data.update({'Box Out +': box_last_totals.get('plus'), 'Box Out Att': box_last_totals.get('opps'), 'Box Out %': box_last_totals.get('pct')}) %}
      {% endif %}
      {% set last_totals_combined = last_totals_ns.data if last_totals_ns.data else None %}

      {% set column_map = {
        "Crash +": ("Crash +", "crash_plus"),
        "Crash Att": ("Crash Att", "crash_att"),
        "Crash %": ("Crash %", "crash_pct"),
        "Back Man +": ("Back Man +", "back_man_plus"),
        "Back Man Att": ("Back Man Att", "back_man_att"),
        "Back Man %": ("Back Man %", "back_man_pct"),
        "Box Out +": ("Box Out +", "box_out_plus"),
        "Box Out Att": ("Box Out Att", "box_out_att"),
        "Box Out %": ("Box Out %", "box_out_pct"),
      } %}
      {% set pct_columns = ["Crash %", "Back Man %", "Box Out %"] %}

      {% set table = build_dual_table(
        base_columns=columns,
        season_rows=season_table_rows,
        last_rows=last_table_rows,
        season_totals=season_totals_combined,
        last_totals=last_totals_combined,
        column_map=column_map,
        pct_columns=pct_columns,
        left_label=scope_label_text,
        right_label='Last Practice',
        totals_label='Team Totals',
        table_id='offensive-rebounding',
        default_sort=['Crash %', 'Crash Att', 'Crash +', 'player']
      ) %}

      {{ render_dual_section(
        "Offensive Rebounding",
        table,
        practice_note
      ) }}
    </div>
  </div>
{% endblock %}
