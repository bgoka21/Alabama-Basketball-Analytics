{% extends "base.html" %}

{% block title %}Synergy Stats Dashboard{% endblock %}

{% block content %}
<div class="synergy-page">
    <section class="synergy-hero">
        <div class="synergy-hero-content">
            <h1 class="synergy-hero-title">
                <i class="fas fa-chart-bar"></i> Synergy Sports Analytics
            </h1>
            <p class="synergy-hero-subtitle">
                Advanced analytics powered by Synergy Sports Technology
            </p>
        </div>
        <div class="synergy-hero-status">
            {% if cache_info.exists %}
                {% if cache_info.is_stale %}
                    <span class="synergy-status-label synergy-status-stale">
                        <i class="fas fa-exclamation-triangle"></i> Stale data
                    </span>
                    <span class="synergy-status-text">Last updated {{ cache_info.age_hours|round(1) }} hours ago.</span>
                {% else %}
                    <span class="synergy-status-label synergy-status-current">
                        <i class="fas fa-check-circle"></i> Current data
                    </span>
                    <span class="synergy-status-text">Last updated {{ cache_info.age_hours|round(1) }} hours ago.</span>
                {% endif %}
            {% else %}
                <span class="synergy-status-label synergy-status-empty">
                    <i class="fas fa-info-circle"></i> No cache yet
                </span>
                <span class="synergy-status-text">Fetch to begin tracking Synergy updates.</span>
            {% endif %}
        </div>
    </section>

    <section class="synergy-status-row">
        <div class="card synergy-status-card">
            <div class="synergy-status-main">
                {% if cache_info.exists %}
                    {% if cache_info.is_stale %}
                        <div class="synergy-status-message">
                            <div class="synergy-status-title text-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Data may be outdated
                            </div>
                            <div class="synergy-status-detail">Last updated {{ cache_info.age_hours|round(1) }} hours ago.</div>
                        </div>
                        {% if current_user.is_admin %}
                            <button class="btn btn-sm btn-warning synergy-status-action" onclick="refreshSynergyData()">
                                <i class="fas fa-sync-alt"></i> Refresh Now
                            </button>
                        {% endif %}
                    {% else %}
                        <div class="synergy-status-message">
                            <div class="synergy-status-title text-success">
                                <i class="fas fa-check-circle"></i>
                                Data is current
                            </div>
                            <div class="synergy-status-detail">Last updated {{ cache_info.age_hours|round(1) }} hours ago.</div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="synergy-status-message">
                        <div class="synergy-status-title text-info">
                            <i class="fas fa-info-circle"></i>
                            No data cached yet
                        </div>
                        <div class="synergy-status-detail">Run a refresh to populate Synergy stats.</div>
                    </div>
                    {% if current_user.is_admin %}
                        <button class="btn btn-sm btn-info synergy-status-action" onclick="refreshSynergyData()">
                            <i class="fas fa-download"></i> Fetch Data
                        </button>
                    {% endif %}
                {% endif %}
            </div>
            <div class="synergy-kpi-group">
                <div class="synergy-kpi">
                    <div class="synergy-kpi-label">PnR PPP</div>
                    <div class="synergy-kpi-value">
                        {{ ((summary.ball_handler.ppp + summary.roll_man.ppp) / 2)|round(3) }}
                    </div>
                </div>
                <div class="synergy-kpi">
                    <div class="synergy-kpi-label">Total Possessions</div>
                    <div class="synergy-kpi-value">
                        {{ summary.ball_handler.possessions + summary.roll_man.possessions }}
                    </div>
                </div>
                <div class="synergy-kpi">
                    <div class="synergy-kpi-label">Total Players</div>
                    <div class="synergy-kpi-value">{{ summary.player_count_bh + summary.player_count_rm }}</div>
                </div>
            </div>
        </div>
    </section>

    <section class="synergy-feature-grid">
        <div class="synergy-feature-card card">
            <div class="card-body">
                <div class="synergy-feature-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 2a8 8 0 0 1 7.75 6H4.25A8 8 0 0 1 12 4Zm-7.75 8h6.25v6.25A8.02 8.02 0 0 1 4.25 12Zm8.75 6.25V12h6.25a8.02 8.02 0 0 1-6.25 6.25Z"/>
                    </svg>
                </div>
                <h5 class="card-title">Pick & Roll Analysis</h5>
                <p class="card-text text-muted">
                    Detailed breakdown of PnR ball handlers and roll men.
                </p>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('synergy.pnr_analysis') }}" class="btn btn-sm btn-crimson">
                    Open Analysis
                </a>
                <span class="synergy-feature-secondary text-muted">Updated daily</span>
            </div>
        </div>

        <div class="synergy-feature-card card is-disabled">
            <div class="card-body">
                <div class="synergy-feature-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M12 3a9 9 0 1 0 0 18 9 9 0 0 0 0-18Zm1 2.05a7.02 7.02 0 0 1 4.95 3.32L13 11.03V5.05ZM11 5.05V11H5.05A7.02 7.02 0 0 1 11 5.05ZM5.05 13H11v5.95A7.02 7.02 0 0 1 5.05 13ZM13 18.95V13h5.95A7.02 7.02 0 0 1 13 18.95Z"/>
                    </svg>
                </div>
                <h5 class="card-title">Play Type Breakdown</h5>
                <p class="card-text text-muted">
                    Isolation, post-up, and transition insights are on the way.
                </p>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-secondary" disabled>Coming Soon</button>
                <span class="synergy-feature-secondary text-muted">Planned feature</span>
            </div>
        </div>

        <div class="synergy-feature-card card is-disabled">
            <div class="card-body">
                <div class="synergy-feature-icon">
                    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path fill="currentColor" d="M12 3 5 6v6c0 5 3.5 7.5 7 9 3.5-1.5 7-4 7-9V6l-7-3Zm0 2.2 5 2.15v4.65c0 3.6-2.4 5.55-5 6.7-2.6-1.15-5-3.1-5-6.7V7.35l5-2.15Z"/>
                    </svg>
                </div>
                <h5 class="card-title">Defensive Stats</h5>
                <p class="card-text text-muted">
                    Track defensive play type analytics and matchups soon.
                </p>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-secondary" disabled>Coming Soon</button>
                <span class="synergy-feature-secondary text-muted">In development</span>
            </div>
        </div>
    </section>
</div>

<script>
function refreshSynergyData() {
    if (!confirm('This will fetch fresh data from Synergy API. Continue?')) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    
    fetch('{{ url_for("synergy.api_refresh") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Data refreshed successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Now';
        }
    })
    .catch(error => {
        alert('Error refreshing data: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Now';
    });
}
</script>
{% endblock %}
