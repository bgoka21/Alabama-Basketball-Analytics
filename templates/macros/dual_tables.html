{% macro render_dual_section(title, rows, totals, columns, note_date=None, empty_message='No stats for the most recent practice.') %}
  {% set rows = rows or [] %}
  {% set totals = totals or None %}
  {% set totals_totals = totals.totals if totals else None %}
  {% set last_totals = totals.last if totals else None %}
  {% set totals_label = totals.label if totals and totals.label else (totals_totals.player if totals_totals and totals_totals.player else 'Team Totals') %}
  {% set has_content = rows|length or totals_totals or last_totals %}
  <section class="space-y-3">
    <div class="flex items-baseline justify-between">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">{{ title }}</h3>
      {% if note_date %}<span class="text-xs opacity-70">({{ note_date }})</span>{% endif %}
    </div>
    <div class="hidden">{{ title }} — Practice Totals</div>
    <div class="hidden">{{ title }} — Last Practice</div>
    {% if has_content %}
      <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white dark:bg-neutral-900 overflow-hidden">
        <table class="table-leaderboard min-w-full text-sm">
          {{ render_grouped_last_practice_header(columns, 'Totals', 'Last Practice') }}
          <tbody>
            {% for row in rows %}
              {% set totals_data = row.totals if row.totals else {} %}
              {% set last_data = row.last if row.last else {} %}
              {% set jersey = row.jersey if row.jersey is not none and row.jersey != '' else loop.index %}
              <tr class="border-t border-gray-200 even:bg-gray-50">
                <td class="td-num px-4 py-2 text-center">{{ jersey }}</td>
                <td class="td-player px-4 py-2 text-left">{{ row.player }}</td>
                {% for col in columns %}
                  {% set value = totals_data[col] if totals_data and col in totals_data else '—' %}
                  <td class="td-stat px-4 py-2 text-right">{{ value }}</td>
                {% endfor %}
                {% for col in columns %}
                  {% set value = last_data[col] if last_data and col in last_data else '—' %}
                  <td class="td-stat px-4 py-2 text-right">{{ value }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
            {% if totals_totals or last_totals %}
              <tr class="font-semibold bg-gray-100 team-totals">
                <td class="td-num px-4 py-2 text-center"></td>
                <td class="td-player px-4 py-2 text-left">{{ totals_label }}</td>
                {% for col in columns %}
                  {% set value = totals_totals[col] if totals_totals and col in totals_totals else '—' %}
                  <td class="td-stat px-4 py-2 text-right">{{ value }}</td>
                {% endfor %}
                {% for col in columns %}
                  {% set value = last_totals[col] if last_totals and col in last_totals else '—' %}
                  <td class="td-stat px-4 py-2 text-right">{{ value }}</td>
                {% endfor %}
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-sm opacity-70">{{ empty_message }}</div>
    {% endif %}
  </section>
{% endmacro %}

{# 
  Renders a two-row table header that groups stat columns into
  “Totals” and “Last Practice” with matching stat labels.
  Use with .table-leaderboard + the CSS widths we added.
#}
{% macro render_grouped_last_practice_header(base_stat_labels, left_title='Totals', right_title='Last Practice', extra_headers=None, thead_class='bg-gray-100 border-b-4 border-[#9E1B32]') %}
  {% set stat_count = base_stat_labels|length %}
  {% set extras = extra_headers or [] %}
  {% set ns = namespace(items=[], next_col=2 + stat_count * 2) %}
  {% for header in extras %}
    {% set colspan = header.get('colspan', 1) %}
    {% set data_col = header.get('data_col') %}
    {% if data_col is none %}
      {% set data_col = ns.next_col %}
    {% endif %}
    {% set item = {
      'label': header.get('label'),
      'classes': header.get('classes'),
      'colspan': colspan,
      'rowspan': header.get('rowspan', 1),
      'data_col': data_col,
      'second_row_label': header.get('second_row_label'),
      'second_row_classes': header.get('second_row_classes')
    } %}
    {% set _ = ns.items.append(item) %}
    {% set ns.next_col = data_col + colspan %}
  {% endfor %}
  {% set extra_items = ns.items %}
  <thead{% if thead_class %} class="{{ thead_class }}"{% endif %}>
    <tr>
      <th class="th-num px-4 py-2 text-center sortable" rowspan="2" data-col="0">#</th>
      <th class="th-player px-4 py-2 text-left sortable" rowspan="2" data-col="1">Player</th>
      <th class="th-group px-4 py-2" colspan="{{ stat_count }}">{{ left_title }}</th>
      <th class="th-group px-4 py-2" colspan="{{ stat_count }}">{{ right_title }}</th>
      {% for item in extra_items %}
        {% set classes = item.classes or 'th-stat px-4 py-2 text-center sortable' %}
        <th class="{{ classes }}{% if 'sortable' not in classes %} sortable{% endif %}"
            {% if item.rowspan != 1 %}rowspan="{{ item.rowspan }}"{% endif %}
            {% if item.colspan != 1 %}colspan="{{ item.colspan }}"{% endif %}
            data-col="{{ item.data_col }}">
          {{ item.label }}
        </th>
      {% endfor %}
    </tr>
    <tr>
      {% for label in base_stat_labels %}
        {% set data_col = 2 + loop.index0 %}
        <th class="th-stat px-4 py-2 text-center sortable" data-col="{{ data_col }}">{{ label }}</th>
      {% endfor %}
      {% for label in base_stat_labels %}
        {% set data_col = 2 + stat_count + loop.index0 %}
        <th class="th-stat px-4 py-2 text-center sortable" data-col="{{ data_col }}">{{ label }}</th>
      {% endfor %}
      {% set extra_index = 0 %}
      {% for item in extra_items %}
        {% if item.rowspan == 1 %}
          {% set classes = item.second_row_classes or item.classes or 'th-stat px-4 py-2 text-center sortable' %}
          <th class="{{ classes }}{% if 'sortable' not in classes %} sortable{% endif %}" data-col="{{ item.data_col }}">
            {{ item.second_row_label or item.label }}
          </th>
        {% endif %}
      {% endfor %}
    </tr>
  </thead>
{% endmacro %}

{% macro td_stat(value) -%}
  <td class="px-4 py-2">
    {{ value }}
  </td>
{%- endmacro %}
