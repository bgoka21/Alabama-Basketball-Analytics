{%- macro render_table(
  id,
  columns,
  rows,
  totals=None,
  dense=True,
  sticky_header=False,
  caption=None,
  default_sort=None,
  header_rows=None,
  draggable_headers=False
) -%}
  {%- set container_classes = 'rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden' -%}
  {%- set padding_class = 'px-4 py-2' if dense else 'px-4 py-3' -%}
  {%- set advanced_onoff_keys = [
    'adv_ppp_on_offense',
    'adv_ppp_off_offense',
    'adv_offensive_leverage',
    'adv_ppp_on_defense',
    'adv_ppp_off_defense',
    'adv_defensive_leverage'
  ] -%}
  <div class="{{ container_classes }}">
    <div class="table-card-accent" aria-hidden="true"></div>
    <div class="overflow-x-auto table-card-body">
      {%- set table_classes = 'w-full min-w-full text-sm table-fixed unified-table' -%}
      {%- if sticky_header -%}
        {%- set table_classes = table_classes ~ ' thead-sticky' -%}
      {%- endif -%}
      <table id="{{ id }}" role="table" class="{{ table_classes }}"{% if default_sort %} data-default-sort="{{ default_sort }}"{% endif %}{% if draggable_headers %} data-draggable-headers="true"{% endif %}>
        {%- if caption %}
        <caption class="sr-only">{{ caption }}</caption>
        {%- endif %}
        {%- set thead_classes = 'bg-gray-50 dark:bg-gray-800/60 border-b border-gray-200 dark:border-gray-700' -%}
        {%- set sticky_header_class = ' sticky top-0 z-10 bg-gray-50 dark:bg-gray-800/60' if sticky_header else '' -%}
        {%- set header_rows_data = header_rows or [] -%}
        {%- set has_custom_header = header_rows_data | length > 0 -%}
        <thead class="{{ thead_classes }}{% if sticky_header %} sticky top-0 z-10{% endif %}">
          {%- if has_custom_header -%}
            {%- for row in header_rows_data -%}
              <tr{% if draggable_headers %} data-header-row="columns"{% endif %}>
                {%- for cell in row -%}
                  {%- set cell_type = cell.type if cell.type is defined else 'group' -%}
                  {%- set cell_colspan = cell.colspan if cell.colspan is defined else 1 -%}
                  {%- set cell_rowspan = cell.rowspan if cell.rowspan is defined else 1 -%}
                  {%- if cell_type == 'column' -%}
                    {%- set col = cell.column -%}
                    {%- set align = col.align | default('left') -%}
                    {%- set align_class = {
                      'left': 'text-left',
                      'right': 'text-right',
                      'center': 'text-center'
                    }[align] -%}
                    {%- set justify_class = {
                      'left': 'justify-start',
                      'right': 'justify-end',
                      'center': 'justify-center'
                    }[align] -%}
                    {%- set width_class = col.width if col.width is defined and col.width else '' -%}
                    {%- set th_base_classes = padding_class ~ ' font-semibold text-gray-700 dark:text-gray-200 whitespace-nowrap select-none ' ~ align_class ~ sticky_header_class -%}
                    {%- if col.sortable -%}
                      {%- set th_base_classes = th_base_classes ~ ' sortable' -%}
                    {%- endif -%}
                    <th scope="col"
                        class="{{ th_base_classes }} {{ width_class }}"
                        data-sortable="{{ 'true' if col.sortable else 'false' }}"
                        data-key="{{ col.key }}"
                        aria-sort="none"
                        {%- if cell_rowspan | int > 1 %} rowspan="{{ cell_rowspan }}"{%- endif -%}
                        {%- if cell_colspan | int > 1 %} colspan="{{ cell_colspan }}"{%- endif -%}>
                    {%- set drag_handle -%}
                      {%- if draggable_headers and col.key != 'player' -%}
                        <span class="col-drag-handle" draggable="true" data-drag-handle aria-label="Reorder column" title="Drag to reorder">⋮⋮</span>
                      {%- endif -%}
                    {%- endset -%}
                    {%- if col.sortable -%}
                      <button type="button" class="inline-flex items-center gap-2 w-full {{ justify_class }} group"
                              aria-label="Sort by {{ col.label }}">
                        {{ drag_handle }}
                        <span>{{ col.label | safe }}</span>
                        <span class="sort-caret opacity-0 group-hover:opacity-100 transition" aria-hidden="true"></span>
                      </button>
                    {%- else -%}
                      <div class="inline-flex items-center w-full {{ justify_class }}">
                        {{ drag_handle }}
                        <span>{{ col.label | safe }}</span>
                      </div>
                    {%- endif -%}
                    </th>
                  {%- else -%}
                    {%- set group_th_classes = padding_class ~ ' font-semibold text-gray-700 dark:text-gray-200 whitespace-nowrap select-none text-center' ~ sticky_header_class -%}
                    <th scope="col"
                        class="{{ group_th_classes }}"
                        {%- if cell_colspan | int > 1 %} colspan="{{ cell_colspan }}"{%- endif -%}
                        {%- if cell_rowspan | int > 1 %} rowspan="{{ cell_rowspan }}"{%- endif -%}>
                      {{ cell.label | safe }}
                    </th>
                  {%- endif -%}
                {%- endfor -%}
              </tr>
            {%- endfor -%}
            <tr{% if draggable_headers %} data-header-row="columns"{% endif %}>
              {%- for col in columns if col.render_header is not defined or col.render_header -%}
                {%- set align = col.align | default('left') -%}
                {%- set align_class = {
                  'left': 'text-left',
                  'right': 'text-right',
                  'center': 'text-center'
                }[align] -%}
                {%- set justify_class = {
                  'left': 'justify-start',
                  'right': 'justify-end',
                  'center': 'justify-center'
                }[align] -%}
                {%- set width_class = col.width if col.width is defined and col.width else '' -%}
                {%- set th_base_classes = padding_class ~ ' font-semibold text-gray-700 dark:text-gray-200 whitespace-nowrap select-none ' ~ align_class ~ sticky_header_class -%}
                {%- if col.sortable -%}
                  {%- set th_base_classes = th_base_classes ~ ' sortable' -%}
                {%- endif -%}
                <th scope="col"
                    class="{{ th_base_classes }} {{ width_class }}"
                    data-sortable="{{ 'true' if col.sortable else 'false' }}"
                    data-key="{{ col.key }}"
                    aria-sort="none">
                {%- set drag_handle -%}
                  {%- if draggable_headers and col.key != 'player' -%}
                    <span class="col-drag-handle" draggable="true" data-drag-handle aria-label="Reorder column" title="Drag to reorder">⋮⋮</span>
                  {%- endif -%}
                {%- endset -%}
                {%- if col.sortable -%}
                  <button type="button" class="inline-flex items-center gap-2 w-full {{ justify_class }} group"
                          aria-label="Sort by {{ col.label }}">
                    {{ drag_handle }}
                    <span>{{ col.label | safe }}</span>
                    <span class="sort-caret opacity-0 group-hover:opacity-100 transition" aria-hidden="true"></span>
                  </button>
                {%- else -%}
                  <div class="inline-flex items-center w-full {{ justify_class }}">
                    {{ drag_handle }}
                    <span>{{ col.label | safe }}</span>
                  </div>
                {%- endif -%}
                </th>
              {%- endfor %}
            </tr>
          {%- else -%}
          {%- set grouped_columns = columns | selectattr('group', 'defined') | selectattr('group') | list -%}
          {%- set has_groups = grouped_columns | length > 0 -%}
          {%- if has_groups -%}
            {%- set header_state = namespace(items=[], current_label=None, current_span=0) -%}
            {%- for col in columns -%}
              {%- set group = col.group if col.group is defined else none -%}
              {%- if group -%}
                {%- if header_state.current_label == group -%}
                  {%- set header_state.current_span = header_state.current_span + 1 -%}
                {%- else -%}
                  {%- if header_state.current_span > 0 -%}
                    {%- set header_state.items = header_state.items + [{'type': 'group', 'label': header_state.current_label, 'span': header_state.current_span}] -%}
                  {%- endif -%}
                  {%- set header_state.current_label = group -%}
                  {%- set header_state.current_span = 1 -%}
                {%- endif -%}
              {%- else -%}
                {%- if header_state.current_span > 0 -%}
                  {%- set header_state.items = header_state.items + [{'type': 'group', 'label': header_state.current_label, 'span': header_state.current_span}] -%}
                  {%- set header_state.current_label = None -%}
                  {%- set header_state.current_span = 0 -%}
                {%- endif -%}
                {%- set header_state.items = header_state.items + [{'type': 'standalone', 'column': col}] -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if header_state.current_span > 0 -%}
              {%- set header_state.items = header_state.items + [{'type': 'group', 'label': header_state.current_label, 'span': header_state.current_span}] -%}
            {%- endif -%}
            {%- set header_groups = header_state.items -%}
            <tr{% if draggable_headers %} data-header-row="columns"{% endif %}>
              {%- for item in header_groups -%}
                {%- if item.type == 'group' -%}
                  {%- set group_th_classes = padding_class ~ ' font-semibold text-gray-700 dark:text-gray-200 whitespace-nowrap select-none text-center' ~ sticky_header_class -%}
                  <th scope="col" colspan="{{ item.span }}" class="{{ group_th_classes }}">
                    {{ item.label }}
                  </th>
                {%- else -%}
                  {%- set col = item.column -%}
                  {%- set align = col.align | default('left') -%}
                  {%- set align_class = {
                    'left': 'text-left',
                    'right': 'text-right',
                    'center': 'text-center'
                  }[align] -%}
                  {%- set justify_class = {
                    'left': 'justify-start',
                    'right': 'justify-end',
                    'center': 'justify-center'
                  }[align] -%}
                  {%- set width_class = col.width if col.width is defined and col.width else '' -%}
                  {%- set th_base_classes = padding_class ~ ' font-semibold text-gray-700 dark:text-gray-200 whitespace-nowrap select-none ' ~ align_class ~ sticky_header_class -%}
                  {%- if col.sortable -%}
                    {%- set th_base_classes = th_base_classes ~ ' sortable' -%}
                  {%- endif -%}
                  <th scope="col"
                      class="{{ th_base_classes }} {{ width_class }}"
                      data-sortable="{{ 'true' if col.sortable else 'false' }}"
                      data-key="{{ col.key }}"
                      aria-sort="none"
                      rowspan="2">
                    {%- set drag_handle -%}
                      {%- if draggable_headers and col.key != 'player' -%}
                        <span class="col-drag-handle" draggable="true" data-drag-handle aria-label="Reorder column" title="Drag to reorder">⋮⋮</span>
                      {%- endif -%}
                    {%- endset -%}
                    {%- if col.sortable -%}
                      <button type="button" class="inline-flex items-center gap-2 w-full {{ justify_class }} group"
                              aria-label="Sort by {{ col.label }}">
                        {{ drag_handle }}
                        <span>{{ col.label | safe }}</span>
                        <span class="sort-caret opacity-0 group-hover:opacity-100 transition" aria-hidden="true"></span>
                      </button>
                    {%- else -%}
                      <div class="inline-flex items-center w-full {{ justify_class }}">
                        {{ drag_handle }}
                        <span>{{ col.label | safe }}</span>
                      </div>
                    {%- endif -%}
                  </th>
                {%- endif -%}
              {%- endfor %}
            </tr>
            <tr{% if draggable_headers %} data-header-row="columns"{% endif %}>
              {%- for col in columns if col.group is defined and col.group -%}
                {%- set align = col.align | default('left') -%}
                {%- set align_class = {
                  'left': 'text-left',
                  'right': 'text-right',
                  'center': 'text-center'
                }[align] -%}
                {%- set justify_class = {
                  'left': 'justify-start',
                  'right': 'justify-end',
                  'center': 'justify-center'
                }[align] -%}
                {%- set width_class = col.width if col.width is defined and col.width else '' -%}
                {%- set th_base_classes = padding_class ~ ' font-semibold text-gray-700 dark:text-gray-200 whitespace-nowrap select-none ' ~ align_class ~ sticky_header_class -%}
                {%- if col.sortable -%}
                  {%- set th_base_classes = th_base_classes ~ ' sortable' -%}
                {%- endif -%}
                <th scope="col"
                    class="{{ th_base_classes }} {{ width_class }}"
                    data-sortable="{{ 'true' if col.sortable else 'false' }}"
                    data-key="{{ col.key }}"
                    aria-sort="none">
                  {%- set drag_handle -%}
                    {%- if draggable_headers and col.key != 'player' -%}
                      <span class="col-drag-handle" draggable="true" data-drag-handle aria-label="Reorder column" title="Drag to reorder">⋮⋮</span>
                    {%- endif -%}
                  {%- endset -%}
                  {%- if col.sortable -%}
                    <button type="button" class="inline-flex items-center gap-2 w-full {{ justify_class }} group"
                            aria-label="Sort by {{ col.label }}">
                      {{ drag_handle }}
                      <span>{{ col.label | safe }}</span>
                      <span class="sort-caret opacity-0 group-hover:opacity-100 transition" aria-hidden="true"></span>
                    </button>
                  {%- else -%}
                    <div class="inline-flex items-center w-full {{ justify_class }}">
                      {{ drag_handle }}
                      <span>{{ col.label | safe }}</span>
                    </div>
                  {%- endif -%}
                </th>
              {%- endfor %}
            </tr>
          {%- else -%}
            <tr{% if draggable_headers %} data-header-row="columns"{% endif %}>
              {%- for col in columns %}
                {%- set align = col.align | default('left') -%}
                {%- set align_class = {
                  'left': 'text-left',
                  'right': 'text-right',
                  'center': 'text-center'
                }[align] -%}
                {%- set justify_class = {
                  'left': 'justify-start',
                  'right': 'justify-end',
                  'center': 'justify-center'
                }[align] -%}
                {%- set width_class = col.width if col.width is defined and col.width else '' -%}
                {%- set th_base_classes = padding_class ~ ' font-semibold text-gray-700 dark:text-gray-200 whitespace-nowrap select-none ' ~ align_class ~ sticky_header_class -%}
                {%- if col.sortable -%}
                  {%- set th_base_classes = th_base_classes ~ ' sortable' -%}
                {%- endif -%}
                <th scope="col"
                    class="{{ th_base_classes }} {{ width_class }}"
                    data-sortable="{{ 'true' if col.sortable else 'false' }}"
                    data-key="{{ col.key }}"
                    aria-sort="none">
                  {%- set drag_handle -%}
                    {%- if draggable_headers and col.key != 'player' -%}
                      <span class="col-drag-handle" draggable="true" data-drag-handle aria-label="Reorder column" title="Drag to reorder">⋮⋮</span>
                    {%- endif -%}
                  {%- endset -%}
                  {%- if col.sortable -%}
                    <button type="button" class="inline-flex items-center gap-2 w-full {{ justify_class }} group"
                            aria-label="Sort by {{ col.label }}">
                      {{ drag_handle }}
                      <span>{{ col.label | safe }}</span>
                      <span class="sort-caret opacity-0 group-hover:opacity-100 transition" aria-hidden="true"></span>
                    </button>
                  {%- else -%}
                    <div class="inline-flex items-center w-full {{ justify_class }}">
                      {{ drag_handle }}
                      <span>{{ col.label | safe }}</span>
                    </div>
                  {%- endif -%}
                </th>
              {%- endfor %}
            </tr>
          {%- endif -%}
          {%- endif -%}
        </thead>
        <tbody>
          {%- for row in rows %}
          <tr class="odd:bg-white even:bg-gray-50 dark:odd:bg-gray-900 dark:even:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700/60 transition-colors">
            {%- for col in columns %}
              {%- set align = col.align | default('left') -%}
              {%- set align_class = {
                'left': 'text-left',
                'right': 'text-right',
                'center': 'text-center'
              }[align] -%}
              {%- set numeric_class = ' text-right tabular-nums' if align == 'right' else '' -%}
              {%- set cell_class = col.cell_class if col.cell_class is defined and col.cell_class else '' -%}
              {%- set cell_value = row.get(col.key) if row is mapping else row | attr(col.key) -%}
              {%- set data_value = '' -%}
              {%- set data_type = col.format if col.format is defined and col.format else 'text' -%}
              {%- if cell_value is mapping and cell_value.display is defined -%}
                {%- set display_value = cell_value.display -%}
                {%- if cell_value.data_value is defined and cell_value.data_value is not none -%}
                  {%- set data_value = cell_value.data_value -%}
                {%- endif -%}
              {%- else -%}
                {%- set raw_value = cell_value if cell_value is not none and cell_value is not undefined else none -%}
                {%- if col.key in advanced_onoff_keys -%}
                  {%- if raw_value is number -%}
                    {%- set display_value = '%.2f' % raw_value -%}
                    {%- set data_value = raw_value -%}
                  {%- elif raw_value not in (none, '') -%}
                    {%- set numeric_value = raw_value | float -%}
                    {%- set display_value = '%.2f' % numeric_value -%}
                    {%- set data_value = numeric_value -%}
                  {%- else -%}
                    {%- set display_value = '—' -%}
                  {%- endif -%}
                {%- else -%}
                  {%- set display_value = raw_value if raw_value is not none else '' -%}
                {%- endif -%}
              {%- endif -%}
              {%- if col.value_key is defined and col.value_key -%}
                {%- if row is mapping -%}
                  {%- set override_value = row.get(col.value_key) -%}
                {%- else -%}
                  {%- set override_value = row | attr(col.value_key) -%}
                {%- endif -%}
                {%- if override_value is not none and override_value is not undefined and override_value != '' -%}
                  {%- set data_value = override_value -%}
                {%- endif -%}
              {%- endif -%}
              {%- if data_value is undefined or data_value is none -%}
                {%- set data_value = '' -%}
              {%- endif -%}
              <td class="{{ padding_class }} {{ align_class }}{{ numeric_class }}{% if cell_class %} {{ cell_class }}{% endif %}"
                  data-key="{{ col.key }}" data-type="{{ data_type }}"{% if data_value != '' %} data-value="{{ data_value }}"{% endif %}>{{ display_value | trim }}</td>
            {%- endfor %}
          </tr>
          {%- endfor %}
        </tbody>
        {%- if totals %}
        <tfoot>
          <tr class="bg-gray-50 dark:bg-gray-800/60 font-semibold border-t border-gray-200 dark:border-gray-700">
            {%- for col in columns %}
              {%- set align = col.align | default('left') -%}
              {%- set align_class = {
                'left': 'text-left',
                'right': 'text-right',
                'center': 'text-center'
              }[align] -%}
              {%- set numeric_class = ' text-right tabular-nums' if align == 'right' else '' -%}
              {%- set cell_class = col.cell_class if col.cell_class is defined and col.cell_class else '' -%}
              {%- set total_value = totals.get(col.key) -%}
              {%- if loop.first -%}
                <th scope="row" class="{{ padding_class }} {{ align_class }}{{ numeric_class }}{% if cell_class %} {{ cell_class }}{% endif %}">
                  {{ total_value if total_value is not none and total_value != '' else 'Totals' }}
                </th>
              {%- else -%}
                <td class="{{ padding_class }} {{ align_class }}{{ numeric_class }}{% if cell_class %} {{ cell_class }}{% endif %}">
                  {%- if col.key in advanced_onoff_keys -%}
                    {%- if total_value is number -%}
                      {{ '%.2f' % total_value }}
                    {%- elif total_value not in (none, '') -%}
                      {{ '%.2f' % (total_value | float) }}
                    {%- else -%}
                      —
                    {%- endif -%}
                  {%- else -%}
                    {{ total_value if total_value is not none else '' }}
                  {%- endif -%}
                </td>
              {%- endif -%}
            {%- endfor %}
          </tr>
        </tfoot>
        {%- endif %}
      </table>
    </div>
  </div>
{%- endmacro %}

{# Example usage:
{% from 'macros/table.html' import render_table %}

{% set columns = [
  {'key':'rank','label':'#','sortable':true, 'align':'right', 'width':'w-12'},
  {'key':'player','label':'Player','sortable':true, 'align':'left'},
  {'key':'bump_plus','label':'Bump +','sortable':true, 'align':'right'},
  {'key':'bump_opp','label':'Bump Opp','sortable':true, 'align':'right'},
  {'key':'bump_pct','label':'Bump %','sortable':true, 'align':'right'},
] %}

{{ render_table(
  id='defense-bumps',
  columns=columns,
  rows=rows,                 # list of dicts
  totals=totals,             # dict or None
  dense=True,
  sticky_header=False,
  caption='Defense — Bumps'
) }}
#}
