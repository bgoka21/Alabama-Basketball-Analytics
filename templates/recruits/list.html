{% extends "base.html" %}
{% from 'macros/table.html' import render_table %}
{% block content %}
  <h1 class="text-2xl font-bold mb-4">Recruits</h1>
  <div class="mb-4">
    <a href="{{ url_for('recruits.new_recruit') }}" class="bg-[#9E1B32] text-white px-4 py-2 rounded hover:bg-[#7a1526]">Add Recruit</a>
  </div>

  <div class="mb-4 flex flex-wrap gap-2">
    {% for lab in ['All','EYBL','3SSB','UA'] %}
      {% set active = circuit_filter == lab %}
      {% if lab == 'All' %}
        {% set link = url_for('recruits.list_recruits') %}
      {% else %}
        {% set link = url_for('recruits.list_recruits', circuit=lab) %}
      {% endif %}
      <a href="{{ link }}"
         class="px-3 py-1 rounded-full border text-sm {{ 'bg-[#9E1B32] text-white' if active else 'text-gray-700 hover:bg-gray-100' }}">
         {{ lab }}{% if circuit_counts[lab] is defined %} ({{ circuit_counts[lab] }}){% endif %}
      </a>
    {% endfor %}
  </div>

  {% set columns = [
    {'key': 'name', 'label': 'Name', 'sortable': True, 'align': 'left'},
    {'key': 'grad_year', 'label': 'Grad Year', 'sortable': True, 'align': 'right', 'value_key': 'grad_year_raw'},
    {'key': 'position', 'label': 'Position', 'sortable': True, 'align': 'left'},
    {'key': 'pps', 'label': 'PPS', 'sortable': True, 'align': 'right', 'value_key': 'pps_raw'},
    {'key': 'actions', 'label': 'Actions', 'sortable': False, 'align': 'center', 'width': 'w-32'}
  ] %}

  {% set table_rows = namespace(items=[]) %}
  {% for r in recruits %}
    {% set name_cell %}
      <a href="{{ url_for('recruits.detail_recruit', id=r.id) }}" class="text-blue-600 hover:underline">{{ r.name }}</a>
      {% if r.latest_circuit %}
        <span class="ml-1 text-xs bg-gray-200 text-gray-800 px-1 rounded"
              title="{% if r.additional_circuits %}{{ r.additional_circuits|join(', ') }}{% endif %}">
          {{ r.latest_circuit }}{% if r.additional_circuits %} +{{ r.additional_circuits|length }}{% endif %}
        </span>
      {% endif %}
    {% endset %}

    {% set pps_value = r.overall_pps %}
    {% if pps_value is not none %}
      {% set pps_display = '%.2f'|format(pps_value) %}
    {% else %}
      {% set pps_display = '' %}
    {% endif %}

    {% set actions %}
      <div class="flex items-center justify-center gap-3">
        <a href="{{ url_for('recruits.edit_recruit', id=r.id) }}" class="text-blue-600 hover:underline">Edit</a>
        <form action="{{ url_for('recruits.delete_recruit', id=r.id) }}" method="post" class="inline"
              onsubmit="return confirm('Delete {{ r.name }}?');">
          <button type="submit" class="text-red-600 hover:underline">Delete</button>
        </form>
      </div>
    {% endset %}

    {% set table_rows.items = table_rows.items + [{
      'name': name_cell | safe,
      'grad_year': r.graduation_year,
      'grad_year_raw': r.graduation_year,
      'position': r.position,
      'pps': pps_display,
      'pps_raw': pps_value if pps_value is not none else '',
      'actions': actions | safe
    }] %}
  {% endfor %}

  {{ render_table(
    id='recruits-list',
    columns=columns,
    rows=table_rows.items,
    totals=None,
    dense=True,
    sticky_header=True,
    caption='Recruit Directory'
  ) }}

  {% if table_rows.items | length == 0 %}
    <div class="table-empty text-center text-sm text-gray-600 dark:text-gray-300 mt-3">No recruits found.</div>
  {% endif %}
{% endblock %}
