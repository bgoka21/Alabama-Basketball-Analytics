{% extends 'base.html' %}
{% block content %}

<div class="w-full p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-xl shadow">
  <div class="mb-4 rounded-2xl p-4 sm:p-6 bg-gradient-to-r from-gray-900 to-gray-700 text-white flex items-center justify-between">
    <div>
      <div class="text-xs uppercase opacity-80">Recruiting</div>
      <h1 class="text-2xl sm:text-3xl font-bold">Money Board</h1>
      {% if top %}
        <div class="mt-1 text-sm opacity-90">Top coach: <span class="font-semibold">{{ top.coach }}</span> · NET <span class="font-semibold">{{ top.net_sum|fmt_money }}</span></div>
      {% endif %}
    </div>
    <div class="flex gap-2">
      {% if not has_data %}
      <a href="{{ url_for('recruits.import_recruits_workbook') }}" class="px-3 py-2 rounded-xl bg-white text-gray-900 shadow hover:shadow-md">
        Import Workbook
      </a>
      {% endif %}
    </div>
  </div>

  {# Filters #}
  <form method="get" class="grid grid-cols-1 sm:grid-cols-5 gap-3 mb-4">
    <div>
      <label class="block text-sm mb-1">Year ≥</label>
      <select name="year_min" class="w-full border rounded p-2">
        <option value="">Any</option>
        {% for y in years %}
          <option value="{{ y }}" {% if f_year_min==y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Year ≤</label>
      <select name="year_max" class="w-full border rounded p-2">
        <option value="">Any</option>
        {% for y in years %}
          <option value="{{ y }}" {% if f_year_max==y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Sheet (Conf)</label>
      <select name="sheet" class="w-full border rounded p-2">
        <option value="">All</option>
        {% for s in sheets %}
          <option value="{{ s }}" {% if f_sheet==s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Coach Conf</label>
      <select name="conf" class="w-full border rounded p-2">
        <option value="">All</option>
        {% for c in confs %}
          <option value="{{ c }}" {% if f_conf==c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm mb-1">Min Recruits</label>
      <input type="number" min="1" name="min_recruits" value="{{ f_min_recruits }}" class="w-full border rounded p-2" />
    </div>
    <div class="sm:col-span-5 flex items-end gap-2">
      <label class="text-sm">Sort:</label>
      <select name="sort" class="border rounded p-2">
        <option value="net_desc" {% if f_sort=='net_desc' %}selected{% endif %}>NET (desc)</option>
        <option value="actual_desc" {% if f_sort=='actual_desc' %}selected{% endif %}>Actual $ (desc)</option>
        <option value="proj_desc" {% if f_sort=='proj_desc' %}selected{% endif %}>Projected $ (desc)</option>
        <option value="avg_net_desc" {% if f_sort=='avg_net_desc' %}selected{% endif %}>Avg NET / Recruit (desc)</option>
      </select>
      <button class="ml-auto px-3 py-2 rounded bg-gray-900 text-white dark:bg-gray-200 dark:text-black">Apply</button>
    </div>
  </form>

  <!-- Coach selector + Compare button -->
  <form method="GET" action="{{ url_for('recruits.money_compare') }}" class="space-y-2">
    {# carry existing filters forward #}
    <input type="hidden" name="year_min" value="{{ request.args.get('year_min','') }}">
    <input type="hidden" name="year_max" value="{{ request.args.get('year_max','') }}">
    <input type="hidden" name="sheet"    value="{{ request.args.get('sheet','') }}">
    <input type="hidden" name="conf"     value="{{ request.args.get('conf','') }}">
    <input type="hidden" name="min_recruits" value="{{ request.args.get('min_recruits','') }}">

    <!-- existing toolbar with search + counter -->
    <div class="flex items-center justify-between gap-3 mb-2">
      <div class="flex items-center gap-2 flex-wrap">
        <input id="coach-filter" type="text" placeholder="Search coaches..." class="input input-sm w-52" />
        <span id="coach-count" class="text-sm text-gray-500">0/10 selected</span>
      </div>
      <div class="text-xs text-gray-500">Select up to <b>ten</b> coaches to compare</div>
    </div>

    <div class="flex items-start gap-3 mb-3">
      <select id="coach-search" multiple class="select select-bordered w-full max-w-md">
        {% for coach in coach_list %}
          <option value="{{ coach }}">{{ coach }}</option>
        {% endfor %}
      </select>

      <div class="flex-1">
        <div id="coach-selected" class="flex items-center gap-2 flex-wrap"></div>
        <div id="coach-hidden" class="hidden"></div>
      </div>
    </div>

    <div class="flex justify-end">
      <button id="compare-btn" class="btn btn-primary" type="submit" disabled>
        Compare
      </button>
    </div>
  </form>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left sticky top-0 bg-white dark:bg-gray-800 border-b z-10">
          <th class="py-2 pr-4">Coach</th>
          <th class="py-2 pr-4">Team</th>
          <th class="py-2 pr-4">Conf</th>
          <th class="py-2 pr-4 text-right">Recruits</th>
          <th class="py-2 pr-4 text-right">Projected</th>
          <th class="py-2 pr-4 text-right">Actual</th>
          <th class="py-2 pr-4 text-right">NET</th>
          <th class="py-2 pr-4 text-right">Avg NET</th>
          <th class="py-2 pr-4">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-900">
          <td class="py-2 pr-4 font-medium">{{ r.coach }}</td>
          <td class="py-2 pr-4">{{ r.coach_team }}</td>
          <td class="py-2 pr-4">{{ r.coach_conf }}</td>
          <td class="py-2 pr-4 text-right">{{ r.recruits }}</td>
          <td class="py-2 pr-4 text-right">{{ r.proj_sum|fmt_money }}</td>
          <td class="py-2 pr-4 text-right">{{ r.act_sum|fmt_money }}</td>
          <td class="py-2 pr-4 text-right font-semibold {{ r.net_sum|posneg }}">{{ r.net_sum|fmt_money }}</td>
          <td class="py-2 pr-4 text-right">{{ r.avg_net|fmt_money }}</td>
          <td class="py-2 pr-4">
            <a class="text-blue-600 hover:underline" href="{{ url_for('recruits.money_coach', coach_name=r.coach) }}">View</a>
          </td>
        </tr>
        {% endfor %}
        {% if not rows %}
          <tr><td class="py-3 text-gray-500" colspan="9">No results.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <script src="{{ url_for('static', filename='js/coach_autocomplete.js') }}"></script>
</div>

{% endblock %}

