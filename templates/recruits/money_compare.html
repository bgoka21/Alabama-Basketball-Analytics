{% extends 'base.html' %}
{% block content %}
<div class="w-full p-4 sm:p-6 bg-white dark:bg-gray-800 rounded-xl shadow">
  <div class="sticky top-0 z-10 pb-2 mb-4 bg-white dark:bg-gray-800 flex items-center justify-between border-b border-gray-200 dark:border-gray-700">
    <h1 class="text-2xl sm:text-3xl font-bold">Compare Coaches</h1>
    <div class="flex items-center gap-2">
      <div id="saved-sets" class="hidden items-center gap-1 text-sm" aria-label="Saved compare sets">
        <label for="saved-sets-list" class="sr-only">Saved sets</label>
        <select id="saved-sets-list" class="select select-xs">
          <option value="">Saved sets…</option>
        </select>
        <button type="button" id="saved-sets-save" class="btn btn-xs">Save</button>
        <button type="button" id="saved-sets-apply" class="btn btn-xs" disabled>Apply</button>
        <button type="button" id="saved-sets-copy" class="btn btn-xs" disabled>Copy</button>
        <button type="button" id="saved-sets-rename" class="btn btn-xs" disabled>Rename</button>
        <button type="button" id="saved-sets-delete" class="btn btn-xs" disabled>Delete</button>
      </div>
      <a class="text-blue-600 hover:underline" href="{{ url_for('recruits.money_board', year_min=year_min, year_max=year_max, sheet=sheet, conf=conf, min_recruits=min_recruits, sort=sort) }}">← Back to Money Board</a>
    </div>
  </div>
  <div id="saved-sets-status" class="sr-only" aria-live="polite"></div>

  <form id="compare-form" method="get" action="{{ url_for('recruits.money_compare') }}" class="space-y-4">
    <input type="hidden" name="year_min" value="{{ year_min if year_min is not none else '' }}">
    <input type="hidden" name="year_max" value="{{ year_max if year_max is not none else '' }}">
    <input type="hidden" name="sheet" value="{{ sheet or '' }}">
    <input type="hidden" name="conf" value="{{ conf or '' }}">
    <input type="hidden" name="min_recruits" value="{{ min_recruits if min_recruits is not none else '' }}">
    <input type="hidden" name="sort" value="{{ sort or '' }}">
    <details id="coach-picker" open>
      <summary class="cursor-pointer select-none">Select coaches (<span id="coach-picker-count">{{ selected|length if selected else 0 }}</span>)</summary>

      <label for="coach-filter" class="sr-only">Search coaches</label>
      <input id="coach-filter"
             aria-label="Search coaches"
             type="text"
             placeholder="Search coaches..."
             class="input input-sm w-52"
             autocomplete="off" />

      <select id="coach-search"
              name="coaches"
              multiple
              size="12"
              class="w-full max-w-md border rounded p-1 overflow-auto"
              aria-label="Coaches to compare"
              data-max="10">
        {% for coach in coaches %}
          <option value="{{ coach }}" {% if coach in selected %}selected{% endif %}>{{ coach }}</option>
        {% endfor %}
      </select>

      <div id="coach-no-matches" class="hidden text-sm text-red-600">No matches</div>

      <!-- Optional counter + clear link (ids used by JS above) -->
      <div class="flex items-center gap-3 mt-2 text-sm text-gray-600">
        <span id="coach-count">{{ selected|length if selected else 0 }}</span>
        <button id="coach-clear" type="button" class="underline">Clear all</button>
      </div>

      <div id="coach-selected" class="flex items-center gap-2 flex-wrap mt-2"></div>

      <div id="coach-help" class="text-xs text-gray-500 text-right">Select up to 10 coaches to compare</div>

      <div class="flex justify-end items-center gap-4">
        <a id="compare-csv" class="text-sm underline text-blue-600" href="{{ url_for('recruits.money_compare_csv', coaches=selected, year_min=year_min, year_max=year_max, sheet=sheet, conf=conf, min_recruits=min_recruits, sort=sort) }}">Download CSV</a>
        <button id="compare-btn" type="submit" class="btn btn-primary">Compare</button>
      </div>
      {% if not_enough %}
        <p class="text-sm text-red-600 text-right">Select at least two coaches.</p>
      {% endif %}
    </details>
  </form>

  <noscript>
    <p class="mt-2 text-xs text-amber-600">Tip: Hold Ctrl/Cmd to select multiple coaches, then click Compare.</p>
  </noscript>

  {% if comps %}
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
    {% for c in comps %}
    <div class="p-4 rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900">
      <div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Coach</div>
      <div class="font-semibold mb-2 truncate">{{ c.coach }}</div>

      <div class="grid grid-cols-2 gap-y-1 text-sm">
        <div class="text-gray-500">Recruits</div>   <div class="text-right font-medium">{{ c.recruits }}</div>
        <div class="text-gray-500">Projected</div>  <div class="text-right">{{ c.proj_sum|fmt_money }}</div>
        <div class="text-gray-500">Actual</div>     <div class="text-right">{{ c.act_sum|fmt_money }}</div>
        <div class="text-gray-500">NET</div>        <div class="text-right font-semibold {{ c.net_sum|posneg }}">{{ c.net_sum|fmt_money }}</div>
        <div class="text-gray-500">Avg NET</div>    <div class="text-right">{{ c.avg_net|fmt_money }}</div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="space-y-4 mt-4">
    {% for c in comps %}
    <details class="group border border-gray-200 dark:border-gray-800 rounded-xl">
      <summary class="cursor-pointer px-4 py-3 flex items-center justify-between">
        <span class="font-semibold">{{ c.coach }}</span>
        <span class="text-sm text-gray-500 group-open:hidden">Show players</span>
        <span class="text-sm text-gray-500 hidden group-open:inline">Hide players</span>
      </summary>

      <div class="px-4 pb-4 overflow-x-auto" data-coach-scope="{{ loop.index0 }}">
        {% set roster = players_by_coach.get(c.coach, []) %}
        {% if roster %}
        <div class="hidden mb-2 flex items-center justify-between gap-2 text-xs" data-controls>
          <div>
            <label for="player-search-{{ loop.index0 }}" class="sr-only">Search players</label>
            <input id="player-search-{{ loop.index0 }}" aria-label="Search players" type="text" placeholder="Search players..." class="input input-xs w-36" data-search>
          </div>
          <div class="flex items-center gap-2 text-gray-500">
            <span data-row-count aria-live="polite">{{ roster|length }} players</span>
            <span data-topn-status class="hidden">Top 25 by NET</span>
            <button type="button" data-topn-toggle class="text-blue-600 hover:underline hidden">Show all</button>
          </div>
        </div>
        <table class="min-w-full text-sm">
          <thead class="text-left sticky top-0 bg-white dark:bg-gray-900">
            <tr class="border-b border-gray-200 dark:border-gray-800">
              <th class="py-2 pr-3 cursor-pointer select-none" data-key="player" data-default="asc" aria-sort="none">Player <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
              <th class="py-2 pr-3 cursor-pointer select-none" data-key="team" data-default="asc" aria-sort="none">Team <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
              <th class="py-2 pr-3 cursor-pointer select-none" data-key="year" data-default="desc" aria-sort="none">Year <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
              <th class="py-2 pr-3 cursor-pointer select-none" data-key="proj_pick" data-default="asc" aria-sort="none">Proj Pick <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
              <th class="py-2 pr-3 cursor-pointer select-none" data-key="act_pick" data-default="asc" aria-sort="none">Actual Pick <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
              <th class="py-2 pr-3 text-right cursor-pointer select-none" data-key="projected" data-default="desc" aria-sort="none">Projected $ <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
              <th class="py-2 pr-3 text-right cursor-pointer select-none" data-key="actual" data-default="desc" aria-sort="none">Actual $ <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
              <th class="py-2 pr-3 text-right cursor-pointer select-none" data-key="net" data-default="desc" aria-sort="none">NET $ <span class="inline-block ml-1 opacity-0" data-caret>▲</span></th>
            </tr>
          </thead>
          <tbody>
            {% for p in roster %}
            <tr class="border-b border-gray-100 dark:border-gray-800">
              <td class="py-1 pr-3" data-cell="player">{{ p.player }}</td>
              <td class="py-1 pr-3" data-cell="team">{{ p.team or '—' }}</td>
              <td class="py-1 pr-3" data-cell="year" data-sort="{{ p.year }}">{{ p.year }}</td>
              <td class="py-1 pr-3" data-cell="proj_pick" data-sort="{{ p.projected_pick if p.projected_pick is not none else '' }}">
                {% set proj_pick = (
                    (p.projected_pick_raw ~ ' (' ~ p.projected_pick ~ ')')
                    if (p.projected_pick_raw and p.projected_pick is not none)
                    else (p.projected_pick_raw or (p.projected_pick if p.projected_pick is not none else 'Undrafted'))
                ) %}
                {{ proj_pick }}
              </td>
              <td class="py-1 pr-3" data-cell="act_pick" data-sort="{{ p.actual_pick if p.actual_pick is not none else '' }}">
                {% set act_pick = (
                    (p.actual_pick_raw ~ ' (' ~ p.actual_pick ~ ')')
                    if (p.actual_pick_raw and p.actual_pick is not none)
                    else (p.actual_pick_raw or (p.actual_pick if p.actual_pick is not none else 'Undrafted'))
                ) %}
                {{ act_pick }}
              </td>
              <td class="py-1 pr-3 text-right" data-cell="projected" data-sort="{{ p.projected_money }}">{{ p.projected_money|fmt_money }}</td>
              <td class="py-1 pr-3 text-right" data-cell="actual" data-sort="{{ p.actual_money }}">{{ p.actual_money|fmt_money }}</td>
              <td class="py-1 pr-3 text-right {{ p.net|posneg }}" data-cell="net" data-sort="{{ p.net }}">{{ p.net|fmt_money }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
          <div class="text-sm text-gray-500">No players match the current filters.</div>
        {% endif %}
      </div>
    </details>
    {% endfor %}
  </div>
  {% else %}
    <div class="text-sm text-gray-500">Select coaches and click Compare.</div>
  {% endif %}
</div>
<script defer src="{{ url_for('static', filename='js/coach_autocomplete.js') }}?v=2025-09-04"></script>
<script defer src="{{ url_for('static', filename='js/compare_players_table.js') }}"></script>
<script defer src="{{ url_for('static', filename='js/compare_saved_sets.js') }}"></script>
{% endblock %}
