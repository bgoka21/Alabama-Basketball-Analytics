{% extends 'admin/base.html' %}
{% from 'macros/dual_tables.html' import render_dual_section %}
{% from '_macros/percent_box.html' import apply_percent_wrappers %}
{% from '_macros/grade_scale.html' import render_grade_scales_for_specs %}

{% block page_controls %}
<form method="get" class="mb-4 flex flex-wrap items-end gap-4">
  <div>
    <label class="font-semibold mr-2">Season:</label>
    <select name="season" class="border p-2 rounded">
      {% for s in all_seasons %}
        <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>
          {{ s.season_name }}
        </option>
      {% endfor %}
    </select>
  </div>
  {% for key, values in request.args.lists() %}
    {% if key not in ['season', 'start_date', 'end_date'] %}
      {% for v in values %}
        <input type="hidden" name="{{ key }}" value="{{ v }}">
      {% endfor %}
    {% endif %}
  {% endfor %}
  <div class="flex items-center gap-2">
    <label class="text-sm font-medium">Date:</label>
    <input type="date" name="start_date" value="{{ start_date or '' }}" class="border px-2 py-1 text-sm">
    <span class="text-sm">â€“</span>
    <input type="date" name="end_date" value="{{ end_date or '' }}" class="border px-2 py-1 text-sm">
  </div>
  <div>
    <button type="submit" class="bg-[#9E1B32] hover:bg-[#7f1524] text-white px-5 py-2 rounded">Apply</button>
  </div>
  <div>
    <a href="{{ url_for('admin.leaderboard_game') }}" class="text-gray-600 hover:underline text-sm">Clear</a>
  </div>
</form>
{% endblock %}

{% block content %}
<section class="mb-6">
  <h1 class="text-3xl font-bold mb-2">Game Leaderboard</h1>
  <p class="text-sm text-gray-600">Season Totals vs Last Game snapshots for each focus area.</p>
</section>

{% set no_data_message = 'No stats for the most recent game.' %}

<div class="space-y-6">
  {% for group in leaderboard_groups %}
    <details class="bg-white rounded shadow group" open>
      <summary class="flex items-center justify-between px-6 py-4 cursor-pointer select-none">
        <span class="text-lg font-semibold text-gray-900">{{ group.title }}</span>
        <span class="text-sm text-gray-500 transition-transform group-open:-rotate-180">&#9662;</span>
      </summary>
      <div class="border-t border-gray-200 px-6 py-6 space-y-6">
        {% for item in group.items %}
          <div id="{{ item.slug }}" class="space-y-4">
            {% set table = build_dual_table(
              base_columns=columns_for(item.key),
              season_rows=item.season_rows,
              last_rows=item.last_rows,
              season_totals=item.season_totals,
              last_totals=item.last_totals,
              column_map=column_map_for(item.key),
              pct_columns=pct_columns_for(item.key),
              left_label='Season Totals',
              right_label='Last Game',
              totals_label='Team Totals',
              table_id=table_id_for(item.key),
              default_sort=sort_default_for(item.key)
            ) %}
            {% set percent_specs = percent_specs_for(item.key) %}
            {% if percent_specs %}
              {% set _ = apply_percent_wrappers(table, percent_specs) %}
            {% endif %}
            {{ render_dual_section(item.label, table, note_date=item.note_date, empty_message=no_data_message) }}
            {% if percent_specs %}
              {{ render_grade_scales_for_specs(percent_specs) }}
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </details>
  {% endfor %}
</div>
{% endblock %}
