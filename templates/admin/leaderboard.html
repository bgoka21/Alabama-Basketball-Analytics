{% extends 'admin/base.html' %}

{% block page_controls %}
<form method="get" class="mb-4 flex flex-wrap items-end gap-4">
  <div>
    <label class="font-semibold mr-2">Season:</label>
    <select name="season_id" class="border p-2 rounded">
      {% for s in all_seasons %}
        <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>
          {{ s.season_name }}
        </option>
      {% endfor %}
    </select>
  </div>
  {% for key, values in request.args.lists() %}
    {% if key not in ['season_id', 'stat'] %}
      {% for v in values %}
        <input type="hidden" name="{{ key }}" value="{{ v }}">
      {% endfor %}
    {% endif %}
  {% endfor %}
  <input type="hidden" name="stat" value="{{ selected.key }}">
  <div>
    <button type="submit" class="bg-[#9E1B32] hover:bg-[#7f1524] text-white px-5 py-2 rounded">Apply</button>
  </div>
  <div>
    <a href="{{ url_for('admin.leaderboard') }}" class="text-gray-600 hover:underline text-sm">Clear</a>
  </div>
</form>
{% include "_filters_session.html" %}
{% endblock %}

{% block content %}
  <section class="mb-6">
    <h2 class="text-lg font-semibold text-gray-900">Practice Leaderboards</h2>
    <div class="mt-3 flex flex-wrap gap-3 text-sm">
      {% for link in practice_links %}
        {% set endpoint = link.endpoint %}
        {% set params = link.get('params', {}) %}
        {% set href_params = params.copy() %}
        {% if endpoint == 'admin.leaderboard' %}
          {% if selected_season %}
            {% set _ = href_params.update({'season_id': selected_season}) %}
          {% endif %}
          {% if start_date %}
            {% set _ = href_params.update({'start_date': start_date}) %}
          {% endif %}
          {% if end_date %}
            {% set _ = href_params.update({'end_date': end_date}) %}
          {% endif %}
        {% endif %}
        {% set is_active = request.endpoint == endpoint %}
        {% if is_active and params %}
          {% for key, value in params.items() %}
            {% if request.args.get(key) != value %}
              {% set is_active = False %}
            {% endif %}
          {% endfor %}
        {% endif %}
        <a
          class="px-3 py-1 rounded-full border transition {{ 'bg-[#9E1B32] text-white border-[#9E1B32]' if is_active else 'border-gray-300 text-gray-700 hover:bg-white hover:text-[#9E1B32]' }}"
          href="{{ url_for(endpoint, **href_params) }}"
        >
          {{ link.label }}
        </a>
      {% endfor %}
    </div>
  </section>
  <div id="leaderboard-root" data-season-id="{{ season_id or '' }}" class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
    <form id="leaderboard-controls" class="flex flex-col sm:flex-row sm:items-end gap-3">
      <div class="flex flex-col">
        <label for="stat-select" class="block text-sm font-medium text-gray-700">Stat</label>
        <select id="stat-select" name="stat" class="border rounded px-3 py-2">
          {% for key, label in stat_options %}
            <option value="{{ key }}" {% if key == current_stat_key %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
    </form>

    <div id="leaderboard-main" class="mt-4 overflow-x-auto"></div>
    <div id="leaderboard-aux" class="mt-6 hidden overflow-x-auto"></div>

    <script id="initial-leaderboard-payload" type="application/json">
      {{ table_payload | tojson }}
    </script>
    <script id="initial-practice-sections" type="application/json">
      {{ practice_sections | tojson }}
    </script>
  </div>

  <section class="mt-10 text-sm text-gray-600">
    <p>
      Want to build your own practice views? Check out the
      <a class="font-semibold text-[#9E1B32] hover:underline" href="/admin/custom-stats">Custom Stats Table</a>
      to mix and match roster, date, and stat filters on demand.
    </p>
  </section>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/leaderboard-controller.js') }}"></script>
{% endblock %}
