{% extends 'admin/base.html' %}

{% block content %}
  <div class="flex flex-wrap items-start justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-bold">Record Entries</h1>
      <p class="text-sm text-gray-600">Manage record history and current holders. Manual entries are never auto-updated.</p>
    </div>
    <a href="{{ url_for('admin.record_entries_new') }}"
       class="px-4 py-2 bg-[#9E1B32] text-white rounded hover:bg-[#7a1524]">
      New Entry
    </a>
  </div>

  <form method="GET" class="mb-6 rounded border border-gray-200 bg-gray-50 p-4">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Definition</label>
        <select name="definition_id" class="w-full border rounded px-3 py-2">
          <option value="">All definitions</option>
          {% for definition in definitions %}
            <option value="{{ definition.id }}" {% if filters.definition_id == definition.id %}selected{% endif %}>
              {{ definition.name }}{% if not definition.is_active %} (Inactive){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Source</label>
        <select name="source_type" class="w-full border rounded px-3 py-2">
          <option value="">All sources</option>
          {% for option in source_type_options %}
            <option value="{{ option }}" {% if filters.source_type == option %}selected{% endif %}>
              {{ option }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Scope</label>
        <select name="scope" class="w-full border rounded px-3 py-2">
          <option value="">All scopes</option>
          {% for option in scope_options %}
            <option value="{{ option }}" {% if filters.scope == option %}selected{% endif %}>
              {{ option }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="mt-4 flex flex-wrap items-center gap-6">
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" name="current_only" value="1" {% if filters.current_only %}checked{% endif %}>
        Current only
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" name="forced_only" value="1" {% if filters.forced_only %}checked{% endif %}>
        Forced only
      </label>
      <label class="inline-flex items-center gap-2 text-sm">
        <input type="checkbox" name="active_only" value="1" {% if filters.active_only %}checked{% endif %}>
        Active only
      </label>
      <button type="submit" class="px-4 py-2 bg-[#9E1B32] text-white rounded hover:bg-[#7a1524]">Filter</button>
      <a href="{{ url_for('admin.record_entries_list') }}" class="text-sm text-gray-600 hover:underline">Clear</a>
    </div>
  </form>

  <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr class="text-left text-gray-700">
          <th class="px-4 py-3 font-semibold">Definition</th>
          <th class="px-4 py-3 font-semibold">Scope</th>
          <th class="px-4 py-3 font-semibold">Holder</th>
          <th class="px-4 py-3 font-semibold">Value</th>
          <th class="px-4 py-3 font-semibold">Game</th>
          <th class="px-4 py-3 font-semibold">Occurred On</th>
          <th class="px-4 py-3 font-semibold">Season</th>
          <th class="px-4 py-3 font-semibold">Source</th>
          <th class="px-4 py-3 font-semibold">Current</th>
          <th class="px-4 py-3 font-semibold">Forced</th>
          <th class="px-4 py-3 font-semibold">Active</th>
          <th class="px-4 py-3 font-semibold">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for entry in entries %}
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 font-medium text-gray-900">
            <a href="{{ url_for('admin.record_entries_edit', entry_id=entry.id) }}" class="text-[#9E1B32] hover:underline">
              {{ entry.definition.name }}
            </a>
          </td>
          <td class="px-4 py-3">{{ entry.scope }}</td>
          <td class="px-4 py-3">
            {% if entry.holder_entity_type == 'PLAYER' %}
              {{ roster_lookup.get(entry.holder_player_id) or entry.holder_player_name or '—' }}
            {% elif entry.holder_entity_type == 'OPPONENT' %}
              {{ entry.holder_opponent_name or (game_lookup.get(entry.game_id).opponent_name if game_lookup.get(entry.game_id) else 'Unknown Opponent') }}
            {% else %}
              Team
            {% endif %}
          </td>
          <td class="px-4 py-3">{{ entry.value }}</td>
          <td class="px-4 py-3">
            {% if entry.game_id and game_lookup.get(entry.game_id) %}
              {% set game = game_lookup.get(entry.game_id) %}
              <a href="{{ url_for('admin.game_stats', game_id=entry.game_id) }}" class="text-blue-600 hover:underline">
                {{ game.game_date }} vs {{ game.opponent_name }}
              </a>
            {% else %}
              —
            {% endif %}
          </td>
          <td class="px-4 py-3">
            {{ entry.occurred_on or '—' }}
          </td>
          <td class="px-4 py-3">
            {{ entry.season_year or '—' }}
          </td>
          <td class="px-4 py-3">{{ entry.source_type }}</td>
          <td class="px-4 py-3">
            {% if entry.is_current %}
              <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-semibold text-green-700">Yes</span>
            {% else %}
              <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs font-semibold text-gray-700">No</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            {% if entry.is_forced_current %}
              <span class="inline-flex items-center rounded-full bg-amber-100 px-2 py-1 text-xs font-semibold text-amber-700">Forced</span>
            {% else %}
              <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs font-semibold text-gray-700">No</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            {% if entry.is_active %}
              <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs font-semibold text-green-700">Active</span>
            {% else %}
              <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs font-semibold text-gray-700">Inactive</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            <div class="flex flex-wrap items-center gap-3">
              <a href="{{ url_for('admin.record_entries_edit', entry_id=entry.id) }}" class="text-[#9E1B32] font-semibold hover:underline">Edit</a>
              <form method="POST" action="{{ url_for('admin.record_entries_toggle_current', entry_id=entry.id) }}">
                <button type="submit" class="text-sm text-gray-700 hover:text-[#9E1B32]">Toggle Current</button>
              </form>
              <form method="POST" action="{{ url_for('admin.record_entries_toggle_forced', entry_id=entry.id) }}">
                <button type="submit" class="text-sm text-gray-700 hover:text-[#9E1B32]">Toggle Forced</button>
              </form>
              <form method="POST" action="{{ url_for('admin.record_entries_toggle_active', entry_id=entry.id) }}">
                <button type="submit" class="text-sm text-gray-700 hover:text-[#9E1B32]">
                  {% if entry.is_active %}Deactivate{% else %}Activate{% endif %}
                </button>
              </form>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td class="px-4 py-6 text-center text-gray-500" colspan="12">
            No record entries found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}
