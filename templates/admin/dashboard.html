{% extends "admin/base.html" %}
{% from 'macros/table.html' import render_table %}

{% block page_controls %}
<form method="get" class="mb-4 flex items-center gap-2">
  <label class="font-semibold mr-2">Season:</label>
  <select name="season_id" onchange="this.form.submit()" class="border p-2 rounded">
    {% for s in all_seasons %}
      <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>
        {{ s.season_name }}
      </option>
    {% endfor %}
  </select>
</form>
{% endblock %}

{% block content %}
<div class="max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 p-4 sm:p-6 md:p-8">
<h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1>

<!-- Upload Form -->
<form action="{{ url_for('admin.upload_file') }}" method="post" enctype="multipart/form-data" class="mb-6 space-y-4">

  <!-- 1) File input -->
  <div>
    <label for="file" class="block font-semibold mb-1">Upload CSV:</label>
    <input
      type="file"
      name="file"
      multiple
      id="file"
      class="border rounded px-4 py-2 w-full"
    />
  </div>

  <!-- 2) ← Insert your new Date picker here ↓ -->
  <div>
    <label for="file_date" class="block font-semibold mb-1">Date:</label>
    <input
      type="date"
      name="file_date"
      id="file_date"
      class="border rounded px-4 py-2 w-full"
      value="{{ request.form.get('file_date', '') }}"
      required
    />
  </div>



  <!-- 3) Category select -->
  <div>
    <label for="category" class="block font-semibold mb-1">Category:</label>
    <select name="category" id="category" class="border rounded px-4 py-2 w-full">
      <option value="Game">Game</option>
      <option value="Summer Workouts">Summer Workouts</option>
      <option value="Pickup">Pickup</option>
      <option value="Fall Workouts">Fall Workouts</option>
      <option value="Official Practice">Official Practice</option>
      <option value="Recruit">Recruit</option>
    </select>
  </div>

  <!-- Recruit select -->
  <div id="recruit-select" style="display:none;">
    <label for="recruit_id" class="block font-semibold mb-1">Recruit:</label>
    <select name="recruit_id" id="recruit_id" class="border rounded px-4 py-2 w-full">
      {% for r in recruits %}
        <option value="{{ r.id }}">{{ r.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- 4) Hidden season_id -->
  <input type="hidden" name="season_id" value="{{ selected_season }}" />

  <!-- 5) Submit button -->
  <button
    type="submit"
    class="bg-[#9E1B32] text-white px-6 py-2 rounded hover:bg-[#7e1629]"
  >
    Upload
  </button>
</form>


<!-- Display List of Uploaded Files -->
{% set columns = [
  {'key': 'filename', 'label': 'Filename', 'sortable': True, 'align': 'left'},
  {'key': 'category', 'label': 'Category', 'sortable': True, 'align': 'left'},
  {'key': 'status', 'label': 'Status', 'sortable': True, 'align': 'left'},
  {'key': 'last_parsed', 'label': 'Last Parsed', 'sortable': True, 'align': 'left', 'value_key': 'last_parsed_raw'},
  {'key': 'actions', 'label': 'Actions', 'sortable': False, 'align': 'left', 'width': 'w-72'}
] %}

{% set table_rows = namespace(items=[]) %}
{% for f in uploaded_files %}
  {% set last_parsed_display = f.last_parsed if f.last_parsed else 'Not Parsed' %}
  {% set actions %}
    <div class="flex flex-wrap items-center gap-2">
      <form
        action="{{ url_for('admin.parse_file', file_id=f.id) }}"
        method="post"
        class="inline"
      >
        {% if f.category in ['Summer Workouts','Pickup','Fall Workouts','Official Practice'] %}
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
          >
            {% if f.parse_status == 'Parsed Successfully' %}
              View Practice
            {% else %}
              Parse Practice
            {% endif %}
          </button>
        {% else %}
          <button
            type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
          >
            {% if f.parse_status == 'Parsed Successfully' %}
              View Game
            {% else %}
              Parse Game
            {% endif %}
          </button>
        {% endif %}
      </form>
      {% if f.parse_status == 'Parsed Successfully' %}
        <form
          action="{{ url_for('admin.reparse_file', file_id=f.id) }}"
          method="post"
          class="inline"
        >
          <button
            type="submit"
            class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm"
          >
            Re-Parse
          </button>
        </form>
      {% endif %}
      <a
        href="{{ url_for('admin.view_logs', file_id=f.id) }}"
        class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm"
      >
        Logs
      </a>
      <form
        action="{{ url_for('admin.delete_data', file_id=f.id) }}"
        method="post"
        class="inline"
      >
        <button
          type="submit"
          onclick="return confirm('Delete parsed data for this file?')"
          class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm"
        >
          Delete Data
        </button>
      </form>
      <form
        action="{{ url_for('admin.delete_file', file_id=f.id) }}"
        method="post"
        class="inline"
      >
        <button
          type="submit"
          onclick="return confirm('Delete this file?')"
          class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm"
        >
          Delete
        </button>
      </form>
    </div>
  {% endset %}

  {% set table_rows.items = table_rows.items + [{
    'filename': f.filename,
    'category': f.category,
    'status': f.parse_status,
    'last_parsed': last_parsed_display,
    'last_parsed_raw': f.last_parsed if f.last_parsed else '',
    'actions': actions | safe
  }] %}
{% endfor %}

{{ render_table(
  id='admin-uploaded-files',
  columns=columns,
  rows=table_rows.items,
  totals=None,
  dense=True,
  sticky_header=True,
  caption='Uploaded files'
) }}

{% if table_rows.items | length == 0 %}
  <div class="table-empty text-center text-sm text-gray-600 dark:text-gray-300 mt-3">No files uploaded yet.</div>
{% endif %}

</div>
<script>
  const catSel = document.getElementById('category');
  const recDiv = document.getElementById('recruit-select');
  function toggleRecruit() {
    if (catSel.value === 'Recruit') {
      recDiv.style.display = 'block';
    } else {
      recDiv.style.display = 'none';
    }
  }
  catSel.addEventListener('change', toggleRecruit);
  toggleRecruit();
</script>
{% endblock %}
