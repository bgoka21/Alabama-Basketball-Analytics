{% extends "admin/base.html" %}
{% from 'macros/table.html' import render_table %}

{% block page_controls %}
<form method="get" class="mb-4 flex items-center gap-2">
  <label class="font-semibold mr-2">Season:</label>
  <select name="season_id" onchange="this.form.submit()" class="border p-2 rounded">
    {% for s in all_seasons %}
      <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>
        {{ s.season_name }}
      </option>
    {% endfor %}
  </select>
</form>
{% endblock %}

{% block content %}
<div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 md:py-8 space-y-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
      <p class="text-sm text-gray-600">Upload CSVs and manage recently processed files.</p>
    </div>
    <div class="inline-flex items-center gap-2 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700">
      <span class="inline-flex h-2 w-2 rounded-full bg-green-500"></span>
      <span>Signed in as Admin</span>
    </div>
  </div>

  <!-- Upload Form -->
  <section class="bg-white border border-gray-200 rounded-xl shadow-sm p-4 sm:p-6">
    <div class="flex items-center justify-between gap-4 flex-wrap mb-4">
      <div>
        <h2 class="text-xl font-semibold text-gray-900">Upload CSV</h2>
        <p class="text-sm text-gray-600">Attach one or more CSVs, pick the date, and choose the correct category.</p>
      </div>
      <button
        type="submit"
        form="upload-form"
        class="inline-flex items-center gap-2 bg-[#9E1B32] text-white px-4 py-2 rounded-lg font-semibold shadow-sm hover:bg-[#7e1629] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[#9E1B32]"
      >
        Upload Files
      </button>
    </div>

    <form
      id="upload-form"
      action="{{ url_for('admin.upload_file') }}"
      method="post"
      enctype="multipart/form-data"
      class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6"
    >
      <div class="col-span-1 md:col-span-2">
        <label for="file" class="block font-semibold text-gray-800 mb-1">Upload CSV</label>
        <input
          type="file"
          name="file"
          multiple
          id="file"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-[#9E1B32] focus:border-[#9E1B32]"
        />
        <p class="text-xs text-gray-500 mt-1">You can select multiple CSV files at once.</p>
      </div>

      <div>
        <label for="file_date" class="block font-semibold text-gray-800 mb-1">Date</label>
        <input
          type="date"
          name="file_date"
          id="file_date"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-[#9E1B32] focus:border-[#9E1B32]"
          value="{{ request.form.get('file_date', '') }}"
          required
        />
      </div>

      <div>
        <label for="category" class="block font-semibold text-gray-800 mb-1">Category</label>
        <select
          name="category"
          id="category"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-[#9E1B32] focus:border-[#9E1B32]"
        >
          <option value="Game">Game</option>
          <option value="Summer Workouts">Summer Workouts</option>
          <option value="Pickup">Pickup</option>
          <option value="Fall Workouts">Fall Workouts</option>
          <option value="Official Practice">Official Practice</option>
          <option value="Recruit">Recruit</option>
        </select>
      </div>

      <div id="recruit-select" class="hidden md:col-span-2">
        <label for="recruit_id" class="block font-semibold text-gray-800 mb-1">Recruit</label>
        <select
          name="recruit_id"
          id="recruit_id"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-[#9E1B32] focus:border-[#9E1B32]"
        >
          {% for r in recruits %}
            <option value="{{ r.id }}">{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>

      <input type="hidden" name="season_id" value="{{ selected_season }}" />
    </form>
  </section>

  <!-- Display List of Uploaded Files -->
  {% set columns = [
    {'key': 'filename', 'label': 'Filename', 'sortable': True, 'align': 'left', 'width': 'w-2/5'},
    {'key': 'category', 'label': 'Category', 'sortable': True, 'align': 'left', 'width': 'w-1/6'},
    {'key': 'status', 'label': 'Status', 'sortable': True, 'align': 'left', 'width': 'w-1/6'},
    {'key': 'last_parsed', 'label': 'Last Parsed', 'sortable': True, 'align': 'left', 'value_key': 'last_parsed_raw', 'width': 'w-1/6'},
    {'key': 'actions', 'label': 'Actions', 'sortable': False, 'align': 'left', 'width': 'w-64'}
  ] %}

  {% set table_rows = namespace(items=[]) %}
  {% for f in uploaded_files %}
    {% set last_parsed_display = f.last_parsed if f.last_parsed else 'Not Parsed' %}
    {% set category_color = 'bg-blue-50 text-blue-800 border border-blue-200' if f.category == 'Game' else 'bg-amber-50 text-amber-800 border border-amber-200' %}
    {% set status_color = 'bg-emerald-50 text-emerald-800 border border-emerald-200' if f.parse_status == 'Parsed Successfully' else 'bg-gray-100 text-gray-800 border border-gray-200' %}

    {% set filename_cell %}
      <div class="font-semibold text-gray-900 leading-snug break-words">{{ f.filename }}</div>
      <div class="text-xs text-gray-500 mt-1">Uploaded category: {{ f.category }}</div>
    {% endset %}

    {% set category_badge %}
      <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full {{ category_color }}">{{ f.category }}</span>
    {% endset %}

    {% set status_badge %}
      <span class="inline-flex items-center px-2.5 py-1 text-xs font-semibold rounded-full {{ status_color }}">{{ f.parse_status }}</span>
    {% endset %}

    {% set last_parsed_cell %}
      <div class="text-sm text-gray-900 font-medium">{{ last_parsed_display }}</div>
      <div class="text-xs text-gray-500">{{ 'Updated' if f.last_parsed else 'Waiting to parse' }}</div>
    {% endset %}

    {% set actions %}
      <div class="flex flex-wrap items-center gap-2 text-sm">
        <form
          action="{{ url_for('admin.parse_file', file_id=f.id) }}"
          method="post"
          class="inline"
        >
          {% if f.category in ['Summer Workouts','Pickup','Fall Workouts','Official Practice'] %}
            <button
              type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md shadow-sm"
            >
              {% if f.parse_status == 'Parsed Successfully' %}
                View Practice
              {% else %}
                Parse Practice
              {% endif %}
            </button>
          {% else %}
            <button
              type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md shadow-sm"
            >
              {% if f.parse_status == 'Parsed Successfully' %}
                View Game
              {% else %}
                Parse Game
              {% endif %}
            </button>
          {% endif %}
        </form>
        {% if f.parse_status == 'Parsed Successfully' %}
          <form
            action="{{ url_for('admin.reparse_file', file_id=f.id) }}"
            method="post"
            class="inline"
          >
            <button
              type="submit"
              class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-md shadow-sm"
            >
              Re-Parse
            </button>
          </form>
        {% endif %}
        <a
          href="{{ url_for('admin.view_logs', file_id=f.id) }}"
          class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1.5 rounded-md shadow-sm"
        >
          Logs
        </a>
        <form
          method="post"
          action="{{ url_for('admin.delete_data', file_id=f.id) }}"
          class="inline"
          onsubmit="return confirm('This will delete data. Continue?')"
        >
          {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}
          <button
            type="submit"
            class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded-md shadow-sm"
          >
            Delete Data
          </button>
        </form>
        <form
          action="{{ url_for('admin.delete_file', file_id=f.id) }}"
          method="post"
          class="inline"
        >
          <button
            type="submit"
            onclick="return confirm('Delete this file?')"
            class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-md shadow-sm"
          >
            Delete
          </button>
        </form>
      </div>
    {% endset %}

    {% set table_rows.items = table_rows.items + [{
      'filename': filename_cell | safe,
      'category': category_badge | safe,
      'status': status_badge | safe,
      'last_parsed': last_parsed_cell | safe,
      'last_parsed_raw': f.last_parsed if f.last_parsed else '',
      'actions': actions | safe
    }] %}
  {% endfor %}

  <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-3">
    {{ render_table(
      id='admin-uploaded-files',
      columns=columns,
      rows=table_rows.items,
      totals=None,
      dense=True,
      sticky_header=True,
      caption='Uploaded files',
    ) }}
    {% if table_rows.items | length == 0 %}
      <div class="table-empty text-center text-sm text-gray-600 dark:text-gray-300 mt-3">No files uploaded yet.</div>
    {% endif %}
  </div>

</div>
<script>
  const catSel = document.getElementById('category');
  const recDiv = document.getElementById('recruit-select');
  function toggleRecruit() {
    if (catSel.value === 'Recruit') {
      recDiv.classList.remove('hidden');
      recDiv.classList.add('md:col-span-2');
    } else {
      recDiv.classList.add('hidden');
      recDiv.classList.remove('md:col-span-2');
    }
  }
  catSel.addEventListener('change', toggleRecruit);
  toggleRecruit();
</script>
{% endblock %}
