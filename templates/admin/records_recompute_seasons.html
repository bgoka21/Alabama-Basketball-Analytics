{% extends 'admin/base.html' %}

{% block content %}
  <div class="flex items-start justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold">Recompute Season Records</h1>
      <p class="text-sm text-gray-600">Backfill auto record entries for a season total.</p>
    </div>
  </div>

  <form method="POST" action="{{ url_for('admin.records_recompute_seasons') }}" class="space-y-6">
    <div class="grid gap-4 md:grid-cols-2">
      <div>
        <label class="block text-sm font-semibold text-gray-700" for="season_id">Season</label>
        <select
          class="mt-1 w-full rounded border border-gray-300 px-3 py-2"
          id="season_id"
          name="season_id"
          required
        >
          <option value="" disabled {% if not form_data.season_id %}selected{% endif %}>Select a season</option>
          {% for season in seasons %}
            <option value="{{ season.id }}" {% if form_data.season_id|int == season.id %}selected{% endif %}>
              {{ season.season_name }} (ID {{ season.id }})
            </option>
          {% endfor %}
        </select>
        {% if errors.season_id %}
          <p class="mt-1 text-sm text-red-600">{{ errors.season_id }}</p>
        {% endif %}
      </div>
      <div class="space-y-2">
        <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
          <input
            type="checkbox"
            name="include_inactive_definitions"
            {% if form_data.include_inactive_definitions %}checked{% endif %}
          />
          Include inactive definitions
        </label>
        <label class="flex items-center gap-2 text-sm font-semibold text-gray-700">
          <input type="checkbox" name="dry_run" {% if form_data.dry_run %}checked{% endif %} />
          Dry run (no database writes)
        </label>
      </div>
    </div>

    <button type="submit" class="px-4 py-2 bg-[#9E1B32] text-white rounded hover:bg-[#7a1524]">
      Run recompute
    </button>
  </form>

  {% if results %}
    <div class="mt-8 rounded-lg border border-gray-200 bg-white p-6 shadow-sm space-y-6">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Results summary</h2>
        <p class="text-sm text-gray-600">
          Season: {{ results.season.season_name if results.season else results.season_id }}
        </p>
        <p class="text-sm text-gray-600">
          Candidates built: {{ results.candidates_built }}
        </p>
        <p class="text-sm text-gray-600">
          Dry run: {{ "Yes" if results.dry_run else "No" }}
          {% if results.include_inactive_definitions %}
            Â· Included inactive definitions
          {% endif %}
        </p>
      </div>

      <div class="rounded border border-gray-200 p-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">Totals</h3>
        <ul class="space-y-1 text-sm text-gray-600">
          <li>Definitions evaluated: {{ results.totals.definitions_evaluated }}</li>
          <li>Candidates evaluated: {{ results.totals.candidates_evaluated }}</li>
          <li>Auto entries created: {{ results.totals.auto_created }}</li>
          <li>Auto entries updated: {{ results.totals.auto_updated }}</li>
          <li>Definitions with current changes: {{ results.totals.definitions_with_current_changes }}</li>
        </ul>
      </div>
    </div>
  {% endif %}
{% endblock %}
