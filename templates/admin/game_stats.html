<!-- admin/game_stats.html -->
{% extends 'admin/base.html' %}

{% block content %}
  <div class="max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 p-4 sm:p-6 md:p-8">
  <h1 class="text-2xl font-bold mb-4">Game Stats</h1>

  <!-- Tab Buttons -->
  <div class="flex space-x-4 mb-6">
    <button id="offenseBtn" class="px-4 py-2 rounded bg-[#9E1B32] text-white">Offense</button>
    <button id="defenseBtn" class="px-4 py-2 rounded bg-gray-200 text-gray-700">Defense</button>
    <button id="lineupBtn" class="px-4 py-2 rounded bg-gray-200 text-gray-700">Lineup Efficiency</button>
  </div>

  <!-- OFFENSE TAB -->
  <div id="offenseContent">
<!-- Offense Cards Redesigned -->
<div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
  <!-- Shooting Splits -->
  {% set total_shots = team_stats.total_atr_attempts + team_stats.total_fg2_attempts + team_stats.total_fg3_attempts %}
    {% for label, makes, attempts, extra in [
          ('ATR', team_stats.total_atr_makes, team_stats.total_atr_attempts, total_shots),
          ('2FG', team_stats.total_fg2_makes, team_stats.total_fg2_attempts, total_shots),
          ('3FG', team_stats.total_fg3_makes, team_stats.total_fg3_attempts, total_shots),
          ('FT',  team_stats.total_ftm,      team_stats.total_fta,      None)
      ] %}
  <div class="bg-white dark:bg-gray-800 p-5 shadow-lg rounded-lg border-l-4 border-[#9E1B32]">
    <div class="text-xs font-semibold uppercase text-gray-500">{{ label }}</div>
    <div class="text-3xl font-extrabold mt-1">
      {% if attempts > 0 %}{{ (makes/attempts*100)|round(1) }}%{% else %}0.0%{% endif %}
    </div>
    {% if extra is not none %}
    <div class="text-sm text-gray-400 mt-1">
      {% if extra > 0 %}{{ (attempts/extra*100)|round(1) }}%{% else %}0.0%{% endif %}
    </div>
    {% endif %}
    <div class="text-xs text-gray-600 mt-2">{{ makes }}–{{ attempts }}</div>
  </div>
  {% endfor %}

  <!-- Efficiency & Secondary Metrics -->
  {% for label, value in [
      ('Assist %',     team_stats.assist_pct),
      ('TO %',         team_stats.turnover_pct),
      ('TCR',          team_stats.tcr_pct),
      ('FT Rate',      team_stats.ft_rate),
      ('OREB %',       team_stats.oreb_pct),
      ('Good Shot %',  team_stats.good_shot_pct)
  ] %}
  <div class="bg-white dark:bg-gray-800 p-5 shadow-lg rounded-lg border-l-4 border-[#9E1B32]">
    <div class="text-xs font-semibold uppercase text-gray-500">{{ label }}</div>
    <div class="text-3xl font-extrabold mt-1">{{ value }}%</div>
  </div>
  {% endfor %}

  <!-- PPP -->
  <div class="bg-white dark:bg-gray-800 p-5 shadow-lg rounded-lg border-l-4 border-[#9E1B32]">
    <div class="text-xs font-semibold uppercase text-gray-500">PPP</div>
    <div class="text-3xl font-extrabold mt-1">
      {% if team_stats.total_possessions|int>0 %}
        {{ (team_stats.total_points|int/team_stats.total_possessions|int)|round(2) }}
      {% else %}0.00{% endif %}
    </div>
    <div class="text-xs text-gray-600 mt-2">{{ team_stats.total_possessions }} poss</div>
  </div>
</div>


    

      <!-- Playmaking & Efficiency (Alabama Only) -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Playmaking &amp; Efficiency</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse">
            <thead class="bg-white dark:bg-gray-800 border-b-2 border-[#9E1B32]">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Stat</th>
                <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Alabama</th>
              </tr>
            </thead>
            <tbody>
              {% for stat, attr in [
                ('Assists','total_assists'),
                ('Turnovers','total_turnovers'),
                ('Second Assists','total_second_assists'),
                ('Potential Assists','total_pot_assists'),
                ('Possessions','total_possessions')
              ] %}
              <tr class="odd:bg-white even:bg-gray-100">
                <td class="px-6 py-4">{{ stat }}</td>
                <td class="px-6 py-4 text-center">{{ team_stats[attr] or 0 }}</td>
              </tr>
              {% endfor %}
              <tr class="odd:bg-white even:bg-gray-100">
                <td class="px-6 py-4">Points Per Possession (PPP)</td>
                <td class="px-6 py-4 text-center">
                  {% if team_stats.total_possessions|int > 0 %}
                    {{ (team_stats.total_points|int / team_stats.total_possessions|int)|round(2) }}
                  {% else %}0.00{% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Blue Collar Stats (Alabama Only) -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Blue Collar Stats</h2>
        <div>
          <h3 class="text-md font-semibold mb-2">Alabama Blue Collar Stats</h3>
          <p class="mb-2"><strong>Total:</strong> {{ team_stats.total_blue_collar or 0 }}</p>
          {% if blue_collar_stats %}
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse mb-4">
              <thead class="bg-white border-b-2 border-[#9E1B32]">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium uppercase">Category</th>
                  <th class="px-4 py-2 text-center text-xs font-medium uppercase">Total</th>
                </tr>
              </thead>
              <tbody>
                {% for label, value in [
                  ('Def Reb', blue_collar_stats.def_reb),
                  ('Off Reb', blue_collar_stats.off_reb),
                  ('Misc', blue_collar_stats.misc),
                  ('Deflection', blue_collar_stats.deflection),
                  ('Steal', blue_collar_stats.steal),
                  ('Block', blue_collar_stats.block),
                  ('Floor Dive', blue_collar_stats.floor_dive),
                  ('Charge Taken', blue_collar_stats.charge_taken),
                  ('Reb Tip', blue_collar_stats.reb_tip)
                ] %}
                <tr class="odd:bg-white even:bg-gray-100">
                  <td class="px-4 py-2">{{ label }}</td>
                  <td class="px-4 py-2 text-center">{{ value or 0 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p>No detailed breakdown available.</p>
          {% endif %}
        </div>
      </div>

      <!-- Possession Breakdown (Offense Only) -->
      <div class="mb-10">
        <h2 class="text-2xl font-semibold mb-4">Possession Breakdown</h2>
        <div>
          <h3 class="text-xl font-semibold mb-2">Offense</h3>
          <div class="overflow-x-auto">
          <table class="w-full table-auto border-collapse mb-4">
            <thead class="bg-white border-b-2 border-[#9E1B32]">
              <tr>
                <th class="text-left py-2 px-4">Type</th>
                <th class="text-center py-2 px-4">PTS</th>
                <th class="text-center py-2 px-4">Poss</th>
                <th class="text-center py-2 px-4">PPC</th>
              </tr>
            </thead>
            <tbody>
              {% for token, stats in offensive_breakdown.items() %}
              <tr class="odd:bg-white even:bg-gray-100 {% if token=='OREB Putback' %}border-t-2 border-[#9E1B32]{% endif %}">
                <td class="font-bold py-2 pl-4">{{ token }}</td>
                <td class="text-center py-2">{{ stats.points }}</td>
                <td class="text-center py-2">{{ stats.count }}</td>
                <td class="text-center py-2 font-bold">
                  {{ '%.2f' % (stats.points / stats.count if stats.count else 0) }}
                </td>
              </tr>
              {% endfor %}
              <tr class="h-0"><td colspan="4" class="p-0"><div class="h-[2px] bg-[#9E1B32]"></div></td></tr>
              {% for label in ['1st Half','2nd Half','Overtime'] %}
                {% set s = periodic_offense[label] %}
                <tr class="font-bold odd:bg-white even:bg-gray-100">
                  <td class="py-2 pl-4">{{ label }}</td>
                  <td class="text-center py-2">{{ s.points }}</td>
                  <td class="text-center py-2">{{ s.count }}</td>
                  <td class="text-center py-2 font-bold">
                    {{ '%.2f' % (s.points / s.count if s.count else 0) }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
        </div>
      </div>

      <div class="mb-10">
        <h2 class="text-2xl font-semibold mb-4">Situational Offense</h2>
        <div class="grid gap-6 md:grid-cols-2">
          {% for title, rows in [
            ('Shot Clock', shot_clock_offense),
            ('Possession Start', possession_start_offense),
            ('Paint Touches', paint_touches_offense),
            ("1st Paint Touch", shot_clock_pt_offense)
          ] %}
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-2">{{ title }}</h3>
            <div class="overflow-x-auto">
              <table class="w-full table-auto border-collapse">
                <thead class="bg-white border-b-2 border-[#9E1B32]">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Bucket</th>
                    <th class="px-3 py-2 text-center text-xs font-medium uppercase">PTS</th>
                    <th class="px-3 py-2 text-center text-xs font-medium uppercase">Poss</th>
                    <th class="px-3 py-2 text-center text-xs font-medium uppercase">PPC</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in rows %}
                  <tr class="odd:bg-white even:bg-gray-100">
                    <td class="px-3 py-2">{{ row.label }}</td>
                    <td class="px-3 py-2 text-center">{{ row.points }}</td>
                    <td class="px-3 py-2 text-center">{{ row.possessions }}</td>
                    <td class="px-3 py-2 text-center font-semibold">{{ '%.2f'|format(row.ppc) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

  </div>
        
      
      

  <!-- DEFENSE TAB -->
  <div id="defenseContent" class="hidden">
<!-- Defense Cards Redesigned (matching Offense order) -->
<div class="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
  <!-- Opponent Shooting Splits -->
  {% set opp_total_shots = opponent_stats.total_atr_attempts
                         + opponent_stats.total_fg2_attempts
                         + opponent_stats.total_fg3_attempts %}
  {% for label, makes, attempts, extra in [
        ('ATR', opponent_stats.total_atr_makes, opponent_stats.total_atr_attempts, opp_total_shots),
        ('2FG', opponent_stats.total_fg2_makes, opponent_stats.total_fg2_attempts, opp_total_shots),
        ('3FG', opponent_stats.total_fg3_makes, opponent_stats.total_fg3_attempts, opp_total_shots),
        ('FT',  opponent_stats.total_ftm,      opponent_stats.total_fta,      None)
  ] %}
    <div class="bg-white dark:bg-gray-800 p-5 shadow-lg rounded-lg border-l-4 border-[#9E1B32]">
      <div class="text-xs font-semibold uppercase text-gray-500">{{ label }}</div>
      <div class="text-3xl font-extrabold mt-1">
        {% if attempts > 0 %}{{ (makes/attempts*100)|round(1) }}%{% else %}0.0%{% endif %}
      </div>
      {% if extra is not none %}
        <div class="text-sm text-gray-400 mt-1">
          {% if extra > 0 %}{{ (attempts/extra*100)|round(1) }}%{% else %}0.0%{% endif %}
        </div>
      {% endif %}
      <div class="text-xs text-gray-600 mt-2">{{ makes }}–{{ attempts }}</div>
    </div>
  {% endfor %}

  <!-- Mirror Offense order: Assist, TO, TCR, FT Rate, then OREB, Good Shot -->
  {% for label, value in [
        ('Assist %',    opp_assist_pct),
        ('TO %',        opp_turnover_pct),
        ('TCR',         opp_tcr_pct),
        ('FT Rate',     opp_ft_rate),
        ('OREB %',      opp_oreb_pct),
        ('Good Shot %', opp_good_shot_pct)
  ] %}
    <div class="bg-white dark:bg-gray-800 p-5 shadow-lg rounded-lg border-l-4 border-[#9E1B32]">
      <div class="text-xs font-semibold uppercase text-gray-500">{{ label }} Allowed</div>
      <div class="text-3xl font-extrabold mt-1">{{ value }}%</div>
    </div>
  {% endfor %}

  <!-- PPP Allowed last -->
  <div class="bg-white dark:bg-gray-800 p-5 shadow-lg rounded-lg border-l-4 border-[#9E1B32]">
    <div class="text-xs font-semibold uppercase text-gray-500">PPP Allowed</div>
    <div class="text-3xl font-extrabold mt-1">{{ opp_ppp }}</div>
    <div class="text-xs text-gray-600 mt-2">{{ opponent_stats.total_possessions }} poss</div>
  </div>
</div>

      

      <!-- Playmaking & Efficiency (Opponent Only) -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Playmaking &amp; Efficiency</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full table-auto border-collapse">
            <thead class="bg-white dark:bg-gray-800 border-b-2 border-[#9E1B32]">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Stat</th>
                <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">{{ game.opponent_name }}</th>
              </tr>
            </thead>
            <tbody>
              {% for stat, attr in [
                ('Assists','total_assists'),
                ('Turnovers','total_turnovers'),
                ('Second Assists','total_second_assists'),
                ('Potential Assists','total_pot_assists'),
                ('Possessions','total_possessions')
              ] %}
              <tr class="odd:bg-white even:bg-gray-100">
                <td class="px-6 py-4">{{ stat }}</td>
                <td class="px-6 py-4 text-center">{{ opponent_stats[attr] or 0 }}</td>
              </tr>
              {% endfor %}
              <tr class="odd:bg-white even:bg-gray-100">
                <td class="px-6 py-4">Points Per Possession (PPP)</td>
                <td class="px-6 py-4 text-center">
                  {% if opponent_stats.total_possessions|int > 0 %}
                    {{ (opponent_stats.total_points|int / opponent_stats.total_possessions|int)|round(2) }}
                  {% else %}0.00{% endif %}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Blue Collar Stats (Opponent Only) -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold mb-4">Blue Collar Stats</h2>
        <div>
          <h3 class="text-md font-semibold mb-2">{{ game.opponent_name }} Blue Collar Stats</h3>
          <p class="mb-2"><strong>Total:</strong> {{ opponent_stats.total_blue_collar or 0 }}</p>
          {% if opponent_blue_coll_stats %}
          <div class="overflow-x-auto">
            <table class="min-w-full table-auto border-collapse">
              <thead class="bg-white border-b-2 border-[#9E1B32]">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium uppercase">Category</th>
                  <th class="px-4 py-2 text-center text-xs font-medium uppercase">Total</th>
                </tr>
              </thead>
              <tbody>
                {% for label, value in [
                  ('Def Reb', opponent_blue_coll_stats.def_reb),
                  ('Off Reb', opponent_blue_coll_stats.off_reb),
                  ('Misc', opponent_blue_coll_stats.misc),
                  ('Deflection', opponent_blue_coll_stats.deflection),
                  ('Steal', opponent_blue_coll_stats.steal),
                  ('Block', opponent_blue_coll_stats.block),
                  ('Floor Dive', opponent_blue_coll_stats.floor_dive),
                  ('Charge Taken', opponent_blue_coll_stats.charge_taken),
                  ('Reb Tip', opponent_blue_coll_stats.reb_tip)
                ] %}
                <tr class="odd:bg-white even:bg-gray-100">
                  <td class="px-4 py-2">{{ label }}</td>
                  <td class="px-4 py-2 text-center">{{ value or 0 }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p>No detailed breakdown available.</p>
          {% endif %}
        </div>
      </div>

      <!-- Possession Breakdown (Defense Only) -->
      <div class="mb-10">
        <h2 class="text-2xl font-semibold mb-4">Possession Breakdown</h2>
        <div>
          <h3 class="text-xl font-semibold mb-2">Defense</h3>
          <div class="overflow-x-auto">
          <table class="w-full table-auto border-collapse">
            <thead class="bg-white border-b-2 border-[#9E1B32]">
              <tr>
                <th class="text-left py-2 px-4">Type</th>
                <th class="text-center py-2 px-4">PTS</th>
                <th class="text-center py-2 px-4">Poss</th>
                <th class="text-center py-2 px-4">PPC</th>
              </tr>
            </thead>
            <tbody>
              {% for token, stats in defensive_breakdown.items() %}
              <tr class="odd:bg-white even:bg-gray-100 {% if token=='OREB Putback' %}border-t-2 border-[#9E1B32]{% endif %}">
                <td class="font-bold py-2 pl-4">{{ token }}</td>
                <td class="text-center py-2">{{ stats.points }}</td>
                <td class="text-center py-2">{{ stats.count }}</td>
                <td class="text-center py-2 font-bold">
                  {{ '%.2f' % (stats.points / stats.count if stats.count else 0) }}
                </td>
              </tr>
              {% endfor %}
              <tr class="h-0"><td colspan="4" class="p-0"><div class="h-[2px] bg-[#9E1B32]"></div></td></tr>
              {% for label in ['1st Half','2nd Half','Overtime'] %}
                {% set s = periodic_defense[label] %}
                <tr class="font-bold odd:bg-white even:bg-gray-100">
                  <td class="py-2 pl-4">{{ label }}</td>
                  <td class="text-center py-2">{{ s.points }}</td>
                  <td class="text-center py-2">{{ s.count }}</td>
                  <td class="text-center py-2 font-bold">
                    {{ '%.2f' % (s.points / s.count if s.count else 0) }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          </div>
        </div>
      </div>

      <div class="mb-10">
        <h2 class="text-2xl font-semibold mb-4">Situational Defense</h2>
        <div class="grid gap-6 md:grid-cols-2">
          {% for title, rows in [
            ('Shot Clock', shot_clock_defense),
            ('Possession Start', possession_start_defense),
            ('Paint Touches', paint_touches_defense),
            ("1st Paint Touch", shot_clock_pt_defense)
          ] %}
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold mb-2">{{ title }}</h3>
            <div class="overflow-x-auto">
              <table class="w-full table-auto border-collapse">
                <thead class="bg-white border-b-2 border-[#9E1B32]">
                  <tr>
                    <th class="px-3 py-2 text-left text-xs font-medium uppercase">Bucket</th>
                    <th class="px-3 py-2 text-center text-xs font-medium uppercase">PTS</th>
                    <th class="px-3 py-2 text-center text-xs font-medium uppercase">Poss</th>
                    <th class="px-3 py-2 text-center text-xs font-medium uppercase">PPC</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in rows %}
                  <tr class="odd:bg-white even:bg-gray-100">
                    <td class="px-3 py-2">{{ row.label }}</td>
                    <td class="px-3 py-2 text-center">{{ row.points }}</td>
                    <td class="px-3 py-2 text-center">{{ row.possessions }}</td>
                    <td class="px-3 py-2 text-center font-semibold">{{ '%.2f'|format(row.ppc) }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

  </div>

  <!-- LINEUP EFFICIENCY TAB -->
  <div id="lineupContent" class="hidden">
    {% set lineup_sizes = (most_used_lineups_offense.keys()|list + best_offense.keys()|list + best_defense.keys()|list)|unique|sort %}
    <div class="mt-6 space-y-6">
      <div class="bg-white shadow rounded-lg p-4 sm:p-6">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg sm:text-xl font-semibold">Lineup Efficiency</h2>
            <p class="text-sm text-gray-500">
              Showing lineups with at least {{ lineup_min_poss }} possessions
              {% if lineup_player %}
                • Filtered to: <span class="font-semibold text-gray-700">{{ lineup_player }}</span>
              {% endif %}
            </p>
          </div>
          <form method="get" class="flex flex-wrap items-end gap-2 text-sm">
            {% for key, value in request.args.items() %}
              {% if key not in ['lineup_min_poss', 'lineup_player'] %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
              {% endif %}
            {% endfor %}
            <div class="flex flex-col">
              <label for="lineupMinPoss" class="font-medium text-gray-700">Minimum Possessions</label>
              <input
                id="lineupMinPoss"
                type="number"
                name="lineup_min_poss"
                min="0"
                value="{{ lineup_min_poss }}"
                class="rounded border-gray-300 text-sm"
              />
            </div>
            <div class="flex flex-col">
              <label for="lineupPlayer" class="font-medium text-gray-700">Player</label>
              <select id="lineupPlayer" name="lineup_player" class="rounded border-gray-300 text-sm" onchange="this.form.submit()">
                <option value="">All Players</option>
                {% for player in lineup_players %}
                  <option value="{{ player }}" {% if lineup_player == player %}selected{% endif %}>{{ player }}</option>
                {% endfor %}
              </select>
            </div>
            <noscript>
              <button type="submit" class="px-3 py-1 text-sm font-medium rounded bg-gray-200">Apply</button>
            </noscript>
          </form>
        </div>
        <div class="flex flex-wrap gap-2 mt-4">
          {% for size in lineup_sizes %}
            {% set has_size_data = most_used_lineups_offense.get(size, []) or most_used_lineups_defense.get(size, []) or best_offense.get(size, []) or worst_offense.get(size, []) or best_defense.get(size, []) or worst_defense.get(size, []) %}
            <button type="button"
                    class="lineup-size-btn px-4 py-2 text-sm font-medium rounded-lg focus:outline-none bg-gray-100 text-gray-700"
                    data-size="{{ size }}"
                    data-has-data="{{ 'true' if has_size_data else 'false' }}">
              {{ size }}-Man
            </button>
          {% endfor %}
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white shadow rounded-lg p-4">
          <h3 class="text-base font-semibold mb-3">Most Used</h3>
          {% for size in lineup_sizes %}
            {% set used_offense = most_used_lineups_offense.get(size, []) %}
            {% set used_defense = most_used_lineups_defense.get(size, []) %}
            <div class="lineup-size-panel hidden" data-size="{{ size }}">
              <h4 class="text-sm font-semibold mb-3">{{ size }}-Man Lineups</h4>
              {% if not used_offense and not used_defense %}
                <p class="italic text-center text-gray-500">
                  No {{ size }}-Man lineup data available for this game.
                </p>
              {% else %}
                <h5 class="font-semibold mb-2">Offense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-auto border-collapse mb-4">
                    <thead class="bg-white border-b-2" style="border-color:#9E1B32;">
                      <tr>
                        <th class="px-4 py-2 text-left">Lineup</th>
                        <th class="px-4 py-2 text-right">Possessions</th>
                        <th class="px-4 py-2 text-right">PPP</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, poss, ppp in used_offense %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2">{{ combo|replace(',', ', ') }}</td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <h5 class="font-semibold mb-2">Defense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-auto border-collapse">
                    <thead class="bg-white border-b-2" style="border-color:#9E1B32;">
                      <tr>
                        <th class="px-4 py-2 text-left">Lineup</th>
                        <th class="px-4 py-2 text-right">Possessions</th>
                        <th class="px-4 py-2 text-right">PPP</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, poss, ppp in used_defense %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2">{{ combo|replace(',', ', ') }}</td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <div class="bg-white shadow rounded-lg p-4">
          <h3 class="text-base font-semibold mb-3">Best/Worst Offense</h3>
          {% for size in lineup_sizes %}
            {% set best_offense_rows = best_offense.get(size, []) %}
            {% set worst_offense_rows = worst_offense.get(size, []) %}
            <div class="lineup-size-panel hidden" data-size="{{ size }}">
              <h4 class="text-sm font-semibold mb-3">{{ size }}-Man Offense</h4>
              {% if not best_offense_rows and not worst_offense_rows %}
                <p class="italic text-center text-gray-500">
                  No {{ size }}-Man lineup data available for this game.
                </p>
              {% else %}
                <h5 class="font-semibold mb-2">Best Offense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-auto border-collapse mb-4">
                    <thead class="bg-white border-b-2" style="border-color:#9E1B32;">
                      <tr>
                        <th class="px-4 py-2 text-left">Lineup</th>
                        <th class="px-4 py-2 text-right">PPP</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp in best_offense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2">{{ combo|replace(',', ', ') }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <h5 class="font-semibold mb-2">Worst Offense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-auto border-collapse">
                    <thead class="bg-white border-b-2" style="border-color:#9E1B32;">
                      <tr>
                        <th class="px-4 py-2 text-left">Lineup</th>
                        <th class="px-4 py-2 text-right">PPP</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp in worst_offense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2">{{ combo|replace(',', ', ') }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <div class="bg-white shadow rounded-lg p-4">
          <h3 class="text-base font-semibold mb-3">Best/Worst Defense</h3>
          {% for size in lineup_sizes %}
            {% set best_defense_rows = best_defense.get(size, []) %}
            {% set worst_defense_rows = worst_defense.get(size, []) %}
            <div class="lineup-size-panel hidden" data-size="{{ size }}">
              <h4 class="text-sm font-semibold mb-3">{{ size }}-Man Defense</h4>
              {% if not best_defense_rows and not worst_defense_rows %}
                <p class="italic text-center text-gray-500">
                  No {{ size }}-Man lineup data available for this game.
                </p>
              {% else %}
                <h5 class="font-semibold mb-2">Best Defense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-auto border-collapse mb-4">
                    <thead class="bg-white border-b-2" style="border-color:#9E1B32;">
                      <tr>
                        <th class="px-4 py-2 text-left">Lineup</th>
                        <th class="px-4 py-2 text-right">PPP Allowed</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp in best_defense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2">{{ combo|replace(',', ', ') }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <h5 class="font-semibold mb-2">Worst Defense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-auto border-collapse">
                    <thead class="bg-white border-b-2" style="border-color:#9E1B32;">
                      <tr>
                        <th class="px-4 py-2 text-left">Lineup</th>
                        <th class="px-4 py-2 text-right">PPP Allowed</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp in worst_defense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2">{{ combo|replace(',', ', ') }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Combined Tab Scripts -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Top-level toggle
      const offBtn = document.getElementById('offenseBtn');
      const defBtn = document.getElementById('defenseBtn');
      const lineupBtn = document.getElementById('lineupBtn');
      const offContent = document.getElementById('offenseContent');
      const defContent = document.getElementById('defenseContent');
      const lineupContent = document.getElementById('lineupContent');
      const lineupSizeBtns = document.querySelectorAll('.lineup-size-btn');
      const lineupSizePanels = document.querySelectorAll('.lineup-size-panel');
      const setLineupSize = (size, activeBtn) => {
        lineupSizeBtns.forEach(btn => {
          btn.classList.remove('bg-[#9E1B32]','text-white');
          btn.classList.add('bg-gray-100','text-gray-700');
        });
        if (activeBtn) {
          activeBtn.classList.remove('bg-gray-100','text-gray-700');
          activeBtn.classList.add('bg-[#9E1B32]','text-white');
        }
        lineupSizePanels.forEach(panel => {
          panel.classList.toggle('hidden', panel.dataset.size !== size);
        });
      };
  
      function showOff() {
        offContent.classList.remove('hidden');
        defContent.classList.add('hidden');
        lineupContent.classList.add('hidden');
        offBtn.classList.replace('bg-gray-200','bg-[#9E1B32]');
        offBtn.classList.replace('text-gray-700','text-white');
        defBtn.classList.replace('bg-[#9E1B32]','bg-gray-200');
        defBtn.classList.replace('text-white','text-gray-700');
        lineupBtn.classList.replace('bg-[#9E1B32]','bg-gray-200');
        lineupBtn.classList.replace('text-white','text-gray-700');
      }
      function showDef() {
        defContent.classList.remove('hidden');
        offContent.classList.add('hidden');
        lineupContent.classList.add('hidden');
        defBtn.classList.replace('bg-gray-200','bg-[#9E1B32]');
        defBtn.classList.replace('text-gray-700','text-white');
        offBtn.classList.replace('bg-[#9E1B32]','bg-gray-200');
        offBtn.classList.replace('text-white','text-gray-700');
        lineupBtn.classList.replace('bg-[#9E1B32]','bg-gray-200');
        lineupBtn.classList.replace('text-white','text-gray-700');
      }
      function showLineup() {
        lineupContent.classList.remove('hidden');
        offContent.classList.add('hidden');
        defContent.classList.add('hidden');
        lineupBtn.classList.replace('bg-gray-200','bg-[#9E1B32]');
        lineupBtn.classList.replace('text-gray-700','text-white');
        offBtn.classList.replace('bg-[#9E1B32]','bg-gray-200');
        offBtn.classList.replace('text-white','text-gray-700');
        defBtn.classList.replace('bg-[#9E1B32]','bg-gray-200');
        defBtn.classList.replace('text-white','text-gray-700');
        const hasActiveSize = Array.from(lineupSizePanels).some(panel => !panel.classList.contains('hidden'));
        if (lineupSizeBtns.length && !hasActiveSize) {
          const defaultBtn = Array.from(lineupSizeBtns).find(btn => btn.dataset.hasData === 'true') || lineupSizeBtns[0];
          if (defaultBtn) {
            setLineupSize(defaultBtn.dataset.size, defaultBtn);
          }
        }
      }
      offBtn.addEventListener('click', showOff);
      defBtn.addEventListener('click', showDef);
      lineupBtn.addEventListener('click', showLineup);
      showOff();
  
      lineupSizeBtns.forEach(btn => {
        btn.addEventListener('click', () => setLineupSize(btn.dataset.size, btn));
      });
      if (lineupSizeBtns.length) {
        const defaultBtn = Array.from(lineupSizeBtns).find(btn => btn.dataset.hasData === 'true') || lineupSizeBtns[0];
        if (defaultBtn) {
          setLineupSize(defaultBtn.dataset.size, defaultBtn);
        }
      }
    });
  </script>

  </div>
{% endblock %}
