{% extends 'admin/base.html' %}

{% block content %}
  <div class="mb-6">
    <h1 class="text-2xl font-bold">{{ form_title }}</h1>
    <p class="text-sm text-gray-600">Entries track the best (MAX) record values. Ties are allowed.</p>
  </div>

  <form method="POST" action="{{ form_action }}" class="max-w-4xl space-y-6 bg-white p-6 rounded shadow">
    <div>
      <label class="block mb-1 font-medium">Record Definition</label>
      <select id="record_definition_id" name="record_definition_id"
              class="w-full border rounded px-3 py-2{% if errors.get('record_definition_id') %} border-red-400{% endif %}">
        <option value="" disabled {% if not form_data.record_definition_id %}selected{% endif %}>Select a definition</option>
        {% set selected_definition_id = form_data.record_definition_id | string %}
        {% for definition in definitions %}
          <option value="{{ definition.id }}"
                  data-entity-type="{{ definition.entity_type }}"
                  data-scope="{{ definition.scope }}"
                  {% if selected_definition_id == definition.id | string %}selected{% endif %}>
            {{ definition.name }}{% if not definition.is_active %} (Inactive){% endif %}
          </option>
        {% endfor %}
      </select>
      {% if errors.get('record_definition_id') %}
        <p class="text-sm text-red-600 mt-1">{{ errors.get('record_definition_id') }}</p>
      {% endif %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 font-medium">Definition Scope</label>
        <div class="rounded border border-gray-200 px-3 py-2 bg-gray-50 text-sm" id="definition-scope">—</div>
      </div>
      <div>
        <label class="block mb-1 font-medium">Entity Type</label>
        <div class="rounded border border-gray-200 px-3 py-2 bg-gray-50 text-sm" id="definition-entity">—</div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block mb-1 font-medium">Value</label>
        <input name="value" type="number" step="0.01" value="{{ form_data.value }}"
               class="w-full border rounded px-3 py-2{% if errors.get('value') %} border-red-400{% endif %}" required>
        {% if errors.get('value') %}
          <p class="text-sm text-red-600 mt-1">{{ errors.get('value') }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block mb-1 font-medium">Source</label>
        {% if allow_source_choice %}
          <select name="source_type"
                  class="w-full border rounded px-3 py-2{% if errors.get('source_type') %} border-red-400{% endif %}">
            <option value="MANUAL" {% if form_data.source_type == 'MANUAL' %}selected{% endif %}>MANUAL</option>
            <option value="AUTO" {% if form_data.source_type == 'AUTO' %}selected{% endif %}>AUTO</option>
          </select>
        {% else %}
          <div class="rounded border border-gray-200 px-3 py-2 bg-gray-50 text-sm">MANUAL</div>
          <input type="hidden" name="source_type" value="MANUAL">
        {% endif %}
        {% if errors.get('source_type') %}
          <p class="text-sm text-red-600 mt-1">{{ errors.get('source_type') }}</p>
        {% endif %}
      </div>
    </div>

    <div id="player-section" class="hidden">
      <label class="block mb-1 font-medium">Player Holder</label>
      <select name="holder_player_id"
              class="w-full border rounded px-3 py-2{% if errors.get('holder_player_id') %} border-red-400{% endif %}">
        <option value="">Select a player</option>
        {% set selected_player_id = form_data.holder_player_id | string %}
        {% for player in players %}
          <option value="{{ player.id }}" {% if selected_player_id == player.id | string %}selected{% endif %}>
            {{ player.player_name }}
          </option>
        {% endfor %}
      </select>
      {% if errors.get('holder_player_id') %}
        <p class="text-sm text-red-600 mt-1">{{ errors.get('holder_player_id') }}</p>
      {% endif %}
    </div>

    <div id="opponent-section" class="hidden">
      <label class="block mb-1 font-medium" id="opponent-label">Opponent Name</label>
      <input id="holder_opponent_name" name="holder_opponent_name" type="text" value="{{ form_data.holder_opponent_name }}"
             class="w-full border rounded px-3 py-2{% if errors.get('holder_opponent_name') %} border-red-400{% endif %}">
      <p class="text-xs text-gray-500 mt-1" id="opponent-help"></p>
      {% if errors.get('holder_opponent_name') %}
        <p class="text-sm text-red-600 mt-1">{{ errors.get('holder_opponent_name') }}</p>
      {% endif %}
    </div>

    <div id="game-section" class="hidden">
      <label class="block mb-1 font-medium">Game</label>
      <select id="game_id" name="game_id"
              class="w-full border rounded px-3 py-2{% if errors.get('game_id') %} border-red-400{% endif %}">
        <option value="">No game selected</option>
        {% set selected_game_id = form_data.game_id | string %}
        {% for game in games %}
          <option value="{{ game.id }}" data-opponent="{{ game.opponent_name }}" {% if selected_game_id == game.id | string %}selected{% endif %}>
            {{ game.game_date }} vs {{ game.opponent_name }}
          </option>
        {% endfor %}
      </select>
      {% if errors.get('game_id') %}
        <p class="text-sm text-red-600 mt-1">{{ errors.get('game_id') }}</p>
      {% endif %}
    </div>

    <div id="occurred-section" class="hidden">
      <label class="block mb-1 font-medium">Occurred On</label>
      <input name="occurred_on" type="date" value="{{ form_data.occurred_on }}"
             class="w-full border rounded px-3 py-2{% if errors.get('occurred_on') %} border-red-400{% endif %}">
      <p class="text-xs text-gray-500 mt-1">Required when no game is selected for GAME scope.</p>
      {% if errors.get('occurred_on') %}
        <p class="text-sm text-red-600 mt-1">{{ errors.get('occurred_on') }}</p>
      {% endif %}
    </div>

    <div id="season-section" class="hidden">
      <label class="block mb-1 font-medium">Season Year</label>
      <input name="season_year" type="number" value="{{ form_data.season_year }}"
             class="w-full border rounded px-3 py-2{% if errors.get('season_year') %} border-red-400{% endif %}">
      {% if errors.get('season_year') %}
        <p class="text-sm text-red-600 mt-1">{{ errors.get('season_year') }}</p>
      {% endif %}
    </div>

    <details class="rounded border border-gray-200 bg-gray-50 p-4">
      <summary class="cursor-pointer text-sm font-semibold text-gray-600">Advanced Options</summary>
      <div class="mt-4 space-y-4 text-sm text-gray-600">
        <div class="flex items-center gap-2">
          <input id="is_current" name="is_current" type="checkbox" class="h-4 w-4" {% if form_data.is_current %}checked{% endif %}>
          <label for="is_current" class="text-sm font-medium">Is Current</label>
        </div>
        <div class="flex items-center gap-2">
          <input id="is_forced_current" name="is_forced_current" type="checkbox" class="h-4 w-4" {% if form_data.is_forced_current %}checked{% endif %}>
          <label for="is_forced_current" class="text-sm font-medium">Force Current</label>
        </div>
        <div>
          <label class="block mb-1 font-medium text-gray-700">Notes</label>
          <textarea name="notes" rows="3" class="w-full border rounded px-3 py-2">{{ form_data.notes }}</textarea>
        </div>
      </div>
    </details>

    <div class="flex items-center space-x-4">
      <button type="submit" class="px-4 py-2 bg-[#9E1B32] text-white rounded hover:bg-[#7a1524]">Save Entry</button>
      <a href="{{ url_for('admin.record_entries_list') }}" class="text-gray-600 hover:underline">Cancel</a>
    </div>
  </form>
{% endblock %}

{% block scripts %}
<script>
  const definitionSelect = document.getElementById('record_definition_id');
  const definitionScope = document.getElementById('definition-scope');
  const definitionEntity = document.getElementById('definition-entity');
  const playerSection = document.getElementById('player-section');
  const opponentSection = document.getElementById('opponent-section');
  const opponentLabel = document.getElementById('opponent-label');
  const opponentHelp = document.getElementById('opponent-help');
  const gameSection = document.getElementById('game-section');
  const occurredSection = document.getElementById('occurred-section');
  const seasonSection = document.getElementById('season-section');
  const gameSelect = document.getElementById('game_id');
  const opponentNameInput = document.getElementById('holder_opponent_name');

  function updateDefinitionDetails() {
    const selectedOption = definitionSelect.options[definitionSelect.selectedIndex];
    const entityType = selectedOption?.dataset?.entityType || '—';
    const scope = selectedOption?.dataset?.scope || '—';

    definitionScope.textContent = scope;
    definitionEntity.textContent = entityType;

    const isPlayer = entityType === 'PLAYER';
    const isOpponent = entityType === 'OPPONENT';
    const isGameScope = scope === 'GAME';
    const isSeasonScope = scope === 'SEASON';

    playerSection.classList.toggle('hidden', !isPlayer);
    const showOpponentField = isOpponent || (isGameScope && !isOpponent);
    opponentSection.classList.toggle('hidden', !showOpponentField);
    gameSection.classList.toggle('hidden', !isGameScope);
    occurredSection.classList.toggle('hidden', !isGameScope);
    seasonSection.classList.toggle('hidden', !isSeasonScope);

    if (opponentLabel && opponentHelp) {
      if (isOpponent) {
        opponentLabel.textContent = 'Opponent Name';
        opponentHelp.textContent = 'For opponent records, select a game to auto-fill or enter the opponent manually.';
      } else if (isGameScope) {
        opponentLabel.textContent = 'Opponent (optional)';
        opponentHelp.textContent = 'Optional display-only opponent when no game is linked.';
      } else {
        opponentHelp.textContent = '';
      }
    }
  }

  function maybeFillOpponent() {
    if (!opponentNameInput) return;
    const selectedOption = definitionSelect.options[definitionSelect.selectedIndex];
    const entityType = selectedOption?.dataset?.entityType;
    if (entityType !== 'OPPONENT') return;
    if (!gameSelect) return;

    const gameOption = gameSelect.options[gameSelect.selectedIndex];
    const opponentName = gameOption?.dataset?.opponent || '';
    if (!opponentNameInput.value && opponentName) {
      opponentNameInput.value = opponentName;
    }
  }

  if (definitionSelect) {
    definitionSelect.addEventListener('change', () => {
      updateDefinitionDetails();
      maybeFillOpponent();
    });
    updateDefinitionDetails();
  }

  if (gameSelect) {
    gameSelect.addEventListener('change', maybeFillOpponent);
  }
</script>
{% endblock %}
