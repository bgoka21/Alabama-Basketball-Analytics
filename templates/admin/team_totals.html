{% extends 'base.html' %}

{% block page_controls %}
<div class="flex flex-wrap items-end gap-4 mb-4 no-print">
  <form id="filterForm" method="get" class="flex flex-wrap items-end gap-2">
    <div>
      <label class="font-semibold mr-2">Season:</label>
      <select name="season_id" class="border p-2 rounded">
        {% for s in seasons %}
          <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>{{ s.season_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">From</label>
      <input type="date" name="start_date" value="{{ start_date }}" class="border border-gray-300 rounded px-2 py-1 text-sm" />
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">To</label>
      <input type="date" name="end_date" value="{{ end_date }}" class="border border-gray-300 rounded px-2 py-1 text-sm" />
    </div>
    {% if label_options %}
    <div class="flex flex-wrap items-center gap-2">
      {% for lbl in label_options %}
        <label class="inline-flex items-center text-sm mr-2">
          <input type="checkbox" name="label" value="{{ lbl }}" {% if lbl in selected_labels %}checked{% endif %}>
          <span class="ml-1">{{ lbl }}</span>
        </label>
      {% endfor %}
    </div>
    {% endif %}
    <button type="submit" class="bg-[#9E1B32] text-white px-3 py-1 rounded text-sm">Apply</button>
    <a href="{{ url_for(request.endpoint) }}" class="text-gray-600 text-sm hover:underline">Clear</a>
  </form>
</div>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-2xl font-bold">Team Totals</h1>
  <div class="space-x-2">
    <button onclick="window.print()" class="no-print bg-gray-200 text-black px-3 py-1 rounded text-sm">Print</button>
  </div>
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">PTS/SHOT</div>
    <div class="text-3xl font-bold mt-2">{{ totals.points_per_shot }}</div>
  </div>
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">EFG%</div>
    <div class="text-3xl font-bold mt-2">{{ totals.efg_pct }}</div>
  </div>
</div>
{% set total_attempts = totals.atr_attempts + totals.fg2_attempts + totals.fg3_attempts %}
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
  {% for label, makes, attempts in [
        ('ATR', totals.atr_makes, totals.atr_attempts),
        ('2FG', totals.fg2_makes, totals.fg2_attempts),
        ('3FG', totals.fg3_makes, totals.fg3_attempts),
        ('FT', totals.ftm, totals.fta)
      ] %}
  {% if label == '3FG' %}
    {% set style = (makes/attempts*100) | grade_3fg_pct(attempts) if attempts else '' %}
  {% else %}
    {% set style = (makes/attempts*100) | grade_atr2fg_pct(attempts) if attempts else '' %}
  {% endif %}
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center"{% if style %} style="{{ style }}"{% endif %}>
    <div class="text-sm font-medium text-black uppercase">{{ label }}</div>
    <div class="text-3xl font-bold my-2 text-black">
      {% if attempts > 0 %}{{ (makes/attempts*100)|round(1) }}%{% else %}0%{% endif %}
    </div>
    <div class="text-xs text-black">{{ makes }}/{{ attempts }}</div>
    {% if label != 'FT' %}
      {% if label == '3FG' %}
        {% set pps = (3 * makes / attempts) if attempts else 0 %}
      {% else %}
        {% set pps = (2 * makes / attempts) if attempts else 0 %}
      {% endif %}
      <div class="text-base font-semibold text-black">PPS: {{ pps|round(2) }}</div>
      <div class="text-base font-semibold text-black">Freq: {{ (attempts / total_attempts * 100)|round(1) if total_attempts else 0 }}%</div>
    {% endif %}
  </div>
  {% endfor %}
</div>
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
  {% for label, value in [
      ('Points', totals.points),
      ('Assists', totals.assists),
      ('Pot. Assists', totals.pot_assists),
      ('2nd Assists', totals.second_assists),
      ('Turnovers', totals.turnovers)
    ] %}
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">{{ label }}</div>
    <div class="text-2xl font-bold mt-2">{{ value }}</div>
  </div>
  {% endfor %}
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">AST/TO Ratio</div>
    <div class="text-2xl font-bold mt-2">{{ totals.assist_turnover_ratio }}</div>
  </div>
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">Adj AST/TO</div>
    <div class="text-2xl font-bold mt-2">{{ totals.adj_assist_turnover_ratio }}</div>
  </div>
</div>
<div class="mt-8">
  <h2 class="text-lg sm:text-xl font-semibold mb-4">Blue Collar Breakdown</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full table-auto border-collapse bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
      <thead class="bg-white dark:bg-gray-800 border-b-2 border-[#9E1B32]">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium uppercase">Category</th>
          <th class="px-4 py-2 text-left text-xs font-medium uppercase">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for label, value in [
          ('Def Reb', blue_totals.def_reb),
          ('Off Reb', blue_totals.off_reb),
          ('Misc', blue_totals.misc),
          ('Deflection', blue_totals.deflection),
          ('Steal', blue_totals.steal),
          ('Block', blue_totals.block),
          ('Floor Dive', blue_totals.floor_dive),
          ('Charge Taken', blue_totals.charge_taken),
          ('Reb Tip', blue_totals.reb_tip)
        ] %}
        <tr class="odd:bg-white even:bg-gray-100">
          <td class="px-4 py-2">{{ label }}</td>
          <td class="px-4 py-2">{{ value }}</td>
        </tr>
        {% endfor %}
        <tr class="h-0"><td colspan="2" class="p-0"><div class="h-[2px] bg-[#9E1B32]"></div></td></tr>
        <tr class="odd:bg-white even:bg-gray-100 font-bold">
          <td class="px-4 py-2">Season Total</td>
          <td class="px-4 py-2">{{ blue_totals.total_blue_collar }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
