{% extends 'admin/base.html' %}

{% block page_controls %}
<div id="mainControls">
  <div class="flex flex-wrap items-center gap-4 mb-4 no-print">
    <a href="{{ game_mode_url }}"
       class="mode-link px-4 py-2 rounded {{ 'bg-[#9E1B32] text-white' if mode == 'game' else 'bg-gray-200 text-black' }}">
      Game
    </a>
    <a href="{{ practice_mode_url }}"
       class="mode-link px-4 py-2 rounded {{ 'bg-[#9E1B32] text-white' if mode == 'practice' else 'bg-gray-200 text-black' }}">
      Practice
    </a>
  </div>
  <div class="flex flex-wrap items-end gap-4 mb-4 no-print">
    <form id="mainFilterForm" method="get" class="flex flex-wrap items-end gap-2">
      <input type="hidden" name="mode" value="{{ mode }}">
      <div>
        <label class="font-semibold mr-2">Season:</label>
        <select name="season_id" class="border p-2 rounded">
          {% for s in seasons %}
            <option value="{{ s.id }}" {% if s.id == selected_season %}selected{% endif %}>{{ s.season_name }}</option>
          {% endfor %}
        </select>
      </div>
      {% for key, values in request.args.lists() %}
        {% if key not in ['season_id', 'mode'] %}
          {% for v in values %}
            <input type="hidden" name="{{ key }}" value="{{ v }}">
          {% endfor %}
        {% endif %}
      {% endfor %}
      <button type="submit" class="bg-[#9E1B32] text-white px-3 py-1 rounded text-sm">Apply</button>
      <a href="{{ url_for(request.endpoint, mode=mode) }}" class="text-gray-600 text-sm hover:underline">Clear</a>
    </form>
  </div>
  {% if mode == 'practice' %}
    {% include "_filters_session.html" %}
  {% elif mode == 'game' %}
    <form id="gameTypeFilterForm" method="get" class="no-print border rounded p-3 bg-gray-50 flex flex-col gap-3">
      <input type="hidden" name="mode" value="game">
      {% for key, values in request.args.lists() %}
        {% if key not in ['mode', 'game_type', 'lineup_min_poss', 'lineup_player'] %}
          {% for v in values %}
            <input type="hidden" name="{{ key }}" value="{{ v }}">
          {% endfor %}
        {% endif %}
      {% endfor %}
      <div class="text-sm font-medium">Game Types</div>
      <div class="flex flex-wrap gap-3">
        {% for option in game_type_options %}
          <label class="inline-flex items-center text-sm">
            <input type="checkbox" name="game_type" value="{{ option }}" {% if option in selected_game_types %}checked{% endif %}>
            <span class="ml-1">{{ option }}</span>
          </label>
        {% endfor %}
      </div>
      <div class="flex flex-wrap items-end gap-2">
        <label class="text-sm font-medium" for="lineup_min_poss">Minimum Possessions</label>
        <input
          id="lineup_min_poss"
          type="number"
          name="lineup_min_poss"
          min="0"
          value="{{ lineup_min_poss }}"
          class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]"
        />
        <label class="text-sm font-medium" for="lineup_player">Player</label>
        <select
          id="lineup_player"
          name="lineup_player"
          class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]"
        >
          <option value="">All Players</option>
          {% for player in lineup_players %}
            <option value="{{ player }}" {% if player == lineup_player %}selected{% endif %}>{{ player }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="submit" class="px-3 py-1 text-sm border rounded">Apply</button>
        <a href="{{ url_for(request.endpoint, mode=mode) }}" class="text-gray-600 text-sm hover:underline ml-2">Clear</a>
      </div>
    </form>
  {% endif %}
</div>

<div id="trendControls" class="hidden">
  <div class="flex flex-wrap items-end gap-4 mb-4 no-print">
    <form id="trendFilterForm" method="get" class="flex flex-wrap items-end gap-2">
      <input type="hidden" name="mode" value="{{ mode }}">
      {% for gt in selected_game_types %}
        <input type="hidden" name="game_type" value="{{ gt }}">
      {% endfor %}
      {% if lineup_player %}
        <input type="hidden" name="lineup_player" value="{{ lineup_player }}">
      {% endif %}
      <div>
        <label class="font-semibold mr-2">Season:</label>
        <select name="trend_season_id" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]">
          {% for s in seasons %}
            <option value="{{ s.id }}" {% if s.id == trend_selected_season %}selected{% endif %}>{{ s.season_name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">From</label>
        <input type="date" name="trend_start_date" value="{{ trend_start_date }}" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">To</label>
        <input type="date" name="trend_end_date" value="{{ trend_end_date }}" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Window</label>
        <input type="number" name="trend_window" min="1" value="{{ trend_window }}" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]" />
      </div>
      {% if mode == 'practice' and practice_categories %}
      <div>
        <label class="block text-sm font-medium mb-1">Category</label>
        <select name="trend_category" multiple class="border border-gray-300 rounded px-2 py-1 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]">
          {% for c in practice_categories %}
            <option value="{{ c }}" {% if c in trend_selected_categories %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      {% if mode == 'practice' and label_options %}
      <div class="flex flex-wrap items-center gap-2">
        {% for lbl in label_options %}
          <label class="text-sm mr-3">
            <input type="checkbox" name="trend_label" value="{{ lbl }}" {% if lbl in trend_selected_labels %}checked{% endif %}> {{ lbl }}
          </label>
        {% endfor %}
      </div>
      {% endif %}
      <div>
        <label class="block text-sm font-medium mb-1" for="trend_stat_search">Stat</label>
        <div class="border border-gray-300 rounded px-2 py-1 text-sm bg-white">
          <input type="text" id="trend_stat_search" placeholder="Search..." class="mb-2 w-full border border-gray-300 rounded px-1 py-0.5 bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]" oninput="filterTrendStats(this.value)">
          <div id="trend_stat_list" class="max-h-40 overflow-y-auto">
            {% for s in trend_stat_options %}
              <label class="flex items-center text-sm mr-2">
                <input type="checkbox" name="trend_stat" value="{{ s }}" {% if s in trend_selected_stats %}checked{% endif %} class="mr-1">
                {{ s }}
              </label>
            {% endfor %}
          </div>
        </div>
      </div>
      <button type="submit" class="bg-[#9E1B32] text-white px-3 py-1 rounded text-sm">Apply</button>
      <a href="{{ url_for(request.endpoint, mode=mode) }}" class="text-gray-600 text-sm hover:underline">Clear</a>
    </form>
  </div>
</div>
{% endblock %}

{% block content %}
{% set empty_group = namespace(
  total     = namespace(attempts=0, makes=0, fg_pct=0, pps=0, freq=0),
  transition=namespace(attempts=0, makes=0, fg_pct=0, pps=0, freq=0),
  halfcourt =namespace(attempts=0, makes=0, fg_pct=0, pps=0, freq=0)
) %}
<div class="flex items-center justify-between mb-4">
  <h1 class="text-2xl font-bold">Team Totals</h1>
  <div class="space-x-2">
    <button onclick="window.print()" class="no-print bg-gray-200 text-black px-3 py-1 rounded text-sm">Print</button>
  </div>
</div>
<div id="tabButtons" class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
  <button id="btnSeasonTotals" onclick="showTab('seasonTotals')" class="w-full sm:w-auto px-4 py-3 sm:py-2 border rounded">Totals</button>
  <button id="btnShotType" onclick="showTab('shotType')" class="w-full sm:w-auto px-4 py-3 sm:py-2 border rounded">Shot Type</button>
  <button id="btnGameStats" onclick="showTab('gameStats')" class="w-full sm:w-auto px-4 py-3 sm:py-2 border rounded">Game Stats</button>
  <button id="btnLineupEfficiency" onclick="showTab('lineupEfficiency')" class="w-full sm:w-auto px-4 py-3 sm:py-2 border rounded">Lineup Efficiency</button>
  <button id="btnTrends" onclick="showTab('trends')" class="w-full sm:w-auto px-4 py-3 sm:py-2 border rounded">Trends</button>
</div>
<div id="seasonTotals" class="tab-content block">
<div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">PTS/SHOT</div>
    <div class="text-3xl font-bold mt-2">{{ totals.points_per_shot }}</div>
  </div>
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">EFG%</div>
    <div class="text-3xl font-bold mt-2">{{ totals.efg_pct }}</div>
  </div>
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">ATR%</div>
    <div class="text-3xl font-bold mt-2">{{ totals.atr_pct }}</div>
  </div>
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">3FG%</div>
    <div class="text-3xl font-bold mt-2">{{ totals.fg3_pct }}</div>
  </div>
</div>
{% set total_attempts = totals.atr_attempts + totals.fg2_attempts + totals.fg3_attempts %}
<div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
  {% for label, makes, attempts in [
        ('ATR', totals.atr_makes, totals.atr_attempts),
        ('2FG', totals.fg2_makes, totals.fg2_attempts),
        ('3FG', totals.fg3_makes, totals.fg3_attempts),
        ('FT', totals.ftm, totals.fta)
      ] %}
  {% if label == '3FG' %}
    {% set style = (makes/attempts*100) | grade_3fg_pct(attempts) if attempts else '' %}
  {% else %}
    {% set style = (makes/attempts*100) | grade_atr2fg_pct(attempts) if attempts else '' %}
  {% endif %}
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center"{% if style %} style="{{ style }}"{% endif %}>
    <div class="text-sm font-medium text-black uppercase">{{ label }}</div>
    <div class="text-3xl font-bold my-2 text-black">
      {% if attempts > 0 %}{{ (makes/attempts*100)|round(1) }}%{% else %}0%{% endif %}
    </div>
    <div class="text-xs text-black">{{ makes }}/{{ attempts }}</div>
    {% if label != 'FT' %}
      {% if label == '3FG' %}
        {% set pps = (3 * makes / attempts) if attempts else 0 %}
      {% else %}
        {% set pps = (2 * makes / attempts) if attempts else 0 %}
      {% endif %}
      <div class="text-base font-semibold text-black">PPS: {{ pps|round(2) }}</div>
      <div class="text-base font-semibold text-black">Freq: {{ (attempts / total_attempts * 100)|round(1) if total_attempts else 0 }}%</div>
    {% endif %}
  </div>
  {% endfor %}
</div>
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
  {% for label, value in [
      ('Points', totals.points),
      ('Assists', totals.assists),
      ('Pot. Assists', totals.pot_assists),
      ('2nd Assists', totals.second_assists),
      ('Turnovers', totals.turnovers)
    ] %}
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">{{ label }}</div>
    <div class="text-2xl font-bold mt-2">{{ value }}</div>
  </div>
  {% endfor %}
</div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">AST/TO Ratio</div>
    <div class="text-2xl font-bold mt-2">{{ totals.assist_turnover_ratio }}</div>
  </div>
  <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex flex-col items-center">
    <div class="text-sm font-medium text-gray-500 uppercase">Adj AST/TO</div>
  <div class="text-2xl font-bold mt-2">{{ totals.adj_assist_turnover_ratio }}</div>
  </div>
</div>
<div class="mt-8">
  <h2 class="text-lg sm:text-xl font-semibold mb-4">Paint Touch PPP</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full table-auto border-collapse bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
      <thead class="bg-white dark:bg-gray-800 border-b-2 border-[#9E1B32]">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium uppercase">Paint Touches</th>
          <th class="px-4 py-2 text-left text-xs font-medium uppercase">PPP</th>
        </tr>
      </thead>
      <tbody>
        {% for label, value in [
          ('0', paint_ppp.zero),
          ('1', paint_ppp.one),
          ('2', paint_ppp.two),
          ('3+', paint_ppp.three)
        ] %}
        <tr class="odd:bg-white even:bg-gray-100">
          <td class="px-4 py-2">{{ label }}</td>
          <td class="px-4 py-2">{{ value|round(2) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<div class="mt-8">
  <h2 class="text-lg sm:text-xl font-semibold mb-4">Blue Collar Breakdown</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full table-auto border-collapse bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
      <thead class="bg-white dark:bg-gray-800 border-b-2 border-[#9E1B32]">
        <tr>
          <th class="px-4 py-2 text-left text-xs font-medium uppercase">Category</th>
          <th class="px-4 py-2 text-left text-xs font-medium uppercase">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for label, value in [
          ('Def Reb', blue_totals.def_reb),
          ('Off Reb', blue_totals.off_reb),
          ('Misc', blue_totals.misc),
          ('Deflection', blue_totals.deflection),
          ('Steal', blue_totals.steal),
          ('Block', blue_totals.block),
          ('Floor Dive', blue_totals.floor_dive),
          ('Charge Taken', blue_totals.charge_taken),
          ('Reb Tip', blue_totals.reb_tip)
        ] %}
        <tr class="odd:bg-white even:bg-gray-100">
          <td class="px-4 py-2">{{ label }}</td>
          <td class="px-4 py-2">{{ value }}</td>
        </tr>
        {% endfor %}
        <tr class="h-0"><td colspan="2" class="p-0"><div class="h-[2px] bg-[#9E1B32]"></div></td></tr>
        <tr class="odd:bg-white even:bg-gray-100 font-bold">
          <td class="px-4 py-2">Season Total</td>
          <td class="px-4 py-2">{{ blue_totals.total_blue_collar }}</td>
        </tr>
      </tbody>
    </table>
</div>
</div>
</div>

<div id="gameStats" class="tab-content hidden">
  <div class="space-y-10">
    <section>
      <h2 class="text-lg sm:text-xl font-semibold mb-4">Game Offense</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto border-collapse bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
          <thead class="bg-white dark:bg-gray-800 border-b-2 border-[#9E1B32]">
            <tr>
              <th rowspan="2" class="px-3 py-2 text-xs font-semibold text-left uppercase align-bottom">Date</th>
              <th rowspan="2" class="px-3 py-2 text-xs font-semibold text-left uppercase align-bottom">Opponent</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Scoring</th>
              <th colspan="15" class="px-3 py-2 text-xs font-semibold text-center uppercase">Shooting Splits</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Free Throws</th>
              <th rowspan="2" class="px-3 py-2 text-xs font-semibold text-center uppercase align-bottom">Good Shot %</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Assists</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Turnovers</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Fouls Drawn</th>
            </tr>
            <tr>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">PTS</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">POSS</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">PPP</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">ATR M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">ATR %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">ATR Freq</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">2FG M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">2FG %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">2FG Freq</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">3FG M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">3FG %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">3FG Freq</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">3FG Shr M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">3FG Shr %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">3FG Shr Freq</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">3FG NS M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">3FG NS %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">3FG NS Freq</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">FT M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">FT%</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">FT Rate</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">AST</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">POT</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">2ND</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">TO Total</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">TO%</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">TO /Poss</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">Foul Total</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">Foul%</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase whitespace-nowrap">Foul /Poss</th>
            </tr>
          </thead>
          <tbody>
            {% if team_offense_rows %}
              {% for row in team_offense_rows %}
                <tr class="odd:bg-white even:bg-gray-100">
                  <td class="px-3 py-2 text-sm">
                    {% if row.date %}
                      {{ row.date.strftime('%b %d, %Y') }}
                    {% else %}
                      --
                    {% endif %}
                  </td>
                  <td class="px-3 py-2 text-sm">{{ row.opponent or '--' }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.points }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.possessions }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.ppp|round(3) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.atr.makes }}-{{ row.shots.atr.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center{{ row.shots.atr.pct|grade_atr2fg_pct(row.shots.atr.attempts) }}">{{ row.shots.atr.pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.atr.freq|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg2.makes }}-{{ row.shots.fg2.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center{{ row.shots.fg2.pct|grade_atr2fg_pct(row.shots.fg2.attempts) }}">{{ row.shots.fg2.pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg2.freq|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg3.makes }}-{{ row.shots.fg3.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center{{ row.shots.fg3.pct|grade_3fg_pct(row.shots.fg3.attempts) }}">{{ row.shots.fg3.pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg3.freq|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.fg3_shrink.makes }}-{{ row.fg3_shrink.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center{{ row.fg3_shrink.pct|grade_3fg_pct(row.fg3_shrink.attempts) }}">{{ row.fg3_shrink.pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.fg3_shrink.freq|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.fg3_nonshrink.makes }}-{{ row.fg3_nonshrink.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center{{ row.fg3_nonshrink.pct|grade_3fg_pct(row.fg3_nonshrink.attempts) }}">{{ row.fg3_nonshrink.pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.fg3_nonshrink.freq|round(1) }}%</td>
                  {% set total_shots = row.shots.atr.attempts + row.shots.fg2.attempts + row.shots.fg3.attempts %}
                  {% set ft_rate = (row.fta / total_shots * 100)|round(1) if total_shots else 0 %}
                  <td class="px-3 py-2 text-sm text-center">{{ row.ftm }}-{{ row.fta }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.ft_pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ ft_rate }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.good_shot_pct|round(2) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.assists }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.pot_assists }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.second_assists }}</td>
                  {% set to_per_poss = ('%.2f' % (row.turnovers / row.possessions)) if row.possessions else '0.00' %}
                  <td class="px-3 py-2 text-sm text-center">{{ row.turnovers }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.turnover_pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ to_per_poss }}</td>
                  {% set foul_per_poss = ('%.2f' % (row.fouls_drawn / row.possessions)) if row.possessions else '0.00' %}
                  <td class="px-3 py-2 text-sm text-center">{{ row.fouls_drawn }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.foul_pct|round(1) }}%</td>
                  <td class="px-3 py-2 text-sm text-center">{{ foul_per_poss }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="33" class="px-3 py-6 text-center text-sm text-gray-500">No offensive game stats available for the selected filters.</td>
              </tr>
            {% endif %}
          </tbody>
          {% if team_offense_totals %}
            <tfoot class="bg-gray-100">
              <tr class="font-semibold">
                <td class="px-3 py-2 text-sm" colspan="2">Totals</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.points }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.possessions }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.ppp|round(3) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.shots.atr.makes }}-{{ team_offense_totals.shots.atr.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center{{ team_offense_totals.shots.atr.pct|grade_atr2fg_pct(team_offense_totals.shots.atr.attempts) }}">{{ team_offense_totals.shots.atr.pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.shots.atr.freq|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.shots.fg2.makes }}-{{ team_offense_totals.shots.fg2.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center{{ team_offense_totals.shots.fg2.pct|grade_atr2fg_pct(team_offense_totals.shots.fg2.attempts) }}">{{ team_offense_totals.shots.fg2.pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.shots.fg2.freq|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.shots.fg3.makes }}-{{ team_offense_totals.shots.fg3.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center{{ team_offense_totals.shots.fg3.pct|grade_3fg_pct(team_offense_totals.shots.fg3.attempts) }}">{{ team_offense_totals.shots.fg3.pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.shots.fg3.freq|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.fg3_shrink.makes }}-{{ team_offense_totals.fg3_shrink.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center{{ team_offense_totals.fg3_shrink.pct|grade_3fg_pct(team_offense_totals.fg3_shrink.attempts) }}">{{ team_offense_totals.fg3_shrink.pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.fg3_shrink.freq|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.fg3_nonshrink.makes }}-{{ team_offense_totals.fg3_nonshrink.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center{{ team_offense_totals.fg3_nonshrink.pct|grade_3fg_pct(team_offense_totals.fg3_nonshrink.attempts) }}">{{ team_offense_totals.fg3_nonshrink.pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.fg3_nonshrink.freq|round(1) }}%</td>
                {% set total_offense_shots = team_offense_totals.shots.atr.attempts + team_offense_totals.shots.fg2.attempts + team_offense_totals.shots.fg3.attempts %}
                {% set totals_ft_rate = (team_offense_totals.fta / total_offense_shots * 100)|round(1) if total_offense_shots else 0 %}
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.ftm }}-{{ team_offense_totals.fta }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.ft_pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ totals_ft_rate }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.good_shot_pct|round(2) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.assists }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.pot_assists }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.second_assists }}</td>
                {% set totals_to_per_poss = ('%.2f' % (team_offense_totals.turnovers / team_offense_totals.possessions)) if team_offense_totals.possessions else '0.00' %}
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.turnovers }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.turnover_pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ totals_to_per_poss }}</td>
                {% set totals_foul_per_poss = ('%.2f' % (team_offense_totals.fouls_drawn / team_offense_totals.possessions)) if team_offense_totals.possessions else '0.00' %}
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.fouls_drawn }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_offense_totals.foul_pct|round(1) }}%</td>
                <td class="px-3 py-2 text-sm text-center">{{ totals_foul_per_poss }}</td>
              </tr>
            </tfoot>
          {% endif %}
        </table>
      </div>
    </section>

    <section>
      <h2 class="text-lg sm:text-xl font-semibold mb-4">Game Defense</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full table-auto border-collapse bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
          <thead class="bg-white dark:bg-gray-800 border-b-2 border-[#9E1B32]">
            <tr>
              <th rowspan="2" class="px-3 py-2 text-xs font-semibold text-left uppercase align-bottom">Date</th>
              <th rowspan="2" class="px-3 py-2 text-xs font-semibold text-left uppercase align-bottom">Opponent</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Opponent Scoring</th>
              <th colspan="6" class="px-3 py-2 text-xs font-semibold text-center uppercase">Shooting Splits</th>
              <th colspan="2" class="px-3 py-2 text-xs font-semibold text-center uppercase">Free Throws</th>
              <th rowspan="2" class="px-3 py-2 text-xs font-semibold text-center uppercase align-bottom">Good Shot %</th>
              <th colspan="2" class="px-3 py-2 text-xs font-semibold text-center uppercase">Turnovers</th>
              <th colspan="2" class="px-3 py-2 text-xs font-semibold text-center uppercase">Fouls Drawn</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Collision</th>
              <th colspan="3" class="px-3 py-2 text-xs font-semibold text-center uppercase">Box Out</th>
            </tr>
            <tr>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">PTS</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">POSS</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">PPP</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">ATR M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">ATR %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">2FG M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">2FG %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">3FG M-A</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">3FG %</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">FTM-FTA</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">FT%</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">Total</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">TO%</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">Total</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">Foul%</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">+</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">-</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">%</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">+</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">-</th>
              <th class="px-3 py-2 text-xs font-semibold text-center uppercase">%</th>
            </tr>
          </thead>
          <tbody>
            {% if team_defense_rows %}
              {% for row in team_defense_rows %}
                <tr class="odd:bg-white even:bg-gray-100">
                  <td class="px-3 py-2 text-sm">
                    {% if row.date %}
                      {{ row.date.strftime('%b %d, %Y') }}
                    {% else %}
                      --
                    {% endif %}
                  </td>
                  <td class="px-3 py-2 text-sm">{{ row.opponent or '--' }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.points }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.possessions }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.ppp|round(3) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.atr.makes }}-{{ row.shots.atr.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.atr.pct|round(1) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg2.makes }}-{{ row.shots.fg2.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg2.pct|round(1) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg3.makes }}-{{ row.shots.fg3.attempts }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.shots.fg3.pct|round(1) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.ftm }}-{{ row.fta }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.ft_pct|round(1) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.good_shot_pct|round(2) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.turnovers }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.turnover_pct|round(1) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.fouls_drawn }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.foul_pct|round(1) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.collision.positive }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.collision.missed }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.collision.pct|round(1) }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.box_out.positive }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.box_out.missed }}</td>
                  <td class="px-3 py-2 text-sm text-center">{{ row.box_out.pct|round(1) }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="24" class="px-3 py-6 text-center text-sm text-gray-500">No defensive game stats available for the selected filters.</td>
              </tr>
            {% endif %}
          </tbody>
          {% if team_defense_totals %}
            <tfoot class="bg-gray-100">
              <tr class="font-semibold">
                <td class="px-3 py-2 text-sm" colspan="2">Totals</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.points }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.possessions }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.ppp|round(3) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.shots.atr.makes }}-{{ team_defense_totals.shots.atr.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.shots.atr.pct|round(1) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.shots.fg2.makes }}-{{ team_defense_totals.shots.fg2.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.shots.fg2.pct|round(1) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.shots.fg3.makes }}-{{ team_defense_totals.shots.fg3.attempts }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.shots.fg3.pct|round(1) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.ftm }}-{{ team_defense_totals.fta }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.ft_pct|round(1) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.good_shot_pct|round(2) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.turnovers }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.turnover_pct|round(1) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.fouls_drawn }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.foul_pct|round(1) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.collision.positive }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.collision.missed }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.collision.pct|round(1) }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.box_out.positive }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.box_out.missed }}</td>
                <td class="px-3 py-2 text-sm text-center">{{ team_defense_totals.box_out.pct|round(1) }}</td>
              </tr>
            </tfoot>
          {% endif %}
        </table>
      </div>

      {% if blue_totals %}
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <h3 class="text-base font-semibold mb-3">Season Blue Collar Summary</h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 text-sm">
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Def Reb</span><span>{{ blue_totals.def_reb }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Off Reb</span><span>{{ blue_totals.off_reb }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Misc</span><span>{{ blue_totals.misc }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Deflection</span><span>{{ blue_totals.deflection }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Steal</span><span>{{ blue_totals.steal }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Block</span><span>{{ blue_totals.block }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Floor Dive</span><span>{{ blue_totals.floor_dive }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Charge Taken</span><span>{{ blue_totals.charge_taken }}</span></div>
            <div class="flex flex-col"><span class="font-semibold text-gray-600 dark:text-gray-300">Reb Tip</span><span>{{ blue_totals.reb_tip }}</span></div>
            <div class="flex flex-col sm:col-span-3 lg:col-span-2"><span class="font-semibold text-gray-600 dark:text-gray-300">Season Total</span><span class="text-lg font-bold">{{ blue_totals.total_blue_collar }}</span></div>
          </div>
        </div>
      {% endif %}
    </section>
  </div>
</div>

<div id="lineupEfficiency" class="tab-content hidden">
  {% if mode == 'game' %}
    {% set lineup_sizes = (most_used_lineups_offense.keys()|list + best_offense.keys()|list + best_defense.keys()|list)|unique|sort %}
    <div class="mt-10 space-y-6">
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4 sm:p-6">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h2 class="text-lg sm:text-xl font-semibold">Lineup Efficiency</h2>
            <p class="text-sm text-gray-500">
              Showing lineups with at least {{ lineup_min_poss }} possessions
              {% if lineup_player %}
                â€¢ Filtered to: <span class="font-semibold text-gray-700">{{ lineup_player }}</span>
              {% endif %}
            </p>
          </div>
          <form method="get" class="flex flex-wrap items-end gap-2 text-sm">
            {% for key, values in request.args.lists() %}
              {% if key not in ['lineup_min_poss', 'lineup_player'] %}
                {% for v in values %}
                  <input type="hidden" name="{{ key }}" value="{{ v }}">
                {% endfor %}
              {% endif %}
            {% endfor %}
            <div class="flex flex-col">
              <label class="font-medium text-gray-700" for="lineup_min_poss_inline">Minimum Possessions</label>
              <input
                id="lineup_min_poss_inline"
                type="number"
                name="lineup_min_poss"
                min="0"
                value="{{ lineup_min_poss }}"
                class="border border-gray-300 rounded px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]"
              />
            </div>
            <div class="flex flex-col">
              <label class="font-medium text-gray-700" for="lineup_player_inline">Player</label>
              <select
                id="lineup_player_inline"
                name="lineup_player"
                class="border border-gray-300 rounded px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-[#9E1B32]"
              >
                <option value="">All Players</option>
                {% for player in lineup_players %}
                  <option value="{{ player }}" {% if player == lineup_player %}selected{% endif %}>{{ player }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="px-3 py-1 border rounded">Apply</button>
          </form>
        </div>
        <div class="flex flex-wrap gap-2 mt-4">
          {% for size in lineup_sizes %}
            {% set has_size_data = most_used_lineups_offense.get(size, []) or most_used_lineups_defense.get(size, []) or best_offense.get(size, []) or worst_offense.get(size, []) or best_defense.get(size, []) or worst_defense.get(size, []) %}
            <button
              type="button"
              class="lineup-size-btn px-4 py-2 rounded-lg bg-gray-100 text-gray-700"
              data-size="{{ size }}"
              data-has-data="{{ 'true' if has_size_data else 'false' }}"
            >
              {{ size }}-Man
            </button>
          {% endfor %}
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <h3 class="text-base font-semibold mb-3">Most Used</h3>
          {% for size in lineup_sizes %}
            {% set used_offense = most_used_lineups_offense.get(size, []) %}
            {% set used_defense = most_used_lineups_defense.get(size, []) %}
            <div class="lineup-size-panel hidden" data-size="{{ size }}">
              <h4 class="text-sm font-semibold mb-3">{{ size }}-Man Lineups</h4>
              {% if not used_offense and not used_defense %}
                <p class="italic text-center text-gray-500">No {{ size }}-Man lineup data available.</p>
              {% else %}
                <h5 class="font-semibold mb-2">Offense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-fixed border-collapse mb-4">
                    <thead class="bg-white border-b-2 border-[#9E1B32]">
                      <tr>
                        <th class="w-3/5 px-4 py-2 text-left">Lineup</th>
                        <th class="w-1/5 px-4 py-2 text-right">Total Possessions</th>
                        <th class="w-1/5 px-4 py-2 text-right">PPP</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, poss, ppp in used_offense %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2 whitespace-normal break-words leading-relaxed text-sm">
                          {{ combo|replace(',', ', ') }}
                        </td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <h5 class="font-semibold mb-2">Defense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-fixed border-collapse">
                    <thead class="bg-white border-b-2 border-[#9E1B32]">
                      <tr>
                        <th class="w-3/5 px-4 py-2 text-left">Lineup</th>
                        <th class="w-1/5 px-4 py-2 text-right">Total Possessions</th>
                        <th class="w-1/5 px-4 py-2 text-right">PPP</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, poss, ppp in used_defense %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2 whitespace-normal break-words leading-relaxed text-sm">
                          {{ combo|replace(',', ', ') }}
                        </td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <h3 class="text-base font-semibold mb-3">Best/Worst Offense</h3>
          {% for size in lineup_sizes %}
            {% set best_offense_rows = best_offense.get(size, []) %}
            {% set worst_offense_rows = worst_offense.get(size, []) %}
            <div class="lineup-size-panel hidden" data-size="{{ size }}">
              <h4 class="text-sm font-semibold mb-3">{{ size }}-Man Offense</h4>
              {% if not best_offense_rows and not worst_offense_rows %}
                <p class="italic text-center text-gray-500">No {{ size }}-Man lineup data available.</p>
              {% else %}
                <h5 class="font-semibold mb-2">Best Offense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-fixed border-collapse mb-4">
                    <thead class="bg-white border-b-2 border-[#9E1B32]">
                      <tr>
                        <th class="w-3/5 px-4 py-2 text-left">Lineup</th>
                        <th class="w-1/5 px-4 py-2 text-right">PPP</th>
                        <th class="w-1/5 px-4 py-2 text-right">Total Possessions Played</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp, poss in best_offense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2 whitespace-normal break-words leading-relaxed text-sm">
                          {{ combo|replace(',', ', ') }}
                        </td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <h5 class="font-semibold mb-2">Worst Offense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-fixed border-collapse">
                    <thead class="bg-white border-b-2 border-[#9E1B32]">
                      <tr>
                        <th class="w-3/5 px-4 py-2 text-left">Lineup</th>
                        <th class="w-1/5 px-4 py-2 text-right">PPP</th>
                        <th class="w-1/5 px-4 py-2 text-right">Total Possessions Played</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp, poss in worst_offense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2 whitespace-normal break-words leading-relaxed text-sm">
                          {{ combo|replace(',', ', ') }}
                        </td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
          <h3 class="text-base font-semibold mb-3">Best/Worst Defense</h3>
          {% for size in lineup_sizes %}
            {% set best_defense_rows = best_defense.get(size, []) %}
            {% set worst_defense_rows = worst_defense.get(size, []) %}
            <div class="lineup-size-panel hidden" data-size="{{ size }}">
              <h4 class="text-sm font-semibold mb-3">{{ size }}-Man Defense</h4>
              {% if not best_defense_rows and not worst_defense_rows %}
                <p class="italic text-center text-gray-500">No {{ size }}-Man lineup data available.</p>
              {% else %}
                <h5 class="font-semibold mb-2">Best Defense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-fixed border-collapse mb-4">
                    <thead class="bg-white border-b-2 border-[#9E1B32]">
                      <tr>
                        <th class="w-3/5 px-4 py-2 text-left">Lineup</th>
                        <th class="w-1/5 px-4 py-2 text-right">PPP Allowed</th>
                        <th class="w-1/5 px-4 py-2 text-right">Total Possessions Played</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp, poss in best_defense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2 whitespace-normal break-words leading-relaxed text-sm">
                          {{ combo|replace(',', ', ') }}
                        </td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                <h5 class="font-semibold mb-2">Worst Defense</h5>
                <div class="overflow-x-auto">
                  <table class="w-full table-fixed border-collapse">
                    <thead class="bg-white border-b-2 border-[#9E1B32]">
                      <tr>
                        <th class="w-3/5 px-4 py-2 text-left">Lineup</th>
                        <th class="w-1/5 px-4 py-2 text-right">PPP Allowed</th>
                        <th class="w-1/5 px-4 py-2 text-right">Total Possessions Played</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for combo, ppp, poss in worst_defense_rows %}
                      <tr class="odd:bg-white even:bg-gray-100">
                        <td class="px-4 py-2 whitespace-normal break-words leading-relaxed text-sm">
                          {{ combo|replace(',', ', ') }}
                        </td>
                        <td class="px-4 py-2 text-right">{{ '%.2f'|format(ppp) }}</td>
                        <td class="px-4 py-2 text-right">{{ poss }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% else %}
    <p class="text-sm text-gray-500">Lineup efficiency is only available in game mode.</p>
  {% endif %}
</div>

<div id="shotType" class="tab-content hidden">
  <h2 class="text-lg sm:text-xl font-semibold mb-4">Shot Type Overview</h2>

  <!-- Season Aggregates as big cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
    <!-- ATR Season -->
    <div
      id="cardATR"
      onclick="showShotTypeDetail('atr')"
      class="cursor-pointer bg-white dark:bg-gray-800 p-4 rounded shadow-md transition{{ shot_type_totals.atr.fg_pct |grade_atr2fg_pct(shot_type_totals.atr.attempts) }}"
    >
      <div class="text-sm font-medium text-black uppercase">ATR Season</div>
      <div class="text-2xl font-bold mt-2 text-black">
        {{ shot_type_totals.atr.fg_pct|round(1) }}%
      </div>
      <div class="text-xs text-black">
        {{ shot_type_totals.atr.makes }}/{{ shot_type_totals.atr.attempts }}
      </div>
      <div class="text-base font-semibold text-black">PPS: {{ shot_type_totals.atr.pps|round(2) }}</div>
      <div class="text-base font-semibold text-black">Freq: {{ shot_type_totals.atr.freq|round(1) }}%</div>
    </div>

    <!-- 2FG Season -->
    <div
      id="cardFG2"
      onclick="showShotTypeDetail('fg2')"
      class="cursor-pointer bg-white dark:bg-gray-800 p-4 rounded shadow-md transition{{ shot_type_totals.fg2.fg_pct |grade_atr2fg_pct(shot_type_totals.fg2.attempts) }}"
    >
      <div class="text-sm font-medium text-black uppercase">2FG Season</div>
      <div class="text-2xl font-bold mt-2 text-black">
        {{ shot_type_totals.fg2.fg_pct|round(1) }}%
      </div>
      <div class="text-xs text-black">
        {{ shot_type_totals.fg2.makes }}/{{ shot_type_totals.fg2.attempts }}
      </div>
      <div class="text-base font-semibold text-black">PPS: {{ shot_type_totals.fg2.pps|round(2) }}</div>
      <div class="text-base font-semibold text-black">Freq: {{ shot_type_totals.fg2.freq|round(1) }}%</div>
    </div>

    <!-- 3FG Season -->
    <div
      id="cardFG3"
      onclick="showShotTypeDetail('fg3')"
      class="cursor-pointer bg-white dark:bg-gray-800 p-4 rounded shadow-md transition{{ shot_type_totals.fg3.fg_pct |grade_3fg_pct(shot_type_totals.fg3.attempts) }}"
    >
      <div class="text-sm font-medium text-black uppercase">3FG Season</div>
      <div class="text-2xl font-bold mt-2 text-black">
        {{ shot_type_totals.fg3.fg_pct|round(1) }}%
      </div>
      <div class="text-xs text-black">
        {{ shot_type_totals.fg3.makes }}/{{ shot_type_totals.fg3.attempts }}
      </div>
      <div class="text-base font-semibold text-black">PPS: {{ shot_type_totals.fg3.pps|round(2) }}</div>
      <div class="text-base font-semibold text-black">Freq: {{ shot_type_totals.fg3.freq|round(1) }}%</div>
    </div>
  </div>

  {% set atr_summary = shot_summaries['atr'] %}
  {% set fg2_summary = shot_summaries['fg2'] %}
  {% set fg3_summary = shot_summaries['fg3'] %}

  <div class="shot-report-container">

    {% set atr_groups = [
      ('Assisted',        ['Assisted','Non-Assisted']),
      ('Dribble',      ['Dribble','No Dribble']),
      ('RA',           ['Restricted Area','Non Restricted Area']),
      ('Feet',         ['Off 1 Foot','Off 2 Feet']),
      ('Hands',        ['Left Hand Finish','Right Hand Finish','Hands To Rim','Hands Away From Rim']),
      ('PA',           ['Play Action','No Play Action']),
      ('Defenders',    ['Primary Defender','Secondary Defender','Multiple Defenders','Unguarded']),
      ('Type',         ['Dunk','Catch','Floater','Layup','Turnaround J','Pull Up','Step Back']),
      ('Other',        ['Blocked']),
      ('SchemeÂ â€“Â Drive',  ['Middle Drive','Baseline Drive','Slot Drive','Drive Right','Drive Left']),
      ('SchemeÂ â€“Â Attack', ['Beast / Post','DHO / Get','Iso','PnR Handler','Off Closeout','PnR Sneak','Transition Push','OREB Putback']),
      ('SchemeÂ â€“Â Pass',   [
        'Swing','Check Down','Off Screen','1 More','Lift','PnR Pocket','Post Entry','Drift','PnR Lob','Post Pass Out','Kickdown',
        'PnR Late Roll','Dump Off','Slot Skip','Pocket Extra','Lob','Nail Pitch','DHO / Get','PnR Pop','Slash / Cut','Reshape',
        'Shake','Skip','Pull Behind','Outlet','Press Break','Cross Court','Under OB','Kick Ahead','Dagger','Side / Press OB'
      ])
    ] %}

    <div class="shot-section">
      <div id="atr" class="detail-content hidden">
      <div class="relative max-h-[600px] overflow-y-auto">
      <table class="min-w-full divide-y divide-gray-200 mb-6">
        <thead class="sticky top-0 bg-white dark:bg-gray-800 z-10 bg-gray-100">
          <tr>
            <th rowspan="2" class="px-4 py-2 text-left">Category</th>
            <th colspan="4" class="px-4 py-2 text-center">Total</th>
            <th colspan="4" class="px-4 py-2 text-center">Transition</th>
            <th colspan="4" class="px-4 py-2 text-center">Half-Court</th>
          </tr>
          <tr>
            {% for _ in range(3) %}
              <th class="px-2 py-1 text-center">FGA</th>
              <th class="px-2 py-1 text-center">FG%</th>
              <th class="px-2 py-1 text-center">PPS</th>
              <th class="px-2 py-1 text-center">Freq%</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for _group_name, cats in atr_groups %}
            <tr>
              <td colspan="13" class="p-0">
                <div class="h-[2px] bg-[#9E1B32]"></div>
              </td>
            </tr>
            {% for category in cats %}
              {% set d = atr_summary.cats.get(category, empty_group) %}
              <tr class="{{ loop.cycle('', 'bg-gray-100') }}">
                <td class="px-4 py-2">{{ category }}</td>

                <td class="px-2 py-1 text-center">
                  {{ d.total.makes }}-{{ d.total.attempts }}
                </td>
                <td class="px-2 py-1 text-center{{ (d.total.fg_pct*100)|grade_atr2fg_pct(d.total.attempts) }}">
                  {{ (d.total.fg_pct*100)|round(1) }}%
                </td>
                <td class="px-2 py-1 text-center{{ d.total.pps|grade_pps(d.total.attempts) }}">
                  {{ d.total.pps|round(2) }}
                </td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.atr.attempts > 0 %}
                    {{ (d.total.attempts / shot_type_totals.atr.attempts * 100) | round(1) }}%
                  {% else %}
                    0.0%
                  {% endif %}
                </td>

                <td class="px-2 py-1 text-center">
                  {{ d.transition.makes }}-{{ d.transition.attempts }}
                </td>
                <td class="px-2 py-1 text-center{{ (d.transition.fg_pct*100)|grade_atr2fg_pct(d.transition.attempts) }}">
                  {{ (d.transition.fg_pct*100)|round(1) }}%
                </td>
                <td class="px-2 py-1 text-center{{ d.transition.pps|grade_pps(d.transition.attempts) }}">
                  {{ d.transition.pps|round(2) }}
                </td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.atr.attempts > 0 %}
                    {{ (d.transition.attempts / shot_type_totals.atr.attempts * 100) | round(1) }}%
                  {% else %}
                    0.0%
                  {% endif %}
                </td>

                <td class="px-2 py-1 text-center">
                  {{ d.halfcourt.makes }}-{{ d.halfcourt.attempts }}
                </td>
                <td class="px-2 py-1 text-center{{ (d.halfcourt.fg_pct*100)|grade_atr2fg_pct(d.halfcourt.attempts) }}">
                  {{ (d.halfcourt.fg_pct*100)|round(1) }}%
                </td>
                <td class="px-2 py-1 text-center{{ d.halfcourt.pps|grade_pps(d.halfcourt.attempts) }}">
                  {{ d.halfcourt.pps|round(2) }}
                </td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.atr.attempts > 0 %}
                    {{ (d.halfcourt.attempts / shot_type_totals.atr.attempts * 100) | round(1) }}%
                  {% else %}
                    0.0%
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    </div>

    {% set fg2_groups = [
      ('Assisted',        ['Assisted','Non-Assisted']),
      ('Dribble',         ['Dribble','No Dribble']),
      ('RA',              ['Restricted Area','Non Restricted Area']),
      ('Feet',            ['Off 1 Foot','Off 2 Feet']),
      ('Hands',           ['Left Hand Finish','Right Hand Finish','Hands To Rim','Hands Away From Rim']),
      ('PA',              ['Play Action','No Play Action']),
      ('Defenders',       ['Primary Defender','Secondary Defender','Multiple Defenders','Unguarded']),
      ('Type',            ['Dunk','Catch','Floater','Layup','Turnaround J','Pull Up','Step Back']),
      ('Other',           ['Blocked']),
      ('SchemeÂ â€“Â Drive',  ['Middle Drive','Baseline Drive','Slot Drive','Drive Right','Drive Left']),
      ('SchemeÂ â€“Â Attack', ['Beast / Post','DHO / Get','Iso','PnR Handler','Off Closeout','PnR Sneak','Transition Push','OREB Putback']),
      ('SchemeÂ â€“Â Pass',   [
        'Swing','Check Down','Off Screen','1 More','Lift','PnR Pocket','Post Entry','Drift','PnR Lob','Post Pass Out','Kickdown',
        'PnR Late Roll','Dump Off','Slot Skip','Pocket Extra','Lob','Nail Pitch','DHO / Get','PnR Pop','Slash / Cut','Reshape',
        'Shake','Skip','Pull Behind','Outlet','Press Break','Cross Court','Under OB','Kick Ahead','Dagger','Side / Press OB'
      ])
    ] %}

    <div class="shot-section">
    <div id="fg2" class="detail-content hidden">
      <div class="relative max-h-[600px] overflow-y-auto">
      <table class="min-w-full divide-y divide-gray-200 mb-6">
        <thead class="sticky top-0 bg-white dark:bg-gray-800 z-10 bg-gray-100">
          <tr>
            <th rowspan="2" class="px-4 py-2 text-left">Category</th>
            <th colspan="4" class="px-4 py-2 text-center">Total</th>
            <th colspan="4" class="px-4 py-2 text-center">Transition</th>
            <th colspan="4" class="px-4 py-2 text-center">Half-Court</th>
          </tr>
          <tr>
            {% for _ in range(3) %}
              <th class="px-2 py-1 text-center">FGA</th>
              <th class="px-2 py-1 text-center">FG%</th>
              <th class="px-2 py-1 text-center">PPS</th>
              <th class="px-2 py-1 text-center">Freq%</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for _group_name, cats in fg2_groups %}
            <tr>
              <td colspan="13" class="p-0">
                <div class="h-[2px] bg-[#9E1B32]"></div>
              </td>
            </tr>
            {% for category in cats %}
              {% set d = fg2_summary.cats.get(category, empty_group) %}
              <tr class="{{ loop.cycle('', 'bg-gray-100') }}">
                <td class="px-4 py-2">{{ category }}</td>

                <td class="px-2 py-1 text-center">{{ d.total.makes }}-{{ d.total.attempts }}</td>
                <td class="px-2 py-1 text-center{% if d.total.attempts > 0 %}{{ (d.total.makes / d.total.attempts * 100) | grade_atr2fg_pct(d.total.attempts) }}{% endif %}">
                  {% if d.total.attempts > 0 %}{{ (d.total.makes / d.total.attempts * 100) | round(1) }}%{% else %}0.0%{% endif %}
                </td>
                <td class="px-2 py-1 text-center{{ d.total.pps|grade_pps(d.total.attempts) }}">{{ d.total.pps | round(2) }}</td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.fg2.attempts > 0 %}
                    {{ (d.total.attempts / shot_type_totals.fg2.attempts * 100) | round(1) }}%
                  {% else %}0.0%{% endif %}
                </td>

                <td class="px-2 py-1 text-center">{{ d.transition.makes }}-{{ d.transition.attempts }}</td>
                <td class="px-2 py-1 text-center{% if d.transition.attempts > 0 %}{{ (d.transition.makes / d.transition.attempts * 100) | grade_atr2fg_pct(d.transition.attempts) }}{% endif %}">
                  {% if d.transition.attempts > 0 %}{{ (d.transition.makes / d.transition.attempts * 100) | round(1) }}%{% else %}0.0%{% endif %}
                </td>
                <td class="px-2 py-1 text-center{{ d.transition.pps|grade_pps(d.transition.attempts) }}">{{ d.transition.pps | round(2) }}</td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.fg2.attempts > 0 %}
                    {{ (d.transition.attempts / shot_type_totals.fg2.attempts * 100) | round(1) }}%
                  {% else %}0.0%{% endif %}
                </td>

                <td class="px-2 py-1 text-center">{{ d.halfcourt.makes }}-{{ d.halfcourt.attempts }}</td>
                <td class="px-2 py-1 text-center{% if d.halfcourt.attempts > 0 %}{{ (d.halfcourt.makes / d.halfcourt.attempts * 100) | grade_atr2fg_pct(d.halfcourt.attempts) }}{% endif %}">
                  {% if d.halfcourt.attempts > 0 %}{{ (d.halfcourt.makes / d.halfcourt.attempts * 100) | round(1) }}%{% else %}0.0%{% endif %}
                </td>
                <td class="px-2 py-1 text-center{{ d.halfcourt.pps|grade_pps(d.halfcourt.attempts) }}">{{ d.halfcourt.pps | round(2) }}</td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.fg2.attempts > 0 %}
                    {{ (d.halfcourt.attempts / shot_type_totals.fg2.attempts * 100) | round(1) }}%
                  {% else %}0.0%{% endif %}
                </td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
    </div>

    {% set fg3_groups = [
      ('Assisted',        ['Assisted','Non-Assisted']),
      ('Type',            ['Catch and Shoot','Pull Up','Step Back','Catch and Hold','Slide Dribble']),
      ('Line',            ['On The Line','Off The Line']),
      ('Pocket',          ['Shot Pocket','Non-Shot Pocket']),
      ('Move',            ['Stationary','On Move']),
      ('Balance',         ['On Balance','Off Balance']),
      ('Contested',       ['Contested','Uncontested','Late Contest','Blocked']),
      ('Footwork',        ['WTN Left-Right','WTN Right-Left','Left-Right','Right-Left','Hop']),
      ('Good/Bad',        ['Good','Bad','Neutral Three']),
      ('Shrink',          ['Shrink','Non-Shrink']),
      ('Scheme â€“ Attack', ['Beast / Post','DHO / Get','PnR Handler','Iso','Off Closeout','PnR Sneak','Transition Push','OREB Putback']),
      ('Scheme â€“ Drive',  ['Drive Right','Drive Left','Dip']),
      ('Scheme â€“ Pass',   [
        'Swing','Checkdown','Off Screen','1 More','Lift','Drift','Post Entry','Post Pass Out',
        'Kickdown','Slot Skip','Pocket Extra','Lob','Nail Pitch','DHO / Get','PnR Pop','Reshape','Shake','Skip',
        'Pull Behind','Outlet','Press Break','Cross Court','Under OB','Kick Ahead','Dagger','Side / Press OB'
      ])
    ] %}

    <div class="shot-section">
    <div id="fg3" class="detail-content hidden">
      <div class="relative max-h-[600px] overflow-y-auto">
      <table class="min-w-full divide-y divide-gray-200 mb-6">
        <thead class="sticky top-0 bg-white dark:bg-gray-800 z-10 bg-gray-100">
          <tr>
            <th rowspan="2" class="px-4 py-2 text-left">Category</th>
            <th colspan="4" class="px-4 py-2 text-center">Total</th>
            <th colspan="4" class="px-4 py-2 text-center">Transition</th>
            <th colspan="4" class="px-4 py-2 text-center">Half-Court</th>
          </tr>
          <tr>
            {% for _ in range(3) %}
              <th class="px-2 py-1 text-center">FGA</th>
              <th class="px-2 py-1 text-center">FG%</th>
              <th class="px-2 py-1 text-center">PPS</th>
              <th class="px-2 py-1 text-center">Freq%</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for _group_name, cats in fg3_groups %}
            <tr>
              <td colspan="13" class="p-0">
                <div class="h-[2px] bg-[#9E1B32]"></div>
              </td>
            </tr>
            {% for category in cats %}
              {% set d = fg3_summary.cats.get(category, empty_group) %}
              <tr class="{{ loop.cycle('', 'bg-gray-100') }}">
                <td class="px-4 py-2">{{ category }}</td>

                <td class="px-2 py-1 text-center">{{ d.total.makes }}-{{ d.total.attempts }}</td>
                <td class="px-2 py-1 text-center{% if d.total.attempts > 0 %}{{ (d.total.makes / d.total.attempts * 100) | grade_3fg_pct(d.total.attempts) }}{% endif %}">
                  {% if d.total.attempts > 0 %}{{ (d.total.makes / d.total.attempts * 100) | round(1) }}%{% else %}0.0%{% endif %}
                </td>
                <td class="px-2 py-1 text-center{{ d.total.pps|grade_pps(d.total.attempts) }}">{{ d.total.pps | round(2) }}</td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.fg3.attempts > 0 %}
                    {{ (d.total.attempts / shot_type_totals.fg3.attempts * 100) | round(1) }}%
                  {% else %}0.0%{% endif %}
                </td>

                <td class="px-2 py-1 text-center">{{ d.transition.makes }}-{{ d.transition.attempts }}</td>
                <td class="px-2 py-1 text-center{% if d.transition.attempts > 0 %}{{ (d.transition.makes / d.transition.attempts * 100) | grade_3fg_pct(d.transition.attempts) }}{% endif %}">
                  {% if d.transition.attempts > 0 %}{{ (d.transition.makes / d.transition.attempts * 100) | round(1) }}%{% else %}0.0%{% endif %}
                </td>
                <td class="px-2 py-1 text-center{{ d.transition.pps|grade_pps(d.transition.attempts) }}">{{ d.transition.pps | round(2) }}</td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.fg3.attempts > 0 %}
                    {{ (d.transition.attempts / shot_type_totals.fg3.attempts * 100) | round(1) }}%
                  {% else %}0.0%{% endif %}
                </td>

                <td class="px-2 py-1 text-center">{{ d.halfcourt.makes }}-{{ d.halfcourt.attempts }}</td>
                <td class="px-2 py-1 text-center{% if d.halfcourt.attempts > 0 %}{{ (d.halfcourt.makes / d.halfcourt.attempts * 100) | grade_3fg_pct(d.halfcourt.attempts) }}{% endif %}">
                  {% if d.halfcourt.attempts > 0 %}{{ (d.halfcourt.makes / d.halfcourt.attempts * 100) | round(1) }}%{% else %}0.0%{% endif %}
                </td>
                <td class="px-2 py-1 text-center{{ d.halfcourt.pps|grade_pps(d.halfcourt.attempts) }}">{{ d.halfcourt.pps | round(2) }}</td>
                <td class="px-2 py-1 text-center">
                  {% if shot_type_totals.fg3.attempts > 0 %}
                    {{ (d.halfcourt.attempts / shot_type_totals.fg3.attempts * 100) | round(1) }}%
                  {% else %}0.0%{% endif %}
                </td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
  </div>
  </div>
</div>

</div>
</div>
<div id="trends" class="tab-content hidden">
  <canvas id="trendChart" class="w-full h-64"></canvas>
</div>
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
<script>
const trendData = {{ trend_rows|tojson }};
const trendStats = {{ trend_selected_stats|tojson }};
let trendChartInstance = null;

function buildTrendChart(){
  if(!window.Chart) return;
  const canvas = document.getElementById('trendChart');
  if(!canvas) return;
  const labels = trendData.map(d => {
    const [y,m,day] = d.date.split('-').map(Number);
    const dt = new Date(y, m-1, day);
    return dt.toLocaleDateString('en-US',{month:'long', day:'numeric'});
  });
  const generateColor = (idx, total) => {
    const segments = total || 1;
    const hue = Math.round((360 / segments) * idx);
    return `hsl(${hue}, 70%, 50%)`;
  };
  const datasets = trendStats.map((s, i) => ({
    label: s,
    data: trendData.map(d => d[s] || 0),
    borderColor: generateColor(i, trendStats.length),
    backgroundColor: generateColor(i, trendStats.length),
    fill: false
  }));
  trendChartInstance = new Chart(canvas, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        x: {
          title: { display: true, text: 'Date' },
          grid: { color: '#e5e7eb' }
        },
        y: {
          title: { display: true, text: 'Value' },
          grid: { color: '#e5e7eb' }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
          }
        },
        legend: {
          display: true,
          onClick: (e, legendItem, legend) => {
            const index = legendItem.datasetIndex;
            const ci = legend.chart;
            const meta = ci.getDatasetMeta(index);
            meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
            ci.update();
          }
        }
      }
    }
  });
}
</script>
<script>
const TAB_IDS=['seasonTotals','gameStats','lineupEfficiency','shotType','trends'];
const BUTTON_IDS=['btnSeasonTotals','btnGameStats','btnLineupEfficiency','btnShotType','btnTrends'];
function capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);}
function showTab(tabName){
  TAB_IDS.forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.classList.toggle('hidden',id!==tabName);
    el.classList.toggle('block',id===tabName);
  });
  const tc=document.getElementById('trendControls');
  const mc=document.getElementById('mainControls');
  if(tc){tc.classList.toggle('hidden',tabName!=='trends');}
  if(mc){mc.classList.toggle('hidden',tabName==='trends');}
  BUTTON_IDS.forEach(btnId=>{
    const b=document.getElementById(btnId);
    if(!b) return;
    if(btnId.toLowerCase().endsWith(tabName.toLowerCase())){
      b.classList.add('bg-[#9E1B32]','text-white');
      b.classList.remove('border-gray-300','bg-white','text-gray-700');
    }else{
      b.classList.remove('bg-[#9E1B32]','text-white');
      b.classList.add('border-gray-300','bg-white','text-gray-700');
    }
  });
  window.location.hash = tabName;
  if(tabName==='shotType'){showShotTypeDetail('atr');}
  if(tabName==='trends'){
    if(!trendChartInstance){
      buildTrendChart();
    }else{
      trendChartInstance.resize();
      trendChartInstance.update();
    }
  }
}
function showShotTypeDetail(detail){
  ['atr','fg2','fg3'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.classList.toggle('hidden',id!==detail);el.classList.toggle('block',id===detail);}
  });
  const map={atr:'ATR',fg2:'FG2',fg3:'FG3'};
  Object.entries(map).forEach(([t,s])=>{
    const card=document.getElementById('card'+s);
    if(!card)return;
    if(t===detail){
      card.classList.replace('bg-white','bg-gray-100');
      card.classList.replace('dark:bg-gray-800','dark:bg-gray-700');
      card.classList.replace('shadow-md','shadow-inner');
    }else{
      card.classList.replace('bg-gray-100','bg-white');
      card.classList.replace('dark:bg-gray-700','dark:bg-gray-800');
      card.classList.replace('shadow-inner','shadow-md');
    }
  });
}
function filterTrendStats(query){
  const q = query.toLowerCase();
  document.querySelectorAll('#trend_stat_list label').forEach(lbl=>{
    const text = lbl.textContent.toLowerCase();
    lbl.style.display = text.includes(q) ? '' : 'none';
  });
}
document.addEventListener('DOMContentLoaded',()=>{
  const hash=window.location.hash.replace('#','');
  if(TAB_IDS.includes(hash)){
    showTab(hash);
  }else{
    showTab('seasonTotals');
  }
  ['mainFilterForm','trendFilterForm','gameTypeFilterForm'].forEach(formId=>{
    const form=document.getElementById(formId);
    if(form){
      form.addEventListener('submit',()=>{
        const base=(form.action||window.location.href).split('#')[0];
        form.action=base+window.location.hash;
      });
    }
  });
  document.querySelectorAll('.mode-link').forEach(link=>{
    const base=link.href.split('#')[0];
    link.href=base+window.location.hash;
  });
  const lineupSizeBtns = document.querySelectorAll('.lineup-size-btn');
  const lineupSizePanels = document.querySelectorAll('.lineup-size-panel');
  const setLineupSize = (size, activeBtn) => {
    lineupSizeBtns.forEach(btn => {
      btn.classList.remove('bg-[#9E1B32]','text-white');
      btn.classList.add('bg-gray-100','text-gray-700');
    });
    if (activeBtn) {
      activeBtn.classList.remove('bg-gray-100','text-gray-700');
      activeBtn.classList.add('bg-[#9E1B32]','text-white');
    }
    lineupSizePanels.forEach(panel => {
      panel.classList.toggle('hidden', panel.dataset.size !== size);
    });
  };
  lineupSizeBtns.forEach(btn => {
    btn.addEventListener('click', () => setLineupSize(btn.dataset.size, btn));
  });
  const defaultLineupBtn = Array.from(lineupSizeBtns).find(btn => btn.dataset.hasData === 'true') || lineupSizeBtns[0];
  if (defaultLineupBtn) {
    setLineupSize(defaultLineupBtn.dataset.size, defaultLineupBtn);
  }
  if(window.Chart && document.getElementById('trendChart')){
    const labels = trendData.map(d => {
      const [y,m,day] = d.date.split('-').map(Number);
      const dt = new Date(y, m-1, day);
      return dt.toLocaleDateString('en-US',{month:'long', day:'numeric'});
    });
    const generateColor = (idx, total) => {
      const hue = Math.round((360 / total) * idx);
      return `hsl(${hue}, 70%, 50%)`;
    };
    const datasets = trendStats.map((s, i) => ({
      label: s,
      data: trendData.map(d => d[s] || 0),
      borderColor: generateColor(i, trendStats.length),
      backgroundColor: generateColor(i, trendStats.length),
      fill: false
    }));
    new Chart(document.getElementById('trendChart'), {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          x: {
            title: { display: true, text: 'Date' },
            grid: { color: '#e5e7eb' }
          },
          y: {
            title: { display: true, text: 'Value' },
            grid: { color: '#e5e7eb' }
          }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
            }
          },
          legend: {
            display: true,
            onClick: (e, legendItem, legend) => {
              const index = legendItem.datasetIndex;
              const ci = legend.chart;
              const meta = ci.getDatasetMeta(index);
              meta.hidden = meta.hidden === null ? !ci.data.datasets[index].hidden : null;
              ci.update();
            }
          }
        }
      }
    });
  }
});
</script>
{% endblock %}
