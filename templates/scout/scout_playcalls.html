{% extends 'base.html' %}

{% block page_class %}page--scout-playcalls container--wide{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-8">
  <h1 class="text-2xl font-bold">Scout Playcalls</h1>
  <a
    href="{{ url_for('scout.scout_playcalls_upload') }}"
    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
  >
    Upload Playcalls CSV
  </a>
</div>

<div class="space-y-4">
  <h2 class="text-xl font-semibold">Generate Scout Report</h2>
  <form method="get" action="{{ url_for('scout.scout_playcalls') }}" class="space-y-4 border border-gray-200 rounded p-4 bg-white shadow-sm">
    <div class="grid md:grid-cols-3 gap-4 items-end">
      <div>
        <label class="block text-sm font-medium mb-1" for="team_filter">Team</label>
        <select
          id="team_filter"
          name="team_id"
          class="w-full border border-gray-300 rounded px-3 py-2"
          onchange="this.form.submit()"
        >
          <option value="">-- Select Team --</option>
          {% for team in teams %}
            <option value="{{ team.id }}" {% if selected_team and selected_team.id == team.id %}selected{% endif %}>
              {{ team.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1" for="min_runs">Min Runs</label>
        <input
          type="number"
          id="min_runs"
          name="min_runs"
          value="{{ min_runs or 1 }}"
          min="1"
          class="w-full border border-gray-300 rounded px-3 py-2"
        />
      </div>
      <div class="self-start flex gap-2">
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          Generate Report
        </button>
        <button
          type="submit"
          formaction="{{ url_for('scout.export_playcalls_csv') }}"
          formmethod="get"
          class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Export CSV
        </button>
      </div>
    </div>

    {% if selected_team %}
      <div>
        <h3 class="text-lg font-semibold mb-2">Available Scout Games</h3>
        {% if games %}
          <div class="border border-gray-200 rounded">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original Filename</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stored Filename</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for game in games %}
                  <tr>
                    <td class="px-4 py-2">
                      <input
                        type="checkbox"
                        name="game_ids"
                        value="{{ game.id }}"
                        {% if game.id in selected_game_ids %}checked{% endif %}
                      />
                    </td>
                    <td class="px-4 py-2">{{ game.uploaded_at|date('%Y-%m-%d %H:%M') }}</td>
                    <td class="px-4 py-2">{{ game.original_filename }}</td>
                    <td class="px-4 py-2">{{ game.stored_filename }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-sm text-gray-600">No scout games uploaded for this team yet.</p>
        {% endif %}
      </div>
    {% else %}
      <p class="text-sm text-gray-600">Select a team to view uploaded scout games.</p>
    {% endif %}
  </form>

  {% set standard_rows = report_rows.get('STANDARD', []) if report_rows is defined else [] %}
  {% set bob_rows = report_rows.get('BOB', []) if report_rows is defined else [] %}
  {% set sob_rows = report_rows.get('SOB', []) if report_rows is defined else [] %}

  {% if selected_game_ids %}
    {% if standard_rows or bob_rows or sob_rows %}
      <div class="space-y-6">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Scout Playcall Report</h3>
          <p class="text-sm text-gray-600">Minimum runs: {{ min_runs }}</p>
        </div>

        {% for bucket_label, rows in [('STANDARD', standard_rows), ('BOB', bob_rows), ('SOB', sob_rows)] %}
          <div class="border border-gray-200 rounded bg-white shadow-sm">
            <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
              <h4 class="text-md font-semibold">{{ bucket_label }} Playcalls</h4>
              <p class="text-sm text-gray-600">Sorted by Times Run then PPC</p>
            </div>
            {% if rows %}
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none"
                        data-sort-key="playcall"
                        data-sort-type="text"
                      >
                        <div class="flex items-center gap-1">
                          Playcall
                          <span class="sort-indicator text-gray-400">↕</span>
                        </div>
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none"
                        data-sort-key="times_run"
                        data-sort-type="number"
                        data-sort-direction="desc"
                      >
                        <div class="flex items-center gap-1">
                          Times Run
                          <span class="sort-indicator text-gray-400">↓</span>
                        </div>
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none"
                        data-sort-key="total_points"
                        data-sort-type="number"
                      >
                        <div class="flex items-center gap-1">
                          Total Points
                          <span class="sort-indicator text-gray-400">↕</span>
                        </div>
                      </th>
                      <th
                        class="px-4 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider cursor-pointer select-none"
                        data-sort-key="ppc"
                        data-sort-type="number"
                      >
                        <div class="flex items-center gap-1">
                          PPC
                          <span class="sort-indicator text-gray-400">↕</span>
                        </div>
                      </th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    {% for row in rows %}
                      {% set playcall_lower = row.playcall|lower %}
                      {% if not (playcall_lower.startswith('eog') or playcall_lower.startswith('ft') or playcall_lower.startswith('vs')) %}
                        <tr>
                          <td class="px-4 py-2">{{ row.playcall }}</td>
                          <td class="px-4 py-2">{{ row.times_run }}</td>
                          <td class="px-4 py-2">{{ row.total_points }}</td>
                          <td class="px-4 py-2">{{ '%.2f'|format(row.ppc) }}</td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="px-4 py-3 text-sm text-gray-600">No playcalls match the filters for this bucket.</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded text-gray-700">
        <p class="font-semibold">No playcalls found for the selected games with the current filters.</p>
      </div>
    {% endif %}
  {% else %}
    <div class="p-4 bg-gray-50 border border-dashed border-gray-300 rounded text-gray-700">
      <p class="font-semibold">Select one or more scout games and generate the report to see results.</p>
    </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tables = document.querySelectorAll('table');

    tables.forEach((table) => {
      const headers = table.querySelectorAll('[data-sort-key]');
      if (!headers.length) return;

      headers.forEach((header) => {
        header.addEventListener('click', () => {
          const sortType = header.dataset.sortType || 'text';
          const currentDirection = header.dataset.sortDirection === 'asc' ? 'asc' : 'desc';
          const nextDirection = currentDirection === 'asc' ? 'desc' : 'asc';
          const tbody = table.querySelector('tbody');
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const columnIndex = header.cellIndex;

          rows.sort((a, b) => {
            const aText = a.children[columnIndex].textContent.trim();
            const bText = b.children[columnIndex].textContent.trim();

            const aValue = sortType === 'number' ? parseFloat(aText) || 0 : aText.toLowerCase();
            const bValue = sortType === 'number' ? parseFloat(bText) || 0 : bText.toLowerCase();

            if (aValue < bValue) return nextDirection === 'asc' ? -1 : 1;
            if (aValue > bValue) return nextDirection === 'asc' ? 1 : -1;
            return 0;
          });

          rows.forEach((row) => tbody.appendChild(row));

          headers.forEach((sibling) => {
            sibling.dataset.sortDirection = sibling === header ? nextDirection : '';
            const indicator = sibling.querySelector('.sort-indicator');
            if (!indicator) return;
            if (sibling !== header) {
              indicator.textContent = '↕';
              indicator.classList.remove('text-gray-700');
              indicator.classList.add('text-gray-400');
            } else {
              indicator.textContent = nextDirection === 'asc' ? '↑' : '↓';
              indicator.classList.remove('text-gray-400');
              indicator.classList.add('text-gray-700');
            }
          });
        });
      });
    });
  });
</script>
{% endblock %}
