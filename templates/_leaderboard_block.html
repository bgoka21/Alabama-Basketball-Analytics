<h1 class="text-3xl font-bold mb-6">Season Leaderboard</h1>

<form method="get" class="mb-4">
  <label for="stat-select">Stat:</label>
  <select id="stat-select" name="stat" onchange="this.form.submit()">
    {% for s in stats_config if not s.get('hidden') %}
      <option value="{{ s.key }}" {% if s.key==selected.key %}selected{% endif %}>
        {{ s.label }}
      </option>
    {% endfor %}
  </select>
  <input type="hidden" name="season_id" value="{{ selected_season }}">
  <input type="hidden" name="start_date" value="{{ start_date }}">
  <input type="hidden" name="end_date" value="{{ end_date }}">
  {% for lbl in selected_labels %}
    <input type="hidden" name="label" value="{{ lbl }}">
  {% endfor %}
</form>

<div class="overflow-x-auto">
  {% if selected.key == 'defense' %}
    <table class="min-w-full bg-white rounded-lg shadow border text-center">
      <thead>
        <tr class="bg-gray-100">
          <th class="px-4 py-2 text-center sortable" rowspan="2" data-col="0">#</th>
          <th class="px-4 py-2 text-left sortable" rowspan="2" data-col="1">Player</th>
          <th class="px-4 py-2 text-center" colspan="3">Collisions</th>
        </tr>
        <tr class="bg-gray-100">
          <th class="px-4 py-2 text-center sortable" data-col="2">Bump +</th>
          <th class="px-4 py-2 text-center sortable" data-col="3">Bump Opps</th>
          <th class="px-4 py-2 text-center sortable" data-col="4">Bump %</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for row in rows %}
          <tr class="even:bg-gray-50">
            <td class="px-4 py-2 text-center">{{ loop.index }}</td>
            {% set player, bump_pos, opps, pct = row %}
            <td class="px-4 py-2 text-left">{{ player }}</td>
            <td class="px-4 py-2 text-center">{{ bump_pos }}</td>
            <td class="px-4 py-2 text-center">{{ opps }}</td>
            <td class="px-4 py-2 text-center">{{ pct|round(1) }}%</td>
          </tr>
        {% endfor %}
        {% if team_totals %}
          <tr class="font-bold bg-gray-100 team-totals">
            <td class="px-4 py-2 text-center"></td>
            <td class="px-4 py-2 text-left">Team Totals</td>
            <td class="px-4 py-2 text-center">{{ team_totals[0] }}</td>
            <td class="px-4 py-2 text-center">{{ team_totals[1] }}</td>
            <td class="px-4 py-2 text-center">{{ team_totals[2]|round(1) }}%</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  {% elif selected.key == 'off_rebounding' %}
    <div class="space-y-8">
      <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
        <div>
          <h3 class="text-lg font-semibold mb-2">Offensive Crash</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg shadow border text-center">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-center sortable" data-col="0">#</th>
                  <th class="px-4 py-2 text-left sortable" data-col="1">Player</th>
                  <th class="px-4 py-2 text-center sortable" data-col="2">Crash +</th>
                  <th class="px-4 py-2 text-center sortable" data-col="3">Crash Att</th>
                  <th class="px-4 py-2 text-center sortable" data-col="4">Crash %</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for row in crash_rows or [] %}
                  {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                  {% set plus = row.get('plus', 0) %}
                  {% set opps = row.get('opps', 0) %}
                  {% set pct = row.get('pct') %}
                  <tr>
                    <td class="px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="px-4 py-2 text-left">{{ name }}</td>
                    <td class="px-4 py-2 text-center">{{ plus }}</td>
                    <td class="px-4 py-2 text-center">{{ opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if pct is not none %}
                        {{ pct|round(1) }}%
                      {% elif opps %}
                        {{ (plus / opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                {% if crash_totals %}
                  {% set t_plus = crash_totals.get('plus', 0) %}
                  {% set t_opps = crash_totals.get('opps', 0) %}
                  {% set t_pct = crash_totals.get('pct') %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="px-4 py-2 text-center"></td>
                    <td class="px-4 py-2 text-left">Team Totals</td>
                    <td class="px-4 py-2 text-center">{{ t_plus }}</td>
                    <td class="px-4 py-2 text-center">{{ t_opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if t_pct is not none %}
                        {{ t_pct|round(1) }}%
                      {% elif t_opps %}
                        {{ (t_plus / t_opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">Back Man</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg shadow border text-center">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-center sortable" data-col="0">#</th>
                  <th class="px-4 py-2 text-left sortable" data-col="1">Player</th>
                  <th class="px-4 py-2 text-center sortable" data-col="2">Back Man +</th>
                  <th class="px-4 py-2 text-center sortable" data-col="3">Back Man Att</th>
                  <th class="px-4 py-2 text-center sortable" data-col="4">Back Man %</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for row in backman_rows or [] %}
                  {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                  {% set plus = row.get('plus', 0) %}
                  {% set opps = row.get('opps', 0) %}
                  {% set pct = row.get('pct') %}
                  <tr>
                    <td class="px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="px-4 py-2 text-left">{{ name }}</td>
                    <td class="px-4 py-2 text-center">{{ plus }}</td>
                    <td class="px-4 py-2 text-center">{{ opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if pct is not none %}
                        {{ pct|round(1) }}%
                      {% elif opps %}
                        {{ (plus / opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                {% if backman_totals %}
                  {% set t_plus = backman_totals.get('plus', 0) %}
                  {% set t_opps = backman_totals.get('opps', 0) %}
                  {% set t_pct = backman_totals.get('pct') %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="px-4 py-2 text-center"></td>
                    <td class="px-4 py-2 text-left">Team Totals</td>
                    <td class="px-4 py-2 text-center">{{ t_plus }}</td>
                    <td class="px-4 py-2 text-center">{{ t_opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if t_pct is not none %}
                        {{ t_pct|round(1) }}%
                      {% elif t_opps %}
                        {{ (t_plus / t_opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
  {% elif selected.key == 'def_rebounding' %}
    <table class="min-w-full bg-white rounded-lg shadow border text-center">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-center sortable" rowspan="2" data-col="0">#</th>
          <th class="px-4 py-2 text-left sortable" rowspan="2" data-col="1">Player</th>
          <th class="px-4 py-2 text-center" colspan="3">Box Out</th>
          <th class="px-4 py-2 text-center sortable" rowspan="2" data-col="5">Off Reb's<br>Given Up</th>
        </tr>
        <tr>
          <th class="px-4 py-2 text-center sortable" data-col="2">Box Out +</th>
          <th class="px-4 py-2 text-center sortable" data-col="3">Box Out Opp</th>
          <th class="px-4 py-2 text-center sortable" data-col="4">Box Out %</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        {% for row in rows %}
          {# row = (player, box_plus, box_opp, box_pct, given_up) #}
          <tr>
            <td class="px-4 py-2 text-center">{{ loop.index }}</td>
            <td class="px-4 py-2 text-left">{{ row[0] }}</td>
            <td class="px-4 py-2 text-center">{{ row[1] }}</td>
            <td class="px-4 py-2 text-center">{{ row[2] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (row[3] is not none) and (row[3]|round(1)|string + '%') or 'NA' }}
            </td>
            <td class="px-4 py-2 text-center">{{ row[4] }}</td>
          </tr>
        {% endfor %}
        {% if team_totals %}
          {# team_totals = (box_plus, box_opp, box_pct, given_up) #}
          <tr class="bg-gray-100 font-semibold team-totals">
            <td class="px-4 py-2 text-center"></td>
            <td class="px-4 py-2 text-left">Team Totals</td>
            <td class="px-4 py-2 text-center">{{ team_totals[0] }}</td>
            <td class="px-4 py-2 text-center">{{ team_totals[1] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (team_totals[2] is not none) and (team_totals[2]|round(1)|string + '%') or 'NA' }}
            </td>
            <td class="px-4 py-2 text-center">{{ team_totals[3] }}</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  {% elif selected.key == 'collision_gap_help' %}
    <table class="min-w-full bg-white rounded-lg shadow border text-center">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-center sortable" rowspan="2" data-col="0">#</th>
          <th class="px-4 py-2 text-left sortable" rowspan="2" data-col="1">Player</th>
          <th class="px-4 py-2 text-center" colspan="3">Gap Help</th>
        </tr>
        <tr>
          <th class="px-4 py-2 text-center sortable" data-col="2">Gap +</th>
          <th class="px-4 py-2 text-center sortable" data-col="3">Gap Opp</th>
          <th class="px-4 py-2 text-center sortable" data-col="4">Gap %</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        {% for row in rows %}
          {# row = (player, gap_plus, gap_opp, gap_pct) #}
          <tr>
            <td class="px-4 py-2 text-center">{{ loop.index }}</td>
            <td class="px-4 py-2 text-left">{{ row[0] }}</td>
            <td class="px-4 py-2 text-center">{{ row[1] }}</td>
            <td class="px-4 py-2 text-center">{{ row[2] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (row[3] is not none) and (row[3]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endfor %}
        {% if team_totals %}
          {# team_totals = (gap_plus, gap_opp, gap_pct) #}
          <tr class="bg-gray-100 font-semibold team-totals">
            <td class="px-4 py-2 text-center"></td>
            <td class="px-4 py-2 text-left">Team Totals</td>
            <td class="px-4 py-2 text-center">{{ team_totals[0] }}</td>
            <td class="px-4 py-2 text-center">{{ team_totals[1] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (team_totals[2] is not none) and (team_totals[2]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  {% elif selected.key == 'pnr_gap_help' %}
    <table class="min-w-full bg-white rounded-lg shadow border text-center">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-2 text-center sortable" rowspan="2" data-col="0">#</th>
          <th class="px-4 py-2 text-left sortable" rowspan="2" data-col="1">Player</th>
          <th class="px-4 py-2 text-center" colspan="3">PnR Gap Help</th>
          <th class="px-4 py-2 text-center" colspan="3">Low Help</th>
        </tr>
        <tr>
          <th class="px-4 py-2 text-center sortable" data-col="2">PnR Gap +</th>
          <th class="px-4 py-2 text-center sortable" data-col="3">PnR Gap Opp</th>
          <th class="px-4 py-2 text-center sortable" data-col="4">PnR Gap %</th>
          <th class="px-4 py-2 text-center sortable" data-col="5">Low +</th>
          <th class="px-4 py-2 text-center sortable" data-col="6">Low Opp</th>
          <th class="px-4 py-2 text-center sortable" data-col="7">Low %</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-100">
        {% for row in rows %}
          {# row = (player, gap_plus, gap_opp, gap_pct, low_plus, low_opp, low_pct) #}
          <tr>
            <td class="px-4 py-2 text-center">{{ loop.index }}</td>
            <td class="px-4 py-2 text-left">{{ row[0] }}</td>
            <td class="px-4 py-2 text-center">{{ row[1] }}</td>
            <td class="px-4 py-2 text-center">{{ row[2] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (row[3] is not none) and (row[3]|round(1)|string + '%') or 'NA' }}
            </td>
            <td class="px-4 py-2 text-center">{{ row[4] }}</td>
            <td class="px-4 py-2 text-center">{{ row[5] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (row[6] is not none) and (row[6]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endfor %}
        {% if team_totals %}
          {# team_totals = (gap_plus, gap_opp, gap_pct, low_plus, low_opp, low_pct) #}
          <tr class="bg-gray-100 font-semibold team-totals">
            <td class="px-4 py-2 text-center"></td>
            <td class="px-4 py-2 text-left">Team Totals</td>
            <td class="px-4 py-2 text-center">{{ team_totals[0] }}</td>
            <td class="px-4 py-2 text-center">{{ team_totals[1] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (team_totals[2] is not none) and (team_totals[2]|round(1)|string + '%') or 'NA' }}
            </td>
            <td class="px-4 py-2 text-center">{{ team_totals[3] }}</td>
            <td class="px-4 py-2 text-center">{{ team_totals[4] }}</td>
            <td class="px-4 py-2 text-center">
              {{ (team_totals[5] is not none) and (team_totals[5]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  {% elif selected.key == 'pnr_grade' %}
    <div class="space-y-8">
      <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
        <div>
          <h3 class="text-lg font-semibold mb-2">Close Window</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg shadow border text-center">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-center sortable" data-col="0">#</th>
                  <th class="px-4 py-2 text-left sortable" data-col="1">Player</th>
                  <th class="px-4 py-2 text-center sortable" data-col="2">Close Window +</th>
                  <th class="px-4 py-2 text-center sortable" data-col="3">Close Window Att</th>
                  <th class="px-4 py-2 text-center sortable" data-col="4">Close Window %</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for row in close_rows or [] %}
                  {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                  {% set plus = row.get('plus', 0) %}
                  {% set opps = row.get('opps', 0) %}
                  {% set pct = row.get('pct') %}
                  <tr>
                    <td class="px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="px-4 py-2 text-left">{{ name }}</td>
                    <td class="px-4 py-2 text-center">{{ plus }}</td>
                    <td class="px-4 py-2 text-center">{{ opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if pct is not none %}
                        {{ pct|round(1) }}%
                      {% elif opps %}
                        {{ (plus / opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                {% if close_totals %}
                  {% set t_plus = close_totals.get('plus', 0) %}
                  {% set t_opps = close_totals.get('opps', 0) %}
                  {% set t_pct = close_totals.get('pct') %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="px-4 py-2 text-center"></td>
                    <td class="px-4 py-2 text-left">Team Totals</td>
                    <td class="px-4 py-2 text-center">{{ t_plus }}</td>
                    <td class="px-4 py-2 text-center">{{ t_opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if t_pct is not none %}
                        {{ t_pct|round(1) }}%
                      {% elif t_opps %}
                        {{ (t_plus / t_opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-2">Shut Door</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg shadow border text-center">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-center sortable" data-col="0">#</th>
                  <th class="px-4 py-2 text-left sortable" data-col="1">Player</th>
                  <th class="px-4 py-2 text-center sortable" data-col="2">Shut Door +</th>
                  <th class="px-4 py-2 text-center sortable" data-col="3">Shut Door Att</th>
                  <th class="px-4 py-2 text-center sortable" data-col="4">Shut Door %</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for row in shut_rows or [] %}
                  {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                  {% set plus = row.get('plus', 0) %}
                  {% set opps = row.get('opps', 0) %}
                  {% set pct = row.get('pct') %}
                  <tr>
                    <td class="px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="px-4 py-2 text-left">{{ name }}</td>
                    <td class="px-4 py-2 text-center">{{ plus }}</td>
                    <td class="px-4 py-2 text-center">{{ opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if pct is not none %}
                        {{ pct|round(1) }}%
                      {% elif opps %}
                        {{ (plus / opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                {% if shut_totals %}
                  {% set t_plus = shut_totals.get('plus', 0) %}
                  {% set t_opps = shut_totals.get('opps', 0) %}
                  {% set t_pct = shut_totals.get('pct') %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="px-4 py-2 text-center"></td>
                    <td class="px-4 py-2 text-left">Team Totals</td>
                    <td class="px-4 py-2 text-center">{{ t_plus }}</td>
                    <td class="px-4 py-2 text-center">{{ t_opps }}</td>
                    <td class="px-4 py-2 text-center">
                      {% if t_pct is not none %}
                        {{ t_pct|round(1) }}%
                      {% elif t_opps %}
                        {{ (t_plus / t_opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
  {% else %}
    <table class="min-w-full bg-white rounded-lg shadow border text-center">
      <thead>
        <tr class="bg-gray-100">
          <th class="px-4 py-2 text-center sortable" data-col="0">#</th>
          <th class="px-4 py-2 text-left sortable" data-col="1">Player</th>
          {% if selected.key == 'assist_summary' %}
            <th class="px-4 py-2 text-center sortable" data-col="2">Ast</th>
            <th class="px-4 py-2 text-center sortable" data-col="3">Pot Ast</th>
            <th class="px-4 py-2 text-center sortable" data-col="4">2nd Ast</th>
            <th class="px-4 py-2 text-center sortable" data-col="5">TO</th>
            <th class="px-4 py-2 text-center sortable" data-col="6">AST/TO</th>
            <th class="px-4 py-2 text-center sortable" data-col="7">Adj AST/TO</th>
          {% elif selected.key == 'offense_summary' %}
            <th class="px-4 py-2 text-center sortable" data-col="2">Poss</th>
            <th class="px-4 py-2 text-center sortable" data-col="3">PPP On</th>
            <th class="px-4 py-2 text-center sortable" data-col="4">PPP Off</th>
            <th class="px-4 py-2 text-center sortable" data-col="5">Ind TO Rate (Poss.)</th>
            <th class="px-4 py-2 text-center sortable" data-col="6">TO % (Bamalytics)</th>
            <th class="px-4 py-2 text-center sortable" data-col="7">% of TO's (NBA.com)</th>
            <th class="px-4 py-2 text-center sortable" data-col="8">Team TO Rate</th>
            <th class="px-4 py-2 text-center sortable" data-col="9">Ind Off Reb%</th>
            <th class="px-4 py-2 text-center sortable" data-col="10">Off Reb Rate</th>
            <th class="px-4 py-2 text-center sortable" data-col="11">Ind Fouls Drawn%</th>
            <th class="px-4 py-2 text-center sortable" data-col="12">Fouls Rate</th>
          {% elif selected.key.endswith('_fg_pct') %}
            <th class="px-4 py-2 text-center sortable" data-col="2">FG</th>
            <th class="px-4 py-2 text-center sortable" data-col="3">FG%</th>
            <th class="px-4 py-2 text-center sortable" data-col="4">Freq</th>
          {% else %}
            <th class="px-4 py-2 text-center sortable" data-col="2">{{ selected.label }}</th>
          {% endif %}
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {% for row in rows %}
          <tr class="even:bg-gray-50">
            <td class="px-4 py-2 text-center">{{ loop.index }}</td>
            {% if selected.key == 'assist_summary' %}
              {% set player, ast, pot, sec, tos, ratio, adj = row %}
              <td class="px-4 py-2 text-left">{{ player }}</td>
              <td class="px-4 py-2 text-center">{{ ast }}</td>
              <td class="px-4 py-2 text-center">{{ pot }}</td>
              <td class="px-4 py-2 text-center">{{ sec }}</td>
              <td class="px-4 py-2 text-center">{{ tos }}</td>
              <td class="px-4 py-2 text-center">{{ ratio }}</td>
              <td class="px-4 py-2 text-center">{{ adj }}</td>
            {% elif selected.key == 'offense_summary' %}
              {% set player, poss, ppp_on, ppp_off, ind_to, bama_to, team_to_pct, to_rate, ind_oreb, oreb_rate, ind_foul, foul_rate = row %}
              <td class="px-4 py-2 text-left">{{ player }}</td>
              <td class="px-4 py-2 text-center">{{ poss }}</td>
              <td class="px-4 py-2 text-center">{{ ppp_on }}</td>
              <td class="px-4 py-2 text-center">{{ ppp_off }}</td>
              <td class="px-4 py-2 text-center">{{ ind_to }}</td>
              <td class="px-4 py-2 text-center">{{ bama_to }}</td>
              <td class="px-4 py-2 text-center">{{ team_to_pct }}</td>
              <td class="px-4 py-2 text-center">{{ to_rate }}</td>
              <td class="px-4 py-2 text-center">{{ ind_oreb }}</td>
              <td class="px-4 py-2 text-center">{{ oreb_rate }}</td>
              <td class="px-4 py-2 text-center">{{ ind_foul }}</td>
              <td class="px-4 py-2 text-center">{{ foul_rate }}</td>
            {% elif selected.key.endswith('_fg_pct') %}
              {% set player, makes, attempts, pct, freq = row %}
              <td class="px-4 py-2 text-left">{{ player }}</td>
              <td class="px-4 py-2 text-center">{{ makes }}-{{ attempts }}</td>
              <td class="px-4 py-2 text-center">{{ pct|round(1) }}%</td>
              <td class="px-4 py-2 text-center">{{ freq|round(1) }}%</td>
            {% else %}
              {% set player, val = row %}
              <td class="px-4 py-2 text-left">{{ player }}</td>
              <td class="px-4 py-2">
                {% if selected.format=='pct' %}
                  {{ val|round(1) }}%
                {% else %}
                  {{ val }}
                {% endif %}
              </td>
            {% endif %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>
<script>
  (function () {
    const script = document.currentScript;
    const container = script && script.previousElementSibling;
    if (!container) {
      return;
    }

    const tables = container.querySelectorAll('table');

    tables.forEach(table => {
      const tbody = table.querySelector('tbody');
      if (!tbody) {
        return;
      }

      const headers = table.querySelectorAll('th.sortable');

      headers.forEach(header => {
        header.dataset.order = header.dataset.order || 'none';
        header.classList.add('cursor-pointer', 'select-none');

        let indicator = header.querySelector('.sort-indicator');
        if (!indicator) {
          indicator = document.createElement('span');
          indicator.className = 'ml-1 text-xs text-gray-400 sort-indicator';
          indicator.textContent = '▲▼';
          header.appendChild(indicator);
        } else {
          indicator.textContent = '▲▼';
          indicator.classList.remove('text-gray-600');
          indicator.classList.add('text-gray-400');
        }

        header.addEventListener('click', () => {
          const columnIndex = header.dataset.col ? parseInt(header.dataset.col, 10) : header.cellIndex;
          if (Number.isNaN(columnIndex)) {
            return;
          }

          const newOrder = header.dataset.order === 'asc' ? 'desc' : 'asc';
          const descending = newOrder === 'desc';
          const totalRow = tbody.querySelector('.team-totals');

          if (totalRow) {
            totalRow.remove();
          }

          const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.classList.contains('team-totals'));

          rows.sort((rowA, rowB) => compareRows(rowA, rowB, columnIndex, descending));

          const shouldUpdateRank = columnIndex !== 0;

          rows.forEach((row, index) => {
            if (shouldUpdateRank && row.children[0]) {
              row.children[0].textContent = index + 1;
            }
            tbody.appendChild(row);
          });

          if (totalRow) {
            tbody.appendChild(totalRow);
          }

          updateHeaderStates(headers, header, newOrder);
        });
      });
    });

    function compareRows(rowA, rowB, columnIndex, descending) {
      const cellA = rowA.children[columnIndex];
      const cellB = rowB.children[columnIndex];

      const valueA = extractValue(cellA ? cellA.textContent : '');
      const valueB = extractValue(cellB ? cellB.textContent : '');

      let comparison;
      if (valueA.type === 'number' && valueB.type === 'number') {
        comparison = valueA.value - valueB.value;
      } else if (valueA.type === 'number') {
        comparison = -1;
      } else if (valueB.type === 'number') {
        comparison = 1;
      } else {
        comparison = valueA.value.localeCompare(valueB.value, undefined, { sensitivity: 'base' });
      }

      if (comparison === 0) {
        return 0;
      }

      return descending ? -comparison : comparison;
    }

    function extractValue(text) {
      const trimmed = text.trim();
      if (!trimmed || trimmed.toUpperCase() === 'NA') {
        return { type: 'number', value: Number.NEGATIVE_INFINITY };
      }

      const numericText = trimmed.replace(/[^0-9.+-]+/g, '');
      const numericValue = numericText ? parseFloat(numericText) : NaN;

      if (!Number.isNaN(numericValue)) {
        return { type: 'number', value: numericValue };
      }

      return { type: 'string', value: trimmed.toLowerCase() };
    }

    function updateHeaderStates(headers, activeHeader, order) {
      headers.forEach(header => {
        const indicator = header.querySelector('.sort-indicator');
        if (!indicator) {
          return;
        }

        if (header === activeHeader) {
          header.dataset.order = order;
          header.setAttribute('aria-sort', order === 'asc' ? 'ascending' : 'descending');
          indicator.textContent = order === 'asc' ? '▲' : '▼';
          indicator.classList.remove('text-gray-400');
          indicator.classList.add('text-gray-600');
        } else {
          header.dataset.order = 'none';
          header.removeAttribute('aria-sort');
          indicator.textContent = '▲▼';
          indicator.classList.remove('text-gray-600');
          indicator.classList.add('text-gray-400');
        }
      });
    }
  })();
</script>
