{% from "macros/dual_tables.html" import render_grouped_last_practice_header, td_stat %}

<h1 class="text-3xl font-bold mb-6">Season Leaderboard</h1>

<form method="get" class="mb-4">
  <label for="stat-select">Stat:</label>
  <select id="stat-select" name="stat" onchange="this.form.submit()">
    {% for s in stats_config if not s.get('hidden') %}
      <option value="{{ s.key }}" {% if s.key==selected.key %}selected{% endif %}>
        {{ s.label }}
      </option>
    {% endfor %}
  </select>
  <input type="hidden" name="season_id" value="{{ selected_season }}">
  <input type="hidden" name="start_date" value="{{ start_date }}">
  <input type="hidden" name="end_date" value="{{ end_date }}">
  {% for lbl in selected_labels %}
    <input type="hidden" name="label" value="{{ lbl }}">
  {% endfor %}
</form>

{% if selected.key == 'defense' %}
  <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white">
    {% set bump_last_ns = namespace(rows={}) %}
    {% for entry in bump_last_rows or [] %}
      {% set name = entry.get('player_name') or entry.get('player') or entry.get('name') %}
      {% if name %}
        {% set _ = bump_last_ns.rows.update({name: entry}) %}
      {% endif %}
    {% endfor %}
    <table class="table-leaderboard min-w-full">
      {{ render_grouped_last_practice_header(["Bump +", "Bump Opps", "Bump %"], "Collisions", "Last Practice") }}
      <tbody>
        {% for row in bump_rows or [] %}
          {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
          {% set plus = row.get('plus', 0) %}
          {% set opps = row.get('opps', 0) %}
          {% set pct = row.get('pct') %}
          {% set last = bump_last_ns.rows.get(name) %}
          {% set last_plus = last.get('plus', 0) if last else 0 %}
          {% set last_opps = last.get('opps', 0) if last else 0 %}
          {% set last_pct = last.get('pct') if last else None %}
          {% if pct is not none %}
            {% set pct_display = pct|round(1) ~ '%' %}
          {% elif opps %}
            {% set pct_display = (plus / opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set pct_display = 'NA' %}
          {% endif %}
          {% if last_pct is not none %}
            {% set last_pct_display = last_pct|round(1) ~ '%' %}
          {% elif last_opps %}
            {% set last_pct_display = (last_plus / last_opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set last_pct_display = 'NA' %}
          {% endif %}
          <tr>
            <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
            <td class="td-player px-4 py-2 text-left">{{ name }}</td>
            {{ td_stat(plus) }}
            {{ td_stat(opps) }}
            {{ td_stat(pct_display) }}
            {{ td_stat(last_plus) }}
            {{ td_stat(last_opps) }}
            {{ td_stat(last_pct_display) }}
          </tr>
        {% endfor %}
        {% if bump_totals or bump_last_totals %}
          {% set season_plus = (bump_totals or {}).get('plus', 0) %}
          {% set season_opps = (bump_totals or {}).get('opps', 0) %}
          {% set season_pct = (bump_totals or {}).get('pct') %}
          {% set lp_plus = (bump_last_totals or {}).get('plus', 0) %}
          {% set lp_opps = (bump_last_totals or {}).get('opps', 0) %}
          {% set lp_pct = (bump_last_totals or {}).get('pct') %}
          {% if season_pct is not none %}
            {% set season_pct_display = season_pct|round(1) ~ '%' %}
          {% elif season_opps %}
            {% set season_pct_display = (season_plus / season_opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set season_pct_display = 'NA' %}
          {% endif %}
          {% if lp_pct is not none %}
            {% set lp_pct_display = lp_pct|round(1) ~ '%' %}
          {% elif lp_opps %}
            {% set lp_pct_display = (lp_plus / lp_opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set lp_pct_display = 'NA' %}
          {% endif %}
          <tr class="font-bold bg-gray-100 team-totals">
            <td class="td-num px-4 py-2 text-center"></td>
            <td class="td-player px-4 py-2 text-left">Team Totals</td>
            {{ td_stat(season_plus) }}
            {{ td_stat(season_opps) }}
            {{ td_stat(season_pct_display) }}
            {{ td_stat(lp_plus) }}
            {{ td_stat(lp_opps) }}
            {{ td_stat(lp_pct_display) }}
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
{% elif selected.key == 'off_rebounding' %}
    <div class="space-y-8">
      <div class="grid grid-cols-1 gap-8">
        <div class="flex flex-col h-full">
          <h3 class="text-lg font-semibold mb-2">Offensive Crash</h3>
          {% set crash_last_ns = namespace(rows={}) %}
          {% for entry in crash_last_rows or [] %}
            {% set name = entry.get('player_name') or entry.get('player') or entry.get('name') %}
            {% if name %}
              {% set _ = crash_last_ns.rows.update({name: entry}) %}
            {% endif %}
          {% endfor %}
        <div class="flex-1 min-h-0">
          <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white h-full">
            <table class="table-leaderboard min-w-full">
              {{ render_grouped_last_practice_header(["Crash +", "Crash Att", "Crash %"], "Totals", "Last Practice") }}
              <tbody>
                {% for row in crash_rows or [] %}
                  {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                  {% set plus = row.get('plus', 0) %}
                  {% set opps = row.get('opps', 0) %}
                  {% set pct = row.get('pct') %}
                  {% set last = crash_last_ns.rows.get(name) %}
                  {% set last_plus = last.get('plus', 0) if last else 0 %}
                  {% set last_opps = last.get('opps', 0) if last else 0 %}
                  {% set last_pct = last.get('pct') if last else None %}
                  {% if pct is not none %}
                    {% set pct_display = pct|round(1) ~ '%' %}
                  {% elif opps %}
                    {% set pct_display = (plus / opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set pct_display = 'NA' %}
                  {% endif %}
                  {% if last_pct is not none %}
                    {% set last_pct_display = last_pct|round(1) ~ '%' %}
                  {% elif last_opps %}
                    {% set last_pct_display = (last_plus / last_opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set last_pct_display = 'NA' %}
                  {% endif %}
                  <tr>
                    <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="td-player px-4 py-2 text-left">{{ name }}</td>
                    {{ td_stat(plus) }}
                    {{ td_stat(opps) }}
                    {{ td_stat(pct_display) }}
                    {{ td_stat(last_plus) }}
                    {{ td_stat(last_opps) }}
                    {{ td_stat(last_pct_display) }}
                  </tr>
                {% endfor %}
                {% if crash_totals or crash_last_totals %}
                  {% set t_plus = (crash_totals or {}).get('plus', 0) %}
                  {% set t_opps = (crash_totals or {}).get('opps', 0) %}
                  {% set t_pct = (crash_totals or {}).get('pct') %}
                  {% set lt_plus = (crash_last_totals or {}).get('plus', 0) %}
                  {% set lt_opps = (crash_last_totals or {}).get('opps', 0) %}
                  {% set lt_pct = (crash_last_totals or {}).get('pct') %}
                  {% if t_pct is not none %}
                    {% set t_pct_display = t_pct|round(1) ~ '%' %}
                  {% elif t_opps %}
                    {% set t_pct_display = (t_plus / t_opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set t_pct_display = 'NA' %}
                  {% endif %}
                  {% if lt_pct is not none %}
                    {% set lt_pct_display = lt_pct|round(1) ~ '%' %}
                  {% elif lt_opps %}
                    {% set lt_pct_display = (lt_plus / lt_opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set lt_pct_display = 'NA' %}
                  {% endif %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="td-num px-4 py-2 text-center"></td>
                    <td class="td-player px-4 py-2 text-left">Team Totals</td>
                    {{ td_stat(t_plus) }}
                    {{ td_stat(t_opps) }}
                    {{ td_stat(t_pct_display) }}
                    {{ td_stat(lt_plus) }}
                    {{ td_stat(lt_opps) }}
                    {{ td_stat(lt_pct_display) }}
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
        </div>
        <div class="flex flex-col h-full">
          <h3 class="text-lg font-semibold mb-2">Back Man</h3>
          {% set back_last_ns = namespace(rows={}) %}
          {% for entry in backman_last_rows or [] %}
            {% set name = entry.get('player_name') or entry.get('player') or entry.get('name') %}
            {% if name %}
              {% set _ = back_last_ns.rows.update({name: entry}) %}
            {% endif %}
          {% endfor %}
          <div class="flex-1 min-h-0">
            <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white h-full">
              <table class="table-leaderboard min-w-full">
                {{ render_grouped_last_practice_header(["Back Man +", "Back Man Att", "Back Man %"], "Totals", "Last Practice") }}
                <tbody>
                  {% for row in backman_rows or [] %}
                  {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                  {% set plus = row.get('plus', 0) %}
                  {% set opps = row.get('opps', 0) %}
                  {% set pct = row.get('pct') %}
                  {% set last = back_last_ns.rows.get(name) %}
                  {% set last_plus = last.get('plus', 0) if last else 0 %}
                  {% set last_opps = last.get('opps', 0) if last else 0 %}
                  {% set last_pct = last.get('pct') if last else None %}
                  {% if pct is not none %}
                    {% set pct_display = pct|round(1) ~ '%' %}
                  {% elif opps %}
                    {% set pct_display = (plus / opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set pct_display = 'NA' %}
                  {% endif %}
                  {% if last_pct is not none %}
                    {% set last_pct_display = last_pct|round(1) ~ '%' %}
                  {% elif last_opps %}
                    {% set last_pct_display = (last_plus / last_opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set last_pct_display = 'NA' %}
                  {% endif %}
                  <tr>
                    <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="td-player px-4 py-2 text-left">{{ name }}</td>
                    {{ td_stat(plus) }}
                    {{ td_stat(opps) }}
                    {{ td_stat(pct_display) }}
                    {{ td_stat(last_plus) }}
                    {{ td_stat(last_opps) }}
                    {{ td_stat(last_pct_display) }}
                  </tr>
                {% endfor %}
                {% if backman_totals or backman_last_totals %}
                  {% set t_plus = (backman_totals or {}).get('plus', 0) %}
                  {% set t_opps = (backman_totals or {}).get('opps', 0) %}
                  {% set t_pct = (backman_totals or {}).get('pct') %}
                  {% set lt_plus = (backman_last_totals or {}).get('plus', 0) %}
                  {% set lt_opps = (backman_last_totals or {}).get('opps', 0) %}
                  {% set lt_pct = (backman_last_totals or {}).get('pct') %}
                  {% if t_pct is not none %}
                    {% set t_pct_display = t_pct|round(1) ~ '%' %}
                  {% elif t_opps %}
                    {% set t_pct_display = (t_plus / t_opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set t_pct_display = 'NA' %}
                  {% endif %}
                  {% if lt_pct is not none %}
                    {% set lt_pct_display = lt_pct|round(1) ~ '%' %}
                  {% elif lt_opps %}
                    {% set lt_pct_display = (lt_plus / lt_opps * 100)|round(1) ~ '%' %}
                  {% else %}
                    {% set lt_pct_display = 'NA' %}
                  {% endif %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="td-num px-4 py-2 text-center"></td>
                    <td class="td-player px-4 py-2 text-left">Team Totals</td>
                    {{ td_stat(t_plus) }}
                    {{ td_stat(t_opps) }}
                    {{ td_stat(t_pct_display) }}
                    {{ td_stat(lt_plus) }}
                    {{ td_stat(lt_opps) }}
                    {{ td_stat(lt_pct_display) }}
                  </tr>
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
  {% elif selected.key == 'def_rebounding' %}
    {% set box_last_ns = namespace(rows={}) %}
    {% for entry in box_last_rows or [] %}
      {% set name = entry.get('player_name') or entry.get('player') or entry.get('name') %}
      {% if name %}
        {% set _ = box_last_ns.rows.update({name: entry}) %}
      {% endif %}
    {% endfor %}
    <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white">
      <table class="table-leaderboard min-w-full">
      {{ render_grouped_last_practice_header(
        ["Box Out +", "Box Out Opp", "Box Out %"],
        "Box Out",
        "Last Practice",
        [{'label': "Off Reb's<br>Given Up", 'rowspan': 2, 'classes': 'th-stat px-4 py-2 text-center sortable'}]
      ) }}
      <tbody>
        {% for row in box_rows or [] %}
          {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
          {% set plus = row.get('plus', 0) %}
          {% set opps = row.get('opps', 0) %}
          {% set pct = row.get('pct') %}
          {% set given_up = row.get('off_reb_given_up', 0) %}
          {% set last = box_last_ns.rows.get(name) %}
          {% set last_plus = last.get('plus', 0) if last else 0 %}
          {% set last_opps = last.get('opps', 0) if last else 0 %}
          {% set last_pct = last.get('pct') if last else None %}
          {% if pct is not none %}
            {% set pct_display = pct|round(1) ~ '%' %}
          {% elif opps %}
            {% set pct_display = (plus / opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set pct_display = 'NA' %}
          {% endif %}
          {% if last_pct is not none %}
            {% set last_pct_display = last_pct|round(1) ~ '%' %}
          {% elif last_opps %}
            {% set last_pct_display = (last_plus / last_opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set last_pct_display = 'NA' %}
          {% endif %}
          <tr>
            <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
            <td class="td-player px-4 py-2 text-left">{{ name }}</td>
            {{ td_stat(plus) }}
            {{ td_stat(opps) }}
            {{ td_stat(pct_display) }}
            {{ td_stat(last_plus) }}
            {{ td_stat(last_opps) }}
            {{ td_stat(last_pct_display) }}
            {{ td_stat(given_up) }}
          </tr>
        {% endfor %}
        {% if box_totals or box_last_totals %}
          {% set t_plus = (box_totals or {}).get('plus', 0) %}
          {% set t_opps = (box_totals or {}).get('opps', 0) %}
          {% set t_pct = (box_totals or {}).get('pct') %}
          {% set t_given = (box_totals or {}).get('off_reb_given_up', 0) %}
          {% set lt_plus = (box_last_totals or {}).get('plus', 0) %}
          {% set lt_opps = (box_last_totals or {}).get('opps', 0) %}
          {% set lt_pct = (box_last_totals or {}).get('pct') %}
          {% if t_pct is not none %}
            {% set t_pct_display = t_pct|round(1) ~ '%' %}
          {% elif t_opps %}
            {% set t_pct_display = (t_plus / t_opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set t_pct_display = 'NA' %}
          {% endif %}
          {% if lt_pct is not none %}
            {% set lt_pct_display = lt_pct|round(1) ~ '%' %}
          {% elif lt_opps %}
            {% set lt_pct_display = (lt_plus / lt_opps * 100)|round(1) ~ '%' %}
          {% else %}
            {% set lt_pct_display = 'NA' %}
          {% endif %}
          <tr class="bg-gray-100 font-semibold team-totals">
            <td class="td-num px-4 py-2 text-center"></td>
            <td class="td-player px-4 py-2 text-left">Team Totals</td>
            {{ td_stat(t_plus) }}
            {{ td_stat(t_opps) }}
            {{ td_stat(t_pct_display) }}
            {{ td_stat(lt_plus) }}
            {{ td_stat(lt_opps) }}
            {{ td_stat(lt_pct_display) }}
            {{ td_stat(t_given) }}
          </tr>
        {% endif %}
      </tbody>
      </table>
    </div>
  {% elif selected.key == 'collision_gap_help' %}
    <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white">
      <table class="table-leaderboard min-w-full">
        <thead class="bg-gray-100 border-b-4 border-[#9E1B32]">
          <tr>
            <th class="th-num px-4 py-2 text-center sortable" rowspan="2" data-col="0">#</th>
            <th class="th-player px-4 py-2 text-left sortable" rowspan="2" data-col="1">Player</th>
            <th class="th-group px-4 py-2" colspan="3">Gap Help</th>
          </tr>
          <tr>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="2">Gap +</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="3">Gap Opp</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="4">Gap %</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            {# row = (player, gap_plus, gap_opp, gap_pct) #}
          <tr>
            <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
            <td class="td-player px-4 py-2 text-left">{{ row[0] }}</td>
            {{ td_stat(row[1]) }}
            {{ td_stat(row[2]) }}
            <td class="px-4 py-2">
              {{ (row[3] is not none) and (row[3]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endfor %}
        {% if team_totals %}
          {# team_totals = (gap_plus, gap_opp, gap_pct) #}
          <tr class="bg-gray-100 font-semibold team-totals">
            <td class="td-num px-4 py-2 text-center"></td>
            <td class="td-player px-4 py-2 text-left">Team Totals</td>
            {{ td_stat(team_totals[0]) }}
            {{ td_stat(team_totals[1]) }}
            <td class="px-4 py-2">
              {{ (team_totals[2] is not none) and (team_totals[2]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  {% elif selected.key == 'pnr_gap_help' %}
    <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white">
      <table class="table-leaderboard min-w-full">
        <thead class="bg-gray-100 border-b-4 border-[#9E1B32]">
          <tr>
            <th class="th-num px-4 py-2 text-center sortable" rowspan="2" data-col="0">#</th>
            <th class="th-player px-4 py-2 text-left sortable" rowspan="2" data-col="1">Player</th>
            <th class="th-group px-4 py-2" colspan="3">PnR Gap Help</th>
            <th class="th-group px-4 py-2" colspan="3">Low Help</th>
          </tr>
          <tr>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="2">PnR Gap +</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="3">PnR Gap Opp</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="4">PnR Gap %</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="5">Low +</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="6">Low Opp</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="7">Low %</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            {# row = (player, gap_plus, gap_opp, gap_pct, low_plus, low_opp, low_pct) #}
          <tr>
            <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
            <td class="td-player px-4 py-2 text-left">{{ row[0] }}</td>
            {{ td_stat(row[1]) }}
            {{ td_stat(row[2]) }}
            <td class="px-4 py-2">
              {{ (row[3] is not none) and (row[3]|round(1)|string + '%') or 'NA' }}
            </td>
            {{ td_stat(row[4]) }}
            {{ td_stat(row[5]) }}
            <td class="px-4 py-2">
              {{ (row[6] is not none) and (row[6]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endfor %}
        {% if team_totals %}
          {# team_totals = (gap_plus, gap_opp, gap_pct, low_plus, low_opp, low_pct) #}
          <tr class="bg-gray-100 font-semibold team-totals">
            <td class="td-num px-4 py-2 text-center"></td>
            <td class="td-player px-4 py-2 text-left">Team Totals</td>
            {{ td_stat(team_totals[0]) }}
            {{ td_stat(team_totals[1]) }}
            <td class="px-4 py-2">
              {{ (team_totals[2] is not none) and (team_totals[2]|round(1)|string + '%') or 'NA' }}
            </td>
            {{ td_stat(team_totals[3]) }}
            {{ td_stat(team_totals[4]) }}
            <td class="px-4 py-2">
              {{ (team_totals[5] is not none) and (team_totals[5]|round(1)|string + '%') or 'NA' }}
            </td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>
  {% elif selected.key == 'pnr_grade' %}
    <div class="space-y-8">
      <div class="grid grid-cols-1 gap-8">
        <div class="flex flex-col h-full">
          <h3 class="text-lg font-semibold mb-2">Close Window</h3>
          <div class="flex-1 min-h-0">
            <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white h-full">
              <table class="table-leaderboard min-w-full">
                <thead class="bg-gray-100 border-b-4 border-[#9E1B32]">
                  <tr>
                    <th class="th-num px-4 py-2 text-center sortable" data-col="0">#</th>
                    <th class="th-player px-4 py-2 text-left sortable" data-col="1">Player</th>
                    <th class="th-stat px-4 py-2 text-center sortable" data-col="2">Close Window +</th>
                    <th class="th-stat px-4 py-2 text-center sortable" data-col="3">Close Window Att</th>
                    <th class="th-stat px-4 py-2 text-center sortable" data-col="4">Close Window %</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in close_rows or [] %}
                    {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                    {% set plus = row.get('plus', 0) %}
                    {% set opps = row.get('opps', 0) %}
                    {% set pct = row.get('pct') %}
                  <tr>
                    <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="td-player px-4 py-2 text-left">{{ name }}</td>
                    {{ td_stat(plus) }}
                    {{ td_stat(opps) }}
                    <td class="px-4 py-2">
                      {% if pct is not none %}
                        {{ pct|round(1) }}%
                      {% elif opps %}
                        {{ (plus / opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                {% if close_totals %}
                  {% set t_plus = close_totals.get('plus', 0) %}
                  {% set t_opps = close_totals.get('opps', 0) %}
                  {% set t_pct = close_totals.get('pct') %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="td-num px-4 py-2 text-center"></td>
                    <td class="td-player px-4 py-2 text-left">Team Totals</td>
                    {{ td_stat(t_plus) }}
                    {{ td_stat(t_opps) }}
                    <td class="px-4 py-2">
                      {% if t_pct is not none %}
                        {{ t_pct|round(1) }}%
                      {% elif t_opps %}
                        {{ (t_plus / t_opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="flex flex-col h-full">
          <h3 class="text-lg font-semibold mb-2">Shut Door</h3>
          <div class="flex-1 min-h-0">
            <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white h-full">
              <table class="table-leaderboard min-w-full">
                <thead class="bg-gray-100 border-b-4 border-[#9E1B32]">
                  <tr>
                    <th class="th-num px-4 py-2 text-center sortable" data-col="0">#</th>
                    <th class="th-player px-4 py-2 text-left sortable" data-col="1">Player</th>
                    <th class="th-stat px-4 py-2 text-center sortable" data-col="2">Shut Door +</th>
                    <th class="th-stat px-4 py-2 text-center sortable" data-col="3">Shut Door Att</th>
                    <th class="th-stat px-4 py-2 text-center sortable" data-col="4">Shut Door %</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in shut_rows or [] %}
                    {% set name = row.get('player_name') or row.get('player') or row.get('name') %}
                    {% set plus = row.get('plus', 0) %}
                    {% set opps = row.get('opps', 0) %}
                    {% set pct = row.get('pct') %}
                  <tr>
                    <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
                    <td class="td-player px-4 py-2 text-left">{{ name }}</td>
                    {{ td_stat(plus) }}
                    {{ td_stat(opps) }}
                    <td class="px-4 py-2">
                      {% if pct is not none %}
                        {{ pct|round(1) }}%
                      {% elif opps %}
                        {{ (plus / opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
                {% if shut_totals %}
                  {% set t_plus = shut_totals.get('plus', 0) %}
                  {% set t_opps = shut_totals.get('opps', 0) %}
                  {% set t_pct = shut_totals.get('pct') %}
                  <tr class="bg-gray-100 font-semibold team-totals">
                    <td class="td-num px-4 py-2 text-center"></td>
                    <td class="td-player px-4 py-2 text-left">Team Totals</td>
                    {{ td_stat(t_plus) }}
                    {{ td_stat(t_opps) }}
                    <td class="px-4 py-2">
                      {% if t_pct is not none %}
                        {{ t_pct|round(1) }}%
                      {% elif t_opps %}
                        {{ (t_plus / t_opps * 100)|round(1) }}%
                      {% else %}
                        NA
                      {% endif %}
                    </td>
                  </tr>
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    
  {% else %}
    <div class="table-wrap rounded-lg shadow border border-gray-200 bg-white">
      <table class="table-leaderboard min-w-full">
        <thead class="bg-gray-100 border-b-4 border-[#9E1B32]">
          <tr>
            <th class="th-num px-4 py-2 text-center sortable" data-col="0">#</th>
            <th class="th-player px-4 py-2 text-left sortable" data-col="1">Player</th>
          {% if selected.key == 'assist_summary' %}
            <th class="th-stat px-4 py-2 text-center sortable" data-col="2">Ast</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="3">Pot Ast</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="4">2nd Ast</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="5">TO</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="6">AST/TO</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="7">Adj AST/TO</th>
          {% elif selected.key == 'offense_summary' %}
            <th class="th-stat px-4 py-2 text-center sortable" data-col="2">Poss</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="3">PPP On</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="4">PPP Off</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="5">Ind TO Rate (Poss.)</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="6">TO % (Bamalytics)</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="7">% of TO's (NBA.com)</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="8">Team TO Rate</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="9">Ind Off Reb%</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="10">Off Reb Rate</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="11">Ind Fouls Drawn%</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="12">Fouls Rate</th>
          {% elif selected.key.endswith('_fg_pct') %}
            <th class="th-stat px-4 py-2 text-center sortable" data-col="2">FG</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="3">FG%</th>
            <th class="th-stat px-4 py-2 text-center sortable" data-col="4">Freq</th>
            {% if selected.key == 'fg3_fg_pct' %}
              <th class="th-stat px-4 py-2 text-center sortable" data-col="5">Shrink 3FG (Att)</th>
              <th class="th-stat px-4 py-2 text-center sortable" data-col="6">Shrink 3FG (%)</th>
              <th class="th-stat px-4 py-2 text-center sortable" data-col="7">Non-Shrink 3FG (Att)</th>
              <th class="th-stat px-4 py-2 text-center sortable" data-col="8">Non-Shrink 3FG (%)</th>
            {% endif %}
          {% else %}
            <th class="th-stat px-4 py-2 text-center sortable" data-col="2">{{ selected.label }}</th>
          {% endif %}
        </tr>
        </thead>
        <tbody>
        {% for row in rows %}
          <tr>
            <td class="td-num px-4 py-2 text-center">{{ loop.index }}</td>
            {% if selected.key == 'assist_summary' %}
              {% set player, ast, pot, sec, tos, ratio, adj = row %}
              <td class="td-player px-4 py-2 text-left">{{ player }}</td>
              {{ td_stat(ast) }}
              {{ td_stat(pot) }}
              {{ td_stat(sec) }}
              {{ td_stat(tos) }}
              {{ td_stat(ratio) }}
              {{ td_stat(adj) }}
            {% elif selected.key == 'offense_summary' %}
              {% set player, poss, ppp_on, ppp_off, ind_to, bama_to, team_to_pct, to_rate, ind_oreb, oreb_rate, ind_foul, foul_rate = row %}
              <td class="td-player px-4 py-2 text-left">{{ player }}</td>
              {{ td_stat(poss) }}
              {{ td_stat(ppp_on) }}
              {{ td_stat(ppp_off) }}
              {{ td_stat(ind_to) }}
              {{ td_stat(bama_to) }}
              {{ td_stat(team_to_pct) }}
              {{ td_stat(to_rate) }}
              {{ td_stat(ind_oreb) }}
              {{ td_stat(oreb_rate) }}
              {{ td_stat(ind_foul) }}
              {{ td_stat(foul_rate) }}
            {% elif selected.key.endswith('_fg_pct') %}
              {% if selected.key == 'fg3_fg_pct' %}
                {% set player, makes, attempts, pct, freq, shrink_att, shrink_pct, nonshrink_att, nonshrink_pct = row %}
                <td class="td-player px-4 py-2 text-left">{{ player }}</td>
                {{ td_stat(makes ~ '-' ~ attempts) }}
                <td class="px-4 py-2 text-center">{{ pct|round(1) }}%</td>
                <td class="px-4 py-2 text-center">{{ freq|round(1) }}%</td>
                <td class="px-4 py-2 text-center">{{ shrink_att }}</td>
                <td class="px-4 py-2 text-center">{{ shrink_pct|round(1) }}%</td>
                <td class="px-4 py-2 text-center">{{ nonshrink_att }}</td>
                <td class="px-4 py-2 text-center">{{ nonshrink_pct|round(1) }}%</td>
              {% else %}
                {% set player, makes, attempts, pct, freq = row %}
                <td class="td-player px-4 py-2 text-left">{{ player }}</td>
                {{ td_stat(makes ~ '-' ~ attempts) }}
                <td class="px-4 py-2">{{ pct|round(1) }}%</td>
                <td class="px-4 py-2">{{ freq|round(1) }}%</td>
              {% endif %}
            {% else %}
              {% set player, val = row %}
              <td class="td-player px-4 py-2 text-left">{{ player }}</td>
              <td class="px-4 py-2">
                {% if selected.format=='pct' %}
                  {{ val|round(1) }}%
                {% else %}
                  {{ val }}
                {% endif %}
              </td>
            {% endif %}
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
<script>
  (function () {
    const script = document.currentScript;
    const container = script && script.previousElementSibling;
    if (!container) {
      return;
    }

    const tables = container.querySelectorAll('table');

    tables.forEach(table => {
      const tbody = table.querySelector('tbody');
      if (!tbody) {
        return;
      }

      const headers = table.querySelectorAll('th.sortable');

      headers.forEach(header => {
        header.dataset.order = header.dataset.order || 'none';
        header.classList.add('cursor-pointer', 'select-none');

        let indicator = header.querySelector('.sort-indicator');
        if (!indicator) {
          indicator = document.createElement('span');
          indicator.className = 'ml-1 text-xs text-gray-400 sort-indicator';
          indicator.textContent = '▲▼';
          header.appendChild(indicator);
        } else {
          indicator.textContent = '▲▼';
          indicator.classList.remove('text-gray-600');
          indicator.classList.add('text-gray-400');
        }

        header.addEventListener('click', () => {
          const columnIndex = header.dataset.col ? parseInt(header.dataset.col, 10) : header.cellIndex;
          if (Number.isNaN(columnIndex)) {
            return;
          }

          const newOrder = header.dataset.order === 'asc' ? 'desc' : 'asc';
          const descending = newOrder === 'desc';
          const totalRow = tbody.querySelector('.team-totals');

          if (totalRow) {
            totalRow.remove();
          }

          const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.classList.contains('team-totals'));

          rows.sort((rowA, rowB) => compareRows(rowA, rowB, columnIndex, descending));

          const shouldUpdateRank = columnIndex !== 0;

          rows.forEach((row, index) => {
            if (shouldUpdateRank && row.children[0]) {
              row.children[0].textContent = index + 1;
            }
            tbody.appendChild(row);
          });

          if (totalRow) {
            tbody.appendChild(totalRow);
          }

          updateHeaderStates(headers, header, newOrder);
        });
      });
    });

    function compareRows(rowA, rowB, columnIndex, descending) {
      const cellA = rowA.children[columnIndex];
      const cellB = rowB.children[columnIndex];

      const valueA = extractValue(cellA ? cellA.textContent : '');
      const valueB = extractValue(cellB ? cellB.textContent : '');

      let comparison;
      if (valueA.type === 'number' && valueB.type === 'number') {
        comparison = valueA.value - valueB.value;
      } else if (valueA.type === 'number') {
        comparison = -1;
      } else if (valueB.type === 'number') {
        comparison = 1;
      } else {
        comparison = valueA.value.localeCompare(valueB.value, undefined, { sensitivity: 'base' });
      }

      if (comparison === 0) {
        return 0;
      }

      return descending ? -comparison : comparison;
    }

    function extractValue(text) {
      const trimmed = text.trim();
      if (!trimmed || trimmed.toUpperCase() === 'NA') {
        return { type: 'number', value: Number.NEGATIVE_INFINITY };
      }

      const numericText = trimmed.replace(/[^0-9.+-]+/g, '');
      const numericValue = numericText ? parseFloat(numericText) : NaN;

      if (!Number.isNaN(numericValue)) {
        return { type: 'number', value: numericValue };
      }

      return { type: 'string', value: trimmed.toLowerCase() };
    }

    function updateHeaderStates(headers, activeHeader, order) {
      headers.forEach(header => {
        const indicator = header.querySelector('.sort-indicator');
        if (!indicator) {
          return;
        }

        if (header === activeHeader) {
          header.dataset.order = order;
          header.setAttribute('aria-sort', order === 'asc' ? 'ascending' : 'descending');
          indicator.textContent = order === 'asc' ? '▲' : '▼';
          indicator.classList.remove('text-gray-400');
          indicator.classList.add('text-gray-600');
        } else {
          header.dataset.order = 'none';
          header.removeAttribute('aria-sort');
          indicator.textContent = '▲▼';
          indicator.classList.remove('text-gray-600');
          indicator.classList.add('text-gray-400');
        }
      });
    }
  })();
</script>
