{% extends 'base.html' %}
{% from 'macros/table.html' import render_table %}
{% block head_extra %}
<style>
  .pdf-action-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: #9E1B32;
    color: #ffffff;
    padding: 0.6rem 1.25rem;
    border-radius: 0.5rem;
    border: none;
    font-weight: 600;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  .pdf-action-button:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }
  .pdf-action-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  .pdf-loading {
    display: none;
    font-size: 0.875rem;
    color: #4b5563;
    margin-top: 0.5rem;
  }
  .pdf-loading.is-visible {
    display: block;
  }
  .pdf-icon {
    width: 1rem;
    height: 1rem;
  }
</style>
{% endblock %}

{% block content %}
<div id="print-area">
  <div class="max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 p-4 sm:p-6 md:p-8">
    <div class="flex flex-col items-center text-center space-y-4 md:flex-row md:items-start md:space-y-0 md:space-x-6">
      <h1 class="text-2xl font-bold">{{ player.player_name }}</h1>
      <div class="flex flex-col items-center md:items-start">
        <button
          id="playerPdfBtn"
          class="pdf-action-button"
          type="button"
          data-player-id="{{ player.id }}"
          data-player-name="{{ player.player_name }}"
        >
          <svg class="pdf-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zm0 2.5L18.5 9H14zM8 13h1.5a1.5 1.5 0 0 1 0 3H8zm1.5 2a.5.5 0 0 0 0-1H9v1zm4-2h1.25a1.75 1.75 0 0 1 0 3.5H13.5zm1.25 2.5a.75.75 0 0 0 0-1.5H14.5v1.5zM17 13h2v1h-1v1h1v1h-2z"/>
          </svg>
          Generate PDF Report
        </button>
        <span id="playerPdfLoading" class="pdf-loading" role="status">Generating report…</span>
      </div>
    </div>

  <h3 class="mt-6">On-Court Offensive Possessions &amp; Efficiency</h3>

  <div class="sm:hidden space-y-6">
    {% for category in shot_type_categories %}
      <div class="border rounded-lg p-4 bg-white">
        <h4 class="text-lg font-semibold mb-2">{{ category.name }}</h4>
        <table class="w-full text-sm">
          <tbody>
            <tr class="border-t border-gray-200">
              <th class="text-left py-2 px-3">Total</th>
              <td class="text-right py-2 px-3">
                {{ category.total.fga }} ● {{ category.total.fg_pct }} ● {{ category.total.pps }} ● {{ category.total.freq_pct }}
              </td>
            </tr>
            <tr class="border-t border-gray-200">
              <th class="text-left py-2 px-3">Transition</th>
              <td class="text-right py-2 px-3">
                {{ category.transition.fga }} ● {{ category.transition.fg_pct }} ● {{ category.transition.pps }} ● {{ category.transition.freq_pct }}
              </td>
            </tr>
            <tr class="border-t border-gray-200">
              <th class="text-left py-2 px-3">Half-Court</th>
              <td class="text-right py-2 px-3">
                {{ category.half_court.fga }} ● {{ category.half_court.fg_pct }} ● {{ category.half_court.pps }} ● {{ category.half_court.freq_pct }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    {% endfor %}
  </div>

  <div class="hidden sm:block">
    {% set summary_cols = [
      {'key': 'stat', 'label': 'Stat', 'sortable': True, 'align': 'left'},
      {'key': 'value', 'label': 'Value', 'sortable': True, 'align': 'right'}
    ] %}
    {{ render_table(
      id='player-summary',
      columns=summary_cols,
      rows=player_summary_rows,
      totals=None,
      dense=True,
      sticky_header=False,
      caption='Player Summary'
    ) }}
  </div>

  {# Include shot type tables with sticky headers #}
    {% include "partials/shot_type_tables.html" with context %}

  <section class="mt-8 bg-white rounded-lg p-4 shadow">
    <h3 class="text-lg font-semibold mb-4">Shot Chart</h3>
    <div
      class="shot-chart-wrapper"
      data-shot-chart
      data-player-id="{{ player.id }}"
      data-season-id="{{ player.season_id }}"
      data-shot-chart-endpoint="{{ url_for('api_public_player_shot_chart', player_id=player.id) }}"
    >
      <div class="flex flex-wrap gap-4 mb-4">
        <label class="text-sm font-medium text-gray-700">
          Shot Class
          <select class="ml-2 border rounded px-2 py-1" data-shot-class></select>
        </label>
        <label class="text-sm font-medium text-gray-700">
          Possession Type
          <select class="ml-2 border rounded px-2 py-1" data-possession-type></select>
        </label>
      </div>
      <div class="text-sm text-gray-600 mb-2" data-shot-chart-summary>Attempts: 0 · Makes: 0 · FG%: 0.0%</div>
      <div class="text-sm text-gray-500 mb-2 hidden" data-shot-chart-status></div>
      <div class="flex justify-center" data-shot-chart-graphic></div>
    </div>
  </section>
  </div>
</div>

<script type="module" src="{{ url_for('static', filename='js/shot_chart.js') }}"></script>
<script>
function showTab(tabName) {
  ['seasonTotals','gameStats','shotType','skillDevelopment'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('hidden', id !== tabName);
    el.classList.toggle('block',  id === tabName);
  });
  ['btnSeasonTotals','btnGameStats','btnShotType','btnSkillDevelopment'].forEach(btnId => {
    const b = document.getElementById(btnId);
    if (!b) return;
    if (btnId.toLowerCase().endsWith(tabName.toLowerCase())) {
      b.classList.add('bg-[#9E1B32]', 'text-white');
      b.classList.remove('border-gray-300','bg-white','text-gray-700');
    } else {
      b.classList.remove('bg-[#9E1B32]', 'text-white');
      b.classList.add('border-gray-300','bg-white','text-gray-700');
    }
  });
  window.location.hash = tabName;
  if (tabName === 'shotType') {
    showShotTypeDetail('atr');
  }
}

function showShotTypeDetail(detail) {
  ['atr','fg2','fg3'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.toggle('hidden', id !== detail);
      el.classList.toggle('block',  id === detail);
    }
  });
  const map = { atr:'ATR', fg2:'FG2', fg3:'FG3' };
  Object.entries(map).forEach(([type,suf]) => {
    const card = document.getElementById('card' + suf);
    if (!card) return;
    if (type === detail) {
      card.classList.add('ring-2','ring-offset-2','ring-[#9E1B32]','border-[#9E1B32]','shadow-lg');
      card.classList.remove('border-transparent','shadow-md');
    } else {
      card.classList.remove('ring-2','ring-offset-2','ring-[#9E1B32]','border-[#9E1B32]','shadow-lg');
      card.classList.add('border-transparent','shadow-md');
    }
  });
}

document.addEventListener('DOMContentLoaded', () => {
  showTab('shotType');
});

document.addEventListener('DOMContentLoaded', () => {
  const pdfBtn = document.getElementById('playerPdfBtn');
  const loading = document.getElementById('playerPdfLoading');
  if (!pdfBtn) return;

  pdfBtn.addEventListener('click', async () => {
    const playerId = pdfBtn.dataset.playerId;
    const playerName = pdfBtn.dataset.playerName || 'player_report';
    if (!playerId) {
      alert('Unable to generate the PDF because the player ID is missing.');
      return;
    }
    pdfBtn.disabled = true;
    loading?.classList.add('is-visible');

    try {
      const response = await fetch(`/pdf/player/${playerId}/generate`, { method: 'GET' });
      if (!response.ok) {
        throw new Error(`Request failed with status ${response.status}`);
      }
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${playerName.replace(/\s+/g, '_')}_report.pdf`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error(error);
      alert('Sorry, there was a problem generating the PDF. Please try again.');
    } finally {
      pdfBtn.disabled = false;
      loading?.classList.remove('is-visible');
    }
  });
});
</script>

{% endblock %}
