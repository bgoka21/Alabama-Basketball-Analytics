{% extends 'admin/base.html' %}
{% from 'macros/table.html' import render_table %}

{% block page_controls %}
<form method="get" class="mb-4 flex items-center gap-2">
  <label class="font-semibold">Start:</label>
  <input type="date" name="start_date" value="{{ start }}" class="border p-1 rounded" />
  <label class="font-semibold">End:</label>
  <input type="date" name="end_date" value="{{ end }}" class="border p-1 rounded" />
  <button type="submit" class="px-3 py-1 bg-[#9E1B32] text-white rounded">Filter</button>
</form>
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Usage Report</h1>

{% set user_columns = [
  {'key': 'user', 'label': 'User', 'sortable': True, 'align': 'left'},
  {'key': 'views', 'label': 'Views', 'sortable': True, 'align': 'right', 'value_key': 'views_raw'}
] %}

{% set user_rows = namespace(items=[]) %}
{% for uid, username, count in user_stats %}
  {% if uid %}
    {% set user_cell %}
      <a href="{{ url_for('admin.user_usage_report', user_id=uid) }}" class="text-blue-600 hover:underline">{{ username }}</a>
    {% endset %}
  {% else %}
    {% set user_cell %}Anonymous{% endset %}
  {% endif %}
  {% set user_rows.items = user_rows.items + [{
    'user': user_cell | safe,
    'views': count,
    'views_raw': count
  }] %}
{% endfor %}

<h2 class="text-xl font-semibold mt-4 mb-2">Views by User</h2>
{{ render_table(
  id='usage-by-user',
  columns=user_columns,
  rows=user_rows.items,
  totals=None,
  dense=True,
  sticky_header=True,
  caption='Usage views by user'
) }}

{% if user_rows.items | length == 0 %}
  <div class="table-empty text-center text-sm text-gray-600 dark:text-gray-300 mt-3">No usage recorded for users.</div>
{% endif %}

{% set page_columns = [
  {'key': 'endpoint', 'label': 'Endpoint', 'sortable': True, 'align': 'left'},
  {'key': 'views', 'label': 'Views', 'sortable': True, 'align': 'right', 'value_key': 'views_raw'}
] %}

{% set page_rows = namespace(items=[]) %}
{% for ep, count in page_stats %}
  {% set page_rows.items = page_rows.items + [{
    'endpoint': ep,
    'views': count,
    'views_raw': count
  }] %}
{% endfor %}

<h2 class="text-xl font-semibold mt-4 mb-2">Views by Page</h2>
{{ render_table(
  id='usage-by-page',
  columns=page_columns,
  rows=page_rows.items,
  totals=None,
  dense=True,
  sticky_header=True,
  caption='Usage views by page'
) }}

{% if page_rows.items | length == 0 %}
  <div class="table-empty text-center text-sm text-gray-600 dark:text-gray-300 mt-3">No page views recorded.</div>
{% endif %}
{% endblock %}
